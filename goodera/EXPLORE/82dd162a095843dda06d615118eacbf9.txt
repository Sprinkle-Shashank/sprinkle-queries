
with tab1 as(
  Select cast((split_part(split_part(prod.name,'|',1),'.',1)) as varchar) as prj_code,split_to_array(listagg(distinct split_part(prod.name,'|',2),','),',') as c,get_array_length(c) as village_count
from profile_54963 r
left join project_4188 prod
on r.projectid=prod.id
group by 1
  
  ),
  t2 as(
	Select  _id,fy, name, curr_yr_budget, State, ngo_partner, Project_Manager, name_project,focus_area
	from profile_27396 sq, sq.state State
 ),
 t3 as (
Select f.name as fy, sq.name project_code, sq.curr_yr_budget, m1.name state, l.name as implementing_agency, m.name  as Project_Manager,p.village_count, m.name as level1, m.name as level2, sq.name_project project_name,sq.focus_area
from t2 sq 
left join tab1 p
on p.prj_code=sq.name
left join tagelement_4188 f on
sq.fy=f.id 
left join profile_27395 l on
l._id=sq.ngo_partner
left join tagelement_4188 m on
sq.project_manager=m.id
left join tagelement_4188 m1 on
 sq.State=m1.id

 
union all

(With main as(Select f.name as fy, sq.name project_code, sq.curr_yr_budget, sq.state state1, sq.name_project as implementing_agency, m.name  as Project_Manager, p2.village_count,m.name as level1,m.name as level2, sq.name_project project_name,sq.focus_area
from profile_27396 sq
left join profile_27420 p
on sq._id=p.project_code
left join tab1 p2
on p2.prj_code=sq.name
left join tagelement_4188 f on
sq.fy=f.id 
left join tagelement_4188 m on
sq.project_manager=m.id),

tab2 as(Select m.*,st
From main as m,m.state1 as st),

tab3 as(Select *,m1.name as state
From tab2
left join tagelement_4188 m1 on
 tab2.st=m1.id)
Select fy,project_code,curr_yr_budget,state,implementing_agency,Project_Manager,village_count,level1, level2,project_name,focus_area
from tab3)
 )
Select * from tab1
/*	
Select distinct(project_code),fy, curr_yr_budget,state, implementing_agency, Project_Manager, level1, level2, village_count,project_name,t.name as focus_area
from t3
left join tagelement_4188 t
on t.id=focus_area
where t.name='Holistic Rural Development'

--sakshi_API1
--select * from ds_mysql_prod_grantproposal --where proposalinstanceid = '5d42c4025570e08c058b5410'
with temp as(
  select 'Partner | Due Dilligence' as col 
  UNION ALL
  select 'Partner | Background Information' as col 
  UNION ALL
  select 'Partner | Proposal' as col 
  UNION ALL
  select 'Approval by CSR team' as col 
  UNION ALL
  select 'Due Diligence Task' as col 
  UNION ALL
  select 'Post Due Diligence Approval by CSR Team' as col 
  UNION ALL
  select 'Approval by Vertical Head' as col 
  UNION ALL
  select 'Approval by Compliance Team' as col 
  UNION ALL
  select 'Approval by Legal Team' as col 
  UNION ALL
  select 'Approval by Finance Team' as col 
  UNION ALL
  select 'Approval by CSR functional head' as col 
  UNION ALL
  select 'Approval by Board' as col 
  UNION ALL
  select 'Proposal Approval Document' as col 
 ),
 
 temp2 as
(select 'Pending' as col
 UNION ALL
 select 'Completed' as col
 UNION ALL
 select 'Rejected' as col),
 
table1 as (
  select p.id as grantApplicationId,partner.id as grantPartnerId1, 
  proposal.id as grantProposalId1, proposallog.*,p.active as isactive, partner.active as activepartner, proposal.active as activeproposal, proposallog.active as activeproposallog
  
  from ds_mysql_prod_grantapplication p 
			   
left join ds_mysql_prod_grantpartner partner on
partner.grantapplicationid = p.id	
			
left join ds_mysql_prod_grantproposal proposal on
proposal.grantpartnerid = partner.id

left join ds_mongo_grantproposallog proposallog on
cast(proposallog.grantproposalid as int) = proposal.id
  
  
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17		   
),
t2 as(
select * ,
  case
  when is_array(table1.completedgrantflowtask) = false or get_array_length(table1.completedgrantflowtask) = 0 then 
  	   array(table1.completedgrantflowtask)
  else table1.completedgrantflowtask
end as completedgrantflowtaskk
  from table1 where grantApplicationId = 1792 and isactive = 1 and activepartner = 1 and activeproposal = 1 and activeproposallog = 't' --and _id = '600eade8e37d56760546e4d6' 
),
t3 as (
Select tt.*,cgf from t2 as tt,tt.completedgrantflowtaskk cgf
)
,
t4 as(
Select t3.*,cast(t3.todo."action" as varchar) as action,
  
case
	when cgf."status" = 'COMPLETED' and cgf."taskId" = 28730 then grantproposalid
	end as comp28730,
case
	when action = 'PENDING' and t3.todo."taskId" = 28730 then grantproposalid
	end as pend28730,
case
	when action = 'REJECTED' and todo."taskId" = 28730 then grantproposalid
	end as rej28730,
  
case
	when cgf."status" = 'COMPLETED' and cgf."taskId"= 47474 then grantproposalid
	end as comp47474,
case
	when action = 'PENDING' and t3.todo."taskId"= 47474 then grantproposalid
	end as pend47474,
case
	when action = 'REJECTED' and todo."taskId"= 47474 then grantproposalid
	end as rej47474,

case
	when cgf."status" = 'COMPLETED' and cgf."taskId" = 47477 then grantproposalid
	end as comp47477,
case
	when action = 'PENDING' and t3.todo."taskId" = 47477 then grantproposalid
	end as pend47477,
case
	when action = 'REJECTED' and todo."taskId" = 47477 then grantproposalid
	end as rej47477, 
  
case
	when cgf."status" = 'COMPLETED' and cgf."taskId" = 28720 then grantproposalid
	end as comp28720,
case
	when action = 'PENDING' and t3.todo."taskId" = 28720 then grantproposalid
	end as pend28720,
case
	when action = 'REJECTED' and todo."taskId" = 28720 then grantproposalid
	end as rej28720,
  
case
	when cgf."status" = 'COMPLETED' and cgf."taskId" = 82013 then grantproposalid
	end as comp82013,
case
	when action = 'PENDING' and t3.todo."taskId" = 82013 then grantproposalid
	end as pend82013,
case
	when action = 'REJECTED' and todo."taskId" = 82013 then grantproposalid
	end as rej82013,
  
case
	when cgf."status" = 'COMPLETED' and cgf."taskId" = 82014 then grantproposalid
	end as comp82014,
case
	when action = 'PENDING' and t3.todo."taskId" = 82014 then grantproposalid
	end as pend82014,
case
	when action = 'REJECTED' and todo."taskId" = 82014 then grantproposalid
	end as rej82014,
  
case
	when cgf."status" = 'COMPLETED' and cgf."taskId" = 28723 then grantproposalid
	end as comp28723,
case
	when action = 'PENDING' and t3.todo."taskId" = 28723 then grantproposalid
	end as pend28723,
case
	when action = 'REJECTED' and todo."taskId" = 28723 then grantproposalid
	end as rej28723,
case	when action is null and and t3.todo."taskId" = 28726 then 
	case
	when cgf."status" = 'COMPLETED' and cgf."taskId" = 28726 then grantproposalid
end
	end as comp28726,
case
	when action = 'PENDING' and t3.todo."taskId" = 28726 then grantproposalid
	end as pend28726,
case
	when action = 'REJECTED' and todo."taskId" = 28726 then grantproposalid
	end as rej28726,
  
case
	when cgf."status" = 'COMPLETED' and cgf."taskId" = 28724 then grantproposalid
	end as comp28724,
case
	when action = 'PENDING' and t3.todo."taskId" = 28724 then grantproposalid
	end as pend28724,
case
	when action = 'REJECTED' and todo."taskId" = 28724 then grantproposalid
	end as rej28724,

case
	when cgf."status" = 'COMPLETED' and cgf."taskId" = 28718 then grantproposalid
	end as comp28718,
case
	when action = 'PENDING' and t3.todo."taskId" = 28718 then grantproposalid
	end as pend28718,
case
	when action = 'REJECTED' and todo."taskId" = 28718 then grantproposalid
	end as rej28718,

case
	when cgf."status" = 'COMPLETED' and cgf."taskId" = 28721 then grantproposalid
	end as comp28721,
case
	when action = 'PENDING' and t3.todo."taskId" = 28721 then grantproposalid
	end as pend28721,
case
	when action = 'REJECTED' and todo."taskId" = 28721 then grantproposalid
	end as rej28721,
  
case
	when cgf."status" = 'COMPLETED' and cgf."taskId" = 47487 then grantproposalid
	end as comp47487,
case
	when action = 'PENDING' and t3.todo."taskId" = 47487 then grantproposalid
	end as pend47487,
case
	when action = 'REJECTED' and todo."taskId" = 47487 then grantproposalid
	end as rej47487,

case
	when cgf."status" = 'COMPLETED' and cgf."taskId" = 28722 then grantproposalid
	end as comp28722,
case
	when action = 'PENDING' and t3.todo."taskId" = 28722 then grantproposalid
	end as pend28722,
case
	when action = 'REJECTED' and todo."taskId" = 28722 then grantproposalid
	end as rej28722


object(
'In Progress', 
ARRAY(JSON_PARSE(case
	when action = 'PENDING' and t3.todo."taskId" = 47474 then grantproposalid
	end)),
'Completed', LISTAGG(comp,','),
'Rejected', JSON_PARSE(case
	when action = 'REJECTED' and todo."taskId" = 47474 then grantproposalid
	end)) as Approval_by_CSR_team*/
  
from t3
group by 

grantapplicationid	,grantpartnerid1, grantproposalid1,	_id,	grantproposalid	,grantflowtaskid,	active,	completedgrantflowtask,	todo,	created,	creatorid,	modified,	modifierid,	grantpartnerid,	isactive,	activepartner,	activeproposal,	activeproposallog,	cgf, completedgrantflowtaskk),

t5 as
(Select grantapplicationid, grantpartnerid,grantproposalid, concat(concat(substring(cast(timestamp 'epoch' + CAST(created AS BIGINT)/1000 * interval '1 second' as varchar), 1, 10),'T'), concat(split_part(cast(timestamp 'epoch' + CAST(created AS BIGINT)/1000 * interval '1 second' as varchar), ' ',2),'.000Z')) as startdate ,

SPLIT_TO_ARRAY(listagg(distinct comp28730,', ')) as comp_28730, get_array_length(comp_28730) as final_comp_28730, SPLIT_TO_ARRAY(listagg(distinct pend28730,', ')) as pend_28730, get_array_length(pend_28730) as final_pend_28730, SPLIT_TO_ARRAY(listagg(distinct rej28730,', ')) as rej_28730, get_array_length(rej_28730) as final_rej_28730,

SPLIT_TO_ARRAY(listagg(distinct comp47474,', ')) as comp_47474, get_array_length(comp_47474) as final_comp_47474, SPLIT_TO_ARRAY(listagg(distinct pend47474,', ')) as pend_47474, get_array_length(pend_47474) as final_pend_47474, SPLIT_TO_ARRAY(listagg(distinct rej47474,', ')) as rej_47474, get_array_length(rej_47474) as final_rej_47474,

SPLIT_TO_ARRAY(listagg(distinct comp47477,', ')) as comp_47477, get_array_length(comp_47477) as final_comp_47477, SPLIT_TO_ARRAY(listagg(distinct pend47477,', ')) as pend_47477, get_array_length(pend_47477) as final_pend_47477, SPLIT_TO_ARRAY(listagg(distinct rej47477,', ')) as rej_47477, get_array_length(rej_47477) as final_rej_47477,

SPLIT_TO_ARRAY(listagg(distinct comp28720,', ')) as comp_28720, get_array_length(comp_28720) as final_comp_28720, SPLIT_TO_ARRAY(listagg(distinct pend28720,', ')) as pend_28720, get_array_length(pend_28720) as final_pend_28720, SPLIT_TO_ARRAY(listagg(distinct rej28720,', ')) as rej_28720, get_array_length(rej_28720) as final_rej_28720,

SPLIT_TO_ARRAY(listagg(distinct comp82013,', ')) as comp_82013, get_array_length(comp_82013) as final_comp_82013, SPLIT_TO_ARRAY(listagg(distinct pend82013,', ')) as pend_82013, get_array_length(pend_82013) as final_pend_82013, SPLIT_TO_ARRAY(listagg(distinct rej82013,', ')) as rej_82013, get_array_length(rej_82013) as final_rej_82013,

SPLIT_TO_ARRAY(listagg(distinct comp82014,', ')) as comp_82014, get_array_length(comp_82014) as final_comp_82014, SPLIT_TO_ARRAY(listagg(distinct pend82014,', ')) as pend_82014, get_array_length(pend_82014) as final_pend_82014, SPLIT_TO_ARRAY(listagg(distinct rej82014,', ')) as rej_82014, get_array_length(rej_82014) as final_rej_82014,

SPLIT_TO_ARRAY(listagg(distinct comp28723,', ')) as comp_28723, get_array_length(comp_28723) as final_comp_28723, SPLIT_TO_ARRAY(listagg(distinct pend28723,', ')) as pend_28723, get_array_length(pend_28723) as final_pend_28723, SPLIT_TO_ARRAY(listagg(distinct rej28723,', ')) as rej_28723, get_array_length(rej_28723) as final_rej_28723,

SPLIT_TO_ARRAY(listagg(distinct comp28726,', ')) as comp_28726, get_array_length(comp_28726) as final_comp_28726, SPLIT_TO_ARRAY(listagg(distinct pend28726,', ')) as pend_28726, get_array_length(pend_28726) as final_pend_28726, SPLIT_TO_ARRAY(listagg(distinct rej28726,', ')) as rej_28726, get_array_length(rej_28726) as final_rej_28726,

SPLIT_TO_ARRAY(listagg(distinct comp28724,', ')) as comp_28724, get_array_length(comp_28724) as final_comp_28724, SPLIT_TO_ARRAY(listagg(distinct pend28724,', ')) as pend_28724, get_array_length(pend_28724) as final_pend_28724, SPLIT_TO_ARRAY(listagg(distinct rej28724,', ')) as rej_28724, get_array_length(rej_28724) as final_rej_28724,

SPLIT_TO_ARRAY(listagg(distinct comp28718,', ')) as comp_28718, get_array_length(comp_28718) as final_comp_28718, SPLIT_TO_ARRAY(listagg(distinct pend28718,', ')) as pend_28718, get_array_length(pend_28718) as final_pend_28718, SPLIT_TO_ARRAY(listagg(distinct rej28718,', ')) as rej_28718, get_array_length(rej_28718) as final_rej_28718,

SPLIT_TO_ARRAY(listagg(distinct comp28721,', ')) as comp_28721, get_array_length(comp_28721) as final_comp_28721, SPLIT_TO_ARRAY(listagg(distinct pend28721,', ')) as pend_28721, get_array_length(pend_28721) as final_pend_28721, SPLIT_TO_ARRAY(listagg(distinct rej28721,', ')) as rej_28721, get_array_length(rej_28721) as final_rej_28721,

SPLIT_TO_ARRAY(listagg(distinct comp47487,', ')) as comp_47487, get_array_length(comp_47487) as final_comp_47487, SPLIT_TO_ARRAY(listagg(distinct pend47487,', ')) as pend_47487, get_array_length(pend_47487) as final_pend_47487, SPLIT_TO_ARRAY(listagg(distinct rej47487,', ')) as rej_47487, get_array_length(rej_47487) as final_rej_47487,

SPLIT_TO_ARRAY(listagg(distinct comp28722,', ')) as comp_28722, get_array_length(comp_28722) as final_comp_28722, SPLIT_TO_ARRAY(listagg(distinct pend28722,', ')) as pend_28722, get_array_length(pend_28722) as final_pend_28722, SPLIT_TO_ARRAY(listagg(distinct rej28722,', ')) as rej_28722, get_array_length(rej_28722) as final_rej_28722

from t4
group by 1,2, 3,4),
t6 as
(select grantapplicationid, grantpartnerid, startdate, temp.col as task,
case 
when temp.col = 'Partner | Due Dilligence' then 1
	when temp.col = 'Partner | Background Information' then 2
	when temp.col = 'Partner | Proposal' then 3
	when temp.col = 'Approval by CSR team' then 4
	when temp.col = 'Due Diligence Task' then 5
	when temp.col = 'Post Due Diligence Approval by CSR Team' then 6
	when temp.col = 'Approval by Vertical Head' then 7
	when temp.col = 'Approval by reliance Team' then 8
	when temp.col = 'Approval by Legal Team' then 9
	when temp.col = 'Approval by Finance Team' then 10
	when temp.col = 'Approval by CSR functional head' then 11
	when temp.col = 'Approval by Board' then 12
	when temp.col = 'Proposal Approval Document' then 13
else 0
end as sort_order,


case col 
	when 'Partner | Due Dilligence' then final_pend_28730
	when 'Partner | Background Information' then final_pend_47474
	when 'Partner | Proposal' then final_pend_47477
  	when 'Approval by CSR team' then final_pend_28720
	when 'Due Diligence Task' then final_pend_82013
	when 'Post Due Diligence Approval by CSR Team' then final_pend_82014
	when 'Approval by Vertical Head' then final_pend_28723
	when 'Approval by Compliance Team' then final_pend_28726
	when 'Approval by Legal Team' then final_pend_28724
	when 'Approval by Finance Team' then final_pend_28718
	when 'Approval by CSR functional head' then final_pend_28721
	when 'Approval by Board' then final_pend_47487
	when 'Proposal Approval Document' then final_pend_28722
else 0 
end as pending,

case col
	when 'Partner | Due Dilligence' then final_comp_28730
	when 'Partner | Background Information' then final_comp_47474
	when 'Partner | Proposal' then final_comp_47477
	when 'Approval by CSR team' then final_comp_28720
	when 'Due Diligence Task' then final_comp_82013
	when 'Post Due Diligence Approval by CSR Team' then final_comp_82014
	when 'Approval by Vertical Head' then final_comp_28723
	when 'Approval by Compliance Team' then final_comp_28726
	when 'Approval by Legal Team' then final_comp_28724
	when 'Approval by Finance Team' then final_comp_28718
	when 'Approval by CSR functional head' then final_comp_28721
	when 'Approval by Board' then final_comp_47487
	when 'Proposal Approval Document' then final_comp_28722
else 0 
end as completed,
 
case col
	when 'Partner | Due Dilligence' then final_rej_28730
	when 'Partner | Background Information' then final_rej_47474
	when 'Partner | Proposal' then final_rej_47477
	when 'Approval by CSR team' then final_rej_28720
	when 'Due Diligence Task' then final_rej_82013
	when 'Post Due Diligence Approval by CSR Team' then final_rej_82014
	when 'Approval by Vertical Head' then final_rej_28723
	when 'Approval by reliance Team' then final_rej_28726
	when 'Approval by Legal Team' then final_rej_28724
	when 'Approval by Finance Team' then final_rej_28718
	when 'Approval by CSR functional head' then final_rej_28721
	when 'Approval by Board' then final_rej_47487
	when 'Proposal Approval Document' then final_rej_28722
else 0 
end as rejected,
  
1 as count
  
from t5
cross join temp),

vert as
(select vertical, grantpartnerid from profile_56574)
Select * from t4
where grantproposalid=85421
/*
with table1 as (Select p3.name as projectId,p1.name as projectpartner,p2.name as partner,p.name,p.fy_timerange,
--substring(cast(fy_timerange.start as varchar),1,4) as year1,
				--substring(cast(fy_timerange.start as varchar),6,2) as month,
CAST(fy_timerange.start AS DATE) AS startt,
				extract(month from CAST(fy_timerange.start AS DATE) ) as month,
--to_char(cast(fy_timerange.start as datetime), 'MONTH') as mm,

extract(year from startt) as year,
CASE
	WHEN month = 1 THEN 'January'
	WHEN month = 2 THEN 'February'
	WHEN month = 3 THEN 'Mar'
	WHEN month = 4 THEN 'April'
	WHEN month = 5 THEN 'May'
	WHEN month = 6 THEN 'June'
	WHEN month = 7 THEN 'July'
	WHEN month = 8 THEN 'August'
	WHEN month = 9 THEN 'September'
	WHEN month = 10 THEN 'October'
	WHEN month = 11 THEN 'November'
	WHEN month = 12 THEN 'December'
	ELSE 'No Data Entry'
	END AS quarter,

p.file, 
t.name as type_doc,p.remarks,
case
when p.file IS NOT NULL then 'Download'
else 'NA'
end as download
from profile_81314 p

left join project_9730 p1 on p1.id = p.projectid
left join project_9730 p2 on p2.id = p1.parent
left join project_9730 p3 on p3.id=p2.parent
left join tagelement_9730 t on t.id = p.type),

table2 as (Select projectId, projectpartner,year,quarter from table1)
Select  (quarter ||'-'|| year) as myy from table2

--Select t2.abcd||t2.year1 as y1,t2.moi from table2 t2
--group by  p3.name,p1.name,p2.name,p.name,p.fy_timerange,p.file,t.name,p.remarks


with table1 as (
  select p.id as grantApplicationId,partner.id as grantPartnerId1, 
  proposal.id as grantProposalId1, proposallog.*,p.active as isactive, partner.active as activepartner, proposal.active as activeproposal, proposallog.active as activeproposallog
  
  from ds_mysql_prod_grantapplication p 
			   
left join ds_mysql_prod_grantpartner partner on
partner.grantapplicationid = p.id	
			
left join ds_mysql_prod_grantproposal proposal on
proposal.grantpartnerid = partner.id

left join ds_mongo_grantproposallog proposallog on
cast(proposallog.grantproposalid as int) = proposal.id
  
  
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17		   
),
t2 as(
select * from table1 where grantApplicationId = 1792 and isactive = 1 and activepartner = 1 and activeproposal = 1 and activeproposallog = 't' --and _id = '600eade8e37d56760546e4d6' 
),
t3 as (
Select tt.*,cgf from t2 as tt,tt.completedgrantflowtask cgf
)
,
t4 as(
Select t3.*,cast(t3.todo."action" as varchar) as action,
  case
	when cgf."status" = 'COMPLETED' and cgf."taskId"=47474 then grantproposalid
	end as comp,
case
	when action = 'PENDING' and t3.todo."taskId"=47474 then grantproposalid
	end as pend,
case
	when action = 'REJECTED' and todo."taskId"=47474 then grantproposalid
	end as rej,

case
	when cgf."status" = 'COMPLETED' and cgf."taskId"=47477 then grantproposalid
	end as comp47477,
case
	when action = 'PENDING' and t3.todo."taskId"=47477 then grantproposalid
	end as pend47477,
case
	when action = 'REJECTED' and todo."taskId"=47477 then grantproposalid
	end as rej47477,
object(
'In Progress', 
ARRAY(JSON_PARSE(case
	when action = 'PENDING' and t3.todo."taskId"=47474 then grantproposalid
	end)),
  'Completed', LISTAGG(comp,','),
 'Rejected', jSON_PARSE(case
	when action = 'REJECTED' and todo."taskId"=47474 then grantproposalid
	end)

) as Approval_by_CSR_team
 from t3
group by 

grantapplicationid	,grantpartnerid1	,grantproposalid1,	_id,	grantproposalid	,grantflowtaskid,	active,	completedgrantflowtask,	todo,	created,	creatorid,	modified,	modifierid,	grantpartnerid,	isactive,	activepartner,	activeproposal,	activeproposallog,	cgf
--approval_by_csr_team
)
Select grantapplicationid  ,SPLIT_TO_ARRAY(listagg(distinct comp,', ')) as compp,get_array_length(compp),listagg(distinct pend,' ') as pend, listagg(distinct rej,' ') as rej,

SPLIT_TO_ARRAY(listagg(distinct comp47477,', ')) as comp_47477,get_array_length(comp_47477),listagg(distinct pend47477,' ') as pend47477, listagg(distinct rej47477,' ') as rej47477
from t4
group by 1
*/
