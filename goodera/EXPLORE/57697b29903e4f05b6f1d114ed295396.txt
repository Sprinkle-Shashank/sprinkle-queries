with table0 as (
select * from profile_79767)
,table1 as (select engagement_online, engagement_offline, gd.name as grade, 			Substring(json_serialize(fy_timerange),11,4)::smallint as year, Substring(json_serialize(fy_timerange),16,2)::smallint as start_month,
  Substring(json_serialize(fy_timerange),49,2)::smallint as end_month,
case when start_month = 1 then 'January'
	 when start_month = 2 then 'February'
	 when start_month = 3 then 'March'
	 when start_month = 4 then 'April'
	 when start_month = 5 then 'May'
	 when start_month = 6 then 'June'
	 when start_month = 7 then 'July'
	 when start_month = 8 then 'August'
	 when start_month = 9 then 'September'
	 when start_month = 10 then 'October'
	 when start_month = 11 then 'November'
	when start_month = 12 then 'December' end as start_month_name,
   case when end_month = 2 then 'January'
	 when end_month = 3 then 'February'
	 when end_month = 4 then 'March'
	 when end_month = 5 then 'April'
	 when end_month = 6 then 'May'
	 when end_month = 7 then 'June'
	 when end_month = 8 then 'July'
	 when end_month = 9 then 'August'
	 when end_month = 10 then 'September'
	 when end_month = 11 then 'October'
	 when end_month = 12 then 'November'
	when end_month = 1 then 'December' end as end_month_name, no_of_offline_sessions,no_of_online_sessions from table0 as p, p.engagement_practice_offline engagement_offline, p.engagement_practice_online engagement_online 

								
left join ds_mysql_prod_tagelement gd
on p.grade = gd.id

--where engagement_practice_online is not null and engagement_practice_offline is not null
			   
			   ), table2 as (
			   select case when (year=2021 and start_month>3) or (year=2022 and start_month<4) then 'FY 2021-22' 
	 when (year=2022 and start_month>3) or (year=2023 and start_month<4) then 'FY 2022-23'
	 when (year=2023 and start_month>3) or (year=2024 and start_month<4) then 'FY 2023-24'
	 else 'FY 2024-25' end as year,concat(concat(start_month_name,' - ' ),end_month_name) as quarter,egon.name as engagement_practice_online, egof.name as engagement_practice_offline, no_of_online_sessions, no_of_offline_sessions, grade from table1
				 
				 
left join ds_mysql_prod_tagelement egon
on table1.engagement_online = egon.id 
				
				left join ds_mysql_prod_tagelement egof
on table1.engagement_offline = egof.id 
			   
			   )
select year, quarter, grade, listagg( distinct engagement_practice_online, ', ') as engagement_practice_online, listagg( distinct engagement_practice_offline, ', ') as engagement_practice_offline,sum(no_of_online_sessions) as online_sessions,sum(no_of_offline_sessions) as offline_sessions  from table2

group by year,quarter,grade


/*Select t.name as projectid, fy_timerange, extract(year from cast(startdate as DATETIME)) as year,  Sum(CASE 
             WHEN keyword = 'non_renewable_fuel_consumed_petrol' THEN datanumBase
             ELSE 0 
           END) AS fuel_petrol,
 Sum(CASE 
             WHEN keyword = 'non_renewable_fuel_consumed_diesel' THEN datanumBase
             ELSE 0 
           END) AS fuel_diesel,
 Sum(CASE 
             WHEN keyword = 'non_renewable_fuel_consumed_cng' THEN datanumBase
             ELSE 0 
           END) AS fuel_cng,
 Sum(CASE 
             WHEN keyword = 'non_renewable_fuel_consumed_png' THEN datanumBase
             ELSE 0 
           END) AS fuel_png,
 Sum(CASE 
             WHEN keyword = 'non_renewable_fuel_consumed_lpg' THEN datanumBase
             ELSE 0 
           END) AS fuel_lpg,
		   row_number() over (order by fy_timerange) as s_no
 
 
from sus_79029

left join ds_mysql_prod_project t
on xprojectid=t.id

where keyword in ('non_renewable_fuel_consumed_petrol','non_renewable_fuel_consumed_cng','non_renewable_fuel_consumed_lpg','non_renewable_fuel_consumed_png','non_renewable_fuel_consumed_diesel')

group by t.name, fy_timerange, year


*/