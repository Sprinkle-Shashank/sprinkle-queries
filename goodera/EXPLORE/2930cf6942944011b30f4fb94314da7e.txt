with table1 as ( select _id , projectid,pace_status as facility_status,row_number() over 
(partition by projectid
 order by _id desc) as row from profile_54267 p
		/*left join ds_mysql_prod_project as pro
on p.projectid = pro.id*/	   ),

table2 as ( select * from table1 
		  where row = 1),

table3 as (
  select p.projectid,name_factory,name_vendor_filter,name_country,add_factory.sourcing_yn,add_factory.pace_status_2,cast(add_factory.factory_vpid_1 as varchar(65535)) as vpid_1,add_factory.factory_vpid,add_factory.factory_vpid_2,add_factory.child_vendor_vpid,add_community.pace_status as status_community,add_community.pace_status_2 as status_community_2,add_community.cp_location_id,add_community.cp_id,t2.facility_status ,
 gap_pace.pace_brands,gap_pace.brand_old from profile_54646 p

left join profile_52713 add_factory on
p.projectid = add_factory.projectid 

left join profile_4948 add_community on
p.projectid = add_community.projectid
 
left join profile_52810 gap_pace on
  p.projectid = gap_pace.projectid

left join table2 t2 on 
p.projectid= t2.projectid  
),
table4 as (
select projectid,case when sourcing_yn =57472 and facility_status = 845114 then name_factory
            when sourcing_yn = 57473 and (pace_status_2 in (845114 ,898423,898425,898426))or pace_status_2 is null then   name_factory 
			when status_community = 182398 then name_factory end as factory,
case when factory ilike '%CP%' then cp_location_id
     else factory_vpid end as factory_locationid,brand_old
  ,name_vendor_filter,case when sourcing_yn =57472 then vpid_1 
     when sourcing_yn =57473 and pace_status_2 in(845114 ,898423,898425,898426) then factory_vpid_2
	 when status_community = 182398 then cp_id  end as vpid_and_cpid,name_country,
  case when factory ilike '%CP%' then status_community_2
       else pace_status_2 end as "PACE_STATUS",pace_brand

			
			from table3 t3, t3.pace_brands pace_brand
where factory is not null
),
table5 as ( select _id,select_module from profile_4227 p, p.select_modules select_module ),
table6 as (select _id, listagg(module.name,',') as select_moudle  from table5 t5
		   left join ds_mysql_prod_tagelement module
on t5.select_module = module.id
		  group by _id 
		   )
select p._id,p.projectid,start_year,t4.factory,t4.factory_locationid,
       case when start_year >= 2020 and extract(month from start_date) >= 10 and   			   t4.factory ilike '%CP%' then t4.pace_brand
	   when start_year >= 2020 and t4.factory ilike '%Factory%' then t4.pace_brand
	   else t4.brand_old end as brand,t4.name_vendor_filter,t4.vpid_and_cpid,t4.name_country,t4."PACE_STATUS",createddate,modifieddate,start_date,name as batch_id,type_program,t6.select_module
	   from profile_4227 p

left join table4 t4 on 
p.projectid = t4.projectid

left join table6 t6 on
p._id=t6._id