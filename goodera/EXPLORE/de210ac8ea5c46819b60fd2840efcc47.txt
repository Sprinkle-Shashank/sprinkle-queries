with sub1 as(
	select p1._id as id, p1.project_id, p1.fy_timerange, p2.pvh_id, p3.region, p1.end_date_2, p1.num_females, p1.project_name, p1.select_modules, extract(year from cast(fy_timerange.start as date)) as year, p1.hours, p1.num_females_graduated, p1.num_males, p1.num_females_dropout, p1.num_males_graduated, p1.num_males_dropout
from profile_62491 p1
	left join profile_62948 p2 on p2.project_id = p1.project_id
	left join profile_60928 p3 on p2.pvh_id = p3.factory_id
    where p2.pvh_id is not NULL),
	
sub2 as(
  select fy_timerange, pvh_id, region, sum(num_females) as num_females, select_modules, end_date_2
  from sub1 
	group by select_modules, end_date_2, fy_timerange, num_females_graduated, num_males, num_females, num_females_dropout, num_males_graduated, num_males_dropout, pvh_id, hours, region),
	
sub3 as(
  select s2.*, select_modules1, country from sub2 s2, s2.region country, s2.select_modules select_modules1)

select s3.fy_timerange, s3.pvh_id, t1.name as region, t2.name as select_modules1, sum(num_females) as fems
	from sub3 s3
	left join ds_mysql_prod_tagelement t1 on t1.id = s3.country
	left join ds_mysql_prod_tagelement t2 on t2.id =s3.select_modules1
	group by s3.fy_timerange, t1.name, s3.pvh_id, t2.name, s3.end_date_2, s3.num_females_graduated, s3.hours, s3.num_males, s3.num_females, s3.num_females_dropout, s3.num_males_graduated, s3.num_males_dropout, s3.region
