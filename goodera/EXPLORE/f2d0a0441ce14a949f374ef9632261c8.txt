with tab1 as(select split_part(split_part(p1.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange,p1.name_project, sum(p1.curr_yr_budget) as curr_yr_budget,
concat(projectcode,fy_timerange) as CODE,p7.name as ImplementingAgency,p8.name as interventiontype,p10.name as CoreArea , concat(concat(split_part(p1.start_date,' ',1),' to '), split_part(p1.end_date,' ',1)) as duration,m.name as project_manager,substring(p1.submission_date,6,2) as months
from profile_27396 p1
left join ds_mysql_prod_tagelement f on
p1.fy=f.id
left join profile_27395 p7
on p7._id=p1.ngo_partner
left join profile_28235 p8
on p8._id=p1.intervention_type
left join ds_mysql_prod_tagelement p10
on p10.id=p1.focus_area
left join ds_mysql_prod_tagelement m on
p1.project_manager=m.id
	group by 1,2,3,4,6,8,9,10,11,12)
union all
select split_part(split_part(split_part(p3.name,'|',1),'.',1),' ',1 ) as projectcode,
f.name as fy_timerange, p3.name_project,sum(p3.curr_yr_budget) as curr_yr_budget1,
concat(projectcode,fy_timerange) as CODE,p3.ngo as ImplementingAgency,p3.int_type_calc2 as interventiontype,p3.focus_area as CoreArea ,
concat(concat(split_part(p3.start_date,' ',1),' to '), split_part(p3.end_date,' ',1)) as duration,m.name as project_manager,substring(p3.submission_date,6,2) as months1
from profile_27420 p3
left join ds_mysql_prod_tagelement f on
p3.fy=f.id 
left join ds_mysql_prod_tagelement m on
p3.project_manager=m.id
group by 1,2,3,4,6,8,9,10,11,12)),

/*tabforstate as(select tab1.*, s.name as state
		from tab1
left join profile_27396 p1
on split_part(split_part(p1.name,'|',1),'.',1)  =tab1.projectcode
left join ds_mysql_prod_tagelement s
on s.id=RTRIM(LTRIM(cast( p1.state as varchar),'['),']') )

select * from tabforstate*/
tab2 as (select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,t.name as fy_timerange,t2.name as Quarter,concat(projectcode,fy_timerange) as CODE,sum(p.monthly_cost) as monthlycost  from profile_30171 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement t
on p.fy=t.id
left join ds_mysql_prod_tagelement t1
on p.month_number=t1.id
left join ds_mysql_prod_tagelement t2
on t1.parent=t2.id
group by 1,2,3,4)


tab3 as (select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,t.name as fy_timerange,concat(projectcode,fy_timerange) as CODE, split_part(prod.name,'|',3) as censuscode,
q.state,q.district,sum(p.hdfc_cost_monthly),t2.name as Quarter		 from profile_29974 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement t
on p.fy=t.id
 left join profile_27489 q on
split_part(prod.name,'|',3)=q.name
left join ds_mysql_prod_tagelement t1
on p.month_number=t1.id
left join ds_mysql_prod_tagelement t2
on t1.parent=t2.id
group by 1,2,3,4,5,6,8
 )

select tab1.projectcode,tab1.fy_timerange,tab1.name_project, tab1.curr_yr_budget,
tab1.CODE,tab1.ImplementingAgency,tab1.interventiontype,tab1.CoreArea , tab1.duration,tab1.project_manager, count(distinct(tab3.censuscode)) as numberofvillages,tab3.state ,count(distinct(tab3.district)) as districtcount
from tab1
left join tab3 
on tab1.CODE=tab3.CODE group by
tab1.projectcode,tab1.fy_timerange,tab1.name_project, tab1.curr_yr_budget,
tab1.CODE,tab1.ImplementingAgency,tab1.interventiontype,tab1.CoreArea ,tab1.duration,tab1.project_manager,tab3.state
			


