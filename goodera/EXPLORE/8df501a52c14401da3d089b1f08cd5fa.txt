with lookup2 as (select p._id as instance,split_part(split_part(prod.name,'|',1),'.',1) as ProjectCode,f.name as fy_timerange,concat(ProjectCode,fy_timerange) as Code,split_part(prod.name,'|',3) as census  from profile_54963 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement f on
p.fy=f.id
left join ds_mysql_prod_tagelement m on
p.month=m.id),lookup21 as(select p.instance,p.ProjectCode,p.fy_timerange,l.village as Village,p.Code from lookup2 p left join profile_27489 l on p.census=l.name),lookup22 as(select cast(q.name as varchar) as ProjectCode,f.name as fy_timerange,m.name as Project_Manager,CONCAT(ProjectCode,fy_timerange) as CODE
from profile_27420 d
left join ds_mysql_prod_tagelement f on
d.fy=f.id
left join ds_mysql_prod_tagelement m on
d.project_manager=m.id
left join profile_27396 q on
d.project_code=q._id
union
select cast(c.name as varchar)as ProjectCode,f.name as fy_timerange,m.name as Project_Manager,CONCAT(ProjectCode,fy_timerange) as CODE 
from profile_27396 c	
left join ds_mysql_prod_tagelement f on
c.fy=f.id
left join ds_mysql_prod_tagelement m on
c.project_manager=m.id),lookup24 as(select p.instance,p.fy_timerange,p.ProjectCode,p.Village,l.Project_Manager from lookup21 p left join lookup22 l on p.Code=l.CODE ),
Base5 as(select m.profileinstanceid, o, cast(o."approvalStatus" as varchar) as status from test_hdfc_sample m, m.approvallog o ),Base6 as(select distinct(p.profileinstanceid),p.status,case when p.profileinstanceid is not null then 'Approved by first Manager' end as type from Base5 p where p.status='APPROVED')
,Base7 as(select p.profileinstanceid,count(p.status) as Approvers,case when p.profileinstanceid is not null then 'Approved by 2nd manager' end as type from Base5 p where p.status='APPROVED' group by p.profileinstanceid having count(p.status)>1),Base8 as(select p.instance,l.profileinstanceid, p.fy_timerange,p.ProjectCode,p.Village,p.Project_Manager,l.Approvers,l.type from lookup24 p left join Base7 l on p.instance=l.profileinstanceid)
--select * from Base7
--select * from test_hdfc_sample
select * from Base8