with lookup1 as (select p._id as instance,split_part(split_part(prod.name,'|',1),'.',1) as ProjectCode,f.name as fy_timerange,cocat(ProjectCode,fy_timerange) as Code,split_part(prod.name,'|',3) as census  from profile_54963 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement f on
p.fy=f.id
left join ds_mysql_prod_tagelement m on
p.month=m.id),Base6 as(select p.instance,p.ProjectCode,p.fy_timerange,l.village as Village from lookup1 p left join profile_27489 l on p.census=l.name), 
Base5 as(select m.profileinstanceid, o,data."village" as Village, cast(o."approvalStatus" as varchar) as status from test_hdfc_sample m, m.approvallog o ),Base6 as(select distinct(p.profileinstanceid),p.status,case when p.profileinstanceid is not null then 'Approved by first Manager' end as type from Base5 p where p.status='APPROVED')
,Base7 as(select p.profileinstanceid,count(p.status),case when p.profileinstanceid is not null then 'Approved by 2nd manager' end as type from Base5 p where p.status='APPROVED' group by p.profileinstanceid having count(p.status)>1)
--select * from Base7
--select * from test_hdfc_sample
select * from Base5