with sub1 as(
  select p1.region_parent as region, p1.curr_cr_rating, p1.timeperiod_timerange, p1.factory_id, is_array(p1.source_div) as source_div_array_check,
case
	when source_div_array_check is false or GET_ARRAY_LENGTH(p1.source_div) = 0 then array(p1.source_div)
	else p1.source_div
end as source_div_new
from profile_60928 p1
where p1.curr_cr_rating = 957780 and nvl(cr_tier, 0) not in (957759, 957760)),

sub2 as(
  select s1.*, source_div from sub1 s1, s1.source_div_new source_div),
  
sub3 as(
select s2.region, s2.timeperiod_timerange, split_to_array(listagg(distinct s2.factory_id,','),',') as Factory_id, t1.name as source_div, t2.name as CR_Rating_text
from sub2 s2
left join ds_mysql_prod_tagelement t1 on t1.id = s2.source_div
left join ds_mysql_prod_tagelement t2 on t2.id = s2.curr_cr_rating
group by s2.region, s2.timeperiod_timerange, t1.name, t2.name),

sub4 as(
  select Get_array_length(Factory_id) as count,region, 
(timeperiod_timerange.start || '|' || timeperiod_timerange.end) as timeperiod_timerange, source_div, CR_Rating_Text from sub3)

select region, source_div, CR_Rating_Text, timeperiod_timerange, sum(count) from sub4
group by region, source_div, CR_Rating_Text, timeperiod_timerange