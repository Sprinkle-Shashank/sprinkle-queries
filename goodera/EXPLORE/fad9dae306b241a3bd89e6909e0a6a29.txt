

with temp1 as
(select m.projectId, m.indicator, m.proj, m.target, indi_parent.name as int_indi , r.year, r.project_code_new , indi.name,  vertical, focus, state, direct_or_partner, district, csr, budget_outlay, entity
from profile_61044 as m

left join ds_mysql_prod_tagelement as indi
on m.indicator = indi.id
 
left join ds_mysql_prod_tagelement as indi_parent
on indi.parent = indi_parent.id

left join profile_55194 AS r 
 on m.proj = r.project_code_new

 
left join profile_62881 AS n1
 on m.project_code = n1._id
 
)
select * from temp1

 
/*left join profile_62881 n1
 on n.vertical = vertical.id
left join profile_62881 n1
 on n.focus = focus.id
left join profile_62881 n1
 on n.state = state.id
left join profile_62881 n1
 on n.direct_or_partner = direct_or_partner.id
left join profile_62881  n1
 on n.district = district.id 
left join profile_62881 n1
 on n.csr = csr.id 
left join profile_62881 n1
 on n.budget_outlay = budget_outlay.id
left join profile_62881 n1
 on n.entity = entity.id),

temp2 as
( select indicator, target, int_indi , year, project_code_new  , sum(target) as target_updated from temp1 as m
group by indicator, target, int_indi, year, project_code_new),

temp3 as
(select indicator, target, int_indi , year, project_code_new as project_code ,
concat(indicator, concat('-',target)) AS indicator from temp2),



temp4 as
(select m.indicator, m.target, m.int_indi , r.year, r.project_code, r.vertical, m.focus, m.state, m.direct_or_partner, m.district, m.csr, m.budget_outlay, m.entity from temp3
 
left join profile_62881 AS n
 on temp3.project_code = n._id
 
)

temp5 as
(select indicator, target, int_indi , year, project_code ,
concat(yearc, concat('-',project_code)) AS yearc from temp4)

temp6 as
(select indicator, target, int_indi , year, project_code from temp3
 
left join profile_55194 AS r 
 on m.yearc = r.concat_year
 
left join ds_mysql_prod_tagelement as month_timerange
 on r.month_timerange = month_timerange.id
left join ds_mysql_prod_tagelement as amount
 on r.amount = amount.id),
 
 temp7 as
(select m.int_indi, m.year, m.indicator, m.project_code, m.vertical, m.focus, m.state, m.direct_or_partner, m.district, m.csr, m.entity, m.budget_outlay, m.yearc, m.month_timerange,  SUM(m.amount) as amount
from temp6 as m
group by m.int_indi, m.year, m.indicator, m.project_code, m.vertical, m.focus, m.state, m.direct_or_partner, m.district, m.csr, m.entity, m.budget_outlay, m.yearc, m.month_timerange)
 
temp8 as
(select m.int_indi, m.year, m.indicator, m.project_code, m.vertical, m.focus, m.state, m.direct_or_partner, m.district, m.csr, m.entity, m.budget_outlay, m.yearc, m.month_timerange ,
 
case 
when vert1.name IS NULL AND vert.name IS NOT NULL THEN vert.name
when vert1.name IS NULL AND vert.name IS NULL then 'Admin'
else vert1.name 
END AS vertical

from temp7 as m

left join ds_mysql_prod_tagelement as vert
 on m.vertical_new = vert.id
  
left join ds_mysql_prod_tagelement as vert1
 on vert.parent = vert1.id),

temp9 as
(select m.int_indi, m.year, m.indicator, m.vertical, m.focus, m.direct_or_partner, m.csr, m.entity, m.budget_outlay, m.month_timerange)
 */

