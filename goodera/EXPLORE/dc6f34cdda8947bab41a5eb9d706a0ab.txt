with sub1 as (
  select p1._id,p1.year_timerange as Timerange, p1.distance_car, p1.distance_public_transport, p1.distance_motorbike, p1.distance_walking, p1.distance_others,p1.name_location from profile_73046 p1),

sub2 as(select 'Car' as col
union all
select 'Public Transport (bus, train, metro, subway, etc)' as col
union all
select ' Motorbike/Scooter' as col
union all
select 'Walking/ Bike/E-Scooter/ E-Bike' as col
union all
select 'Others' as col),

sub3 as(select p1._id,p1.name_location as projectId, Timerange,sub2.col as commute_type, 

  case col
	when 'Car' then p1.distance_car
  	when 'Public Transport (bus, train, metro, subway, etc)' then p1.distance_public_transport
  	when 'Motorbike/Scooter' then p1.distance_motorbike
  	when 'Walking/ Bike/E-Scooter/ E-Bike' then p1.distance_walking
	when 'Others' then p1.distance_others
	else 0
  end
  as commute_mileage
 

from sub1 p1
cross join sub2
)
 ,s4 as (
select _id,projectId,Timerange,commute_type,commute_mileage,listagg(distinct(commute_mileage),',') as commute_mileage_dup
from sub3
where commute_mileage is not null and commute_mileage !=' '
group by 1,2,3,4,5)
,
s5 as (
select s4._id,p2.name as projectId,Timerange,1 as count,
   case
	when commute_type='Public Transport (bus, train, metro, subway, etc)' then 'Public Transport'
	else commute_type
end as commute
  from s4
  left join profile_74147 p2 on p2._id= s4.projectId

)
Select * from s5