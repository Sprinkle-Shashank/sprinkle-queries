with tab1 as (select cast((split_part(prod.name,'|',1)) as varchar) as prj1,cast((split_part(split_part(prod.name,'|',1),'.',1)) as varchar) as prj2,prj_code,f.name as fy_timerange,n1.name as focus_area from profile_54963 p
left join ds_mysql_prod_project prod
on p.projectid=prod.id
left join ds_mysql_prod_tagelement f on
p.fy=f.id
left join ds_mysql_prod_tagelement n1 on
n1.id=p.focus_area),

tab3 as (
  
  select q.name as prj3,'-1' as c, f.name as fy,' ' as state, m.name as manager,f1.name as focus_area,
  ' ' as ngo_partners
from profile_27420 d
  
left join ds_mysql_prod_tagelement f on
d.fy=f.id
left join ds_mysql_prod_tagelement m on
d.project_manager=m.id
left join ds_mysql_prod_tagelement f1 on
d.focus_area=f1.id
left join profile_27396 q on
d.project_code=q._id
		   
union all
  
  select q.prj2 as prj3,count(q.prj1) as c,q.fy_timerange fy,p.state,t2.name as manager,q.focus_area,p2.name as ngo_partners from profile_27396 p
		 left join tab1 q
		 on p._id=q.prj_code
		 left join ds_mysql_prod_tagelement t2
         on p.project_manager=t2.id
		 left join profile_27395 p2
         on p.ngo_partner = p2._id
		group by prj3,fy_timerange,p.state,manager,q.focus_area,ngo_partners
  
		union all

		select q.prj2 as prj3,count(q.prj1) as c,q.fy_timerange fy,p.state,t2.name as manager,q.focus_area,p2.name as ngo_partners from profile_27396 p
		 left join tab1 q
		 on p._id=q.prj_code
		 left join ds_mysql_prod_tagelement t2
         on p.project_manager=t2.id
		 left join profile_80183 p2
         on p.ngo_partner = p2._id
		group by prj3,fy_timerange,p.state,manager,q.focus_area,ngo_partners),
		
		
		
		
level1tab as (select m.name as level1 ,p.approver as level2,p.name as level1email from profile_27424 p
left join ds_mysql_prod_tagelement m on
m.id = p.pm_name),

level2tab as (select m.name as level1 , z.level1 as level2 from profile_27424 p
left join ds_mysql_prod_tagelement m on
m.id = p.pm_name
left join level1tab z on
z.level1email = p.approver),

newtab1 as (
   Select c, prj3,fy,focus_area,ngo_partners,d.level1, d.level2 from tab3 t
  --t, t.state st
left join level2tab d on
d.level1 = t.manager
),

Select *, st from newtab1 t,t.state st

/*	
tab4 as(
		Select c, prj3,fy, st,manager,focus_area,ngo_partners from tab3 t, t.state st
)


select t1.prj3,t1.c,t1.fy,t.name as state,t1.manager,t1.focus_area,t1.ngo_partners from tab4 t1
left join ds_mysql_prod_tagelement t
on t.id=t1.st

 */

 