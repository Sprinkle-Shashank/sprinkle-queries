with sub1 as(
  select x1._id as id, x1.profileinstanceid, x1.status, x1.active, x1.data, x1.taskuserid, x2.taskid, x5.projectid, x6.profileid, x4.sectionid, x6.name as section, x7.name as profile, x8.name as project, x1.created, x1.modified,
  
case
  when is_array(x1.submissionlog) = false or get_array_length(x1.submissionlog) = 0 then 
  	   array(x1.submissionlog)
  else x1.submissionlog
end as submissionlog_new,
case
  when is_array(x1.approvallog) = false or get_array_length(x1.approvallog) = 0 then 
  	   array(x1.approvallog)
  else x1.approvallog
end as approvallog_new
  
from ds_mongo_taskresponse x1 

left join ds_mysql_prod_taskuser x2 on x2.id = x1.taskuserid
left join ds_mysql_prod_task x3 on x3.id = x2.taskid
left join ds_mysql_prod_flowtask x4 on x4.id = x3.flowtaskid
left join ds_mysql_prod_projectflow x5 on x5.id = x3.projectflowid
left join ds_mysql_prod_section x6 on x6.id = x4.sectionid
left join ds_mysql_prod_profile x7 on x7.id = x6.profileid
left join ds_mysql_prod_project x8 on x8.id = x5.projectid

where x6.profileid = 27396 and x1.active = 't'
and x1.status in ('REJECTED', 'PENDING_APPROVAL', 'SUBMITTED')

group by x1._id, x1.profileinstanceid, x1.status, x1.active, x1.data, x1.taskuserid, x2.taskid, x5.projectid, x6.profileid, x4.sectionid, x6.name, x7.name, x8.name, x1.submissionlog, x1.approvallog, x1.created, x1.modified),

--xx--FLOW

sub2 as(
  select s1.id, s1.status, s1.created, s1.modified, s1.data, s1.submissionlog_new, s1.approvallog_new, submission_log, cast(submission_log."timestamp" as DATETIME) as submission_log_timestamp,
  
row_number() over(partition by s1.id order by submission_log_timestamp asc) as row1
from sub1 s1, s1.submissionlog_new as submission_log), 

--xx--Initial Submission Date

sub3 as(
  select s2.id, s2.status, s2.created, s2.modified, s2.data, s2.submissionlog_new, s2.approvallog_new, cast(s2.submission_log_timestamp as DATE) as initial_submission_date, submission_log2, cast(submission_log2."timestamp" as DATETIME) as submission_log_timestamp2,
  
row_number() over(partition by s2.id order by submission_log_timestamp2 desc) as row2
from sub2 s2, s2.submissionlog_new as submission_log2

where s2.row1 = 1),

--xx--Final Submission Date

sub4 as(
  select s3.id, s3.status, s3.created, s3.modified, s3.data, s3.submissionlog_new, s3.approvallog_new, s3.initial_submission_date, cast(s3.submission_log_timestamp2 as DATE) as final_submission_date,
approval_log, cast(approval_log."timestamp" as DATETIME) as approval_log_timestamp, cast(approval_log."approverEmail" as VARCHAR) as approveremail,

row_number() over(partition by s3.id, approverEmail order by approval_log_timestamp desc) as row3
from sub3 s3, s3.approvallog_new as approval_log

where s3.row2 = 1)

--xx--Approval Log

select s4.id, s4.status, s4.data, s4.initial_submission_date, s4.final_submission_date, s4.approveremail, cast(s4.approval_log_timestamp as DATE) approval_date, s4.data.name as projectcode,

cast(timestamp 'epoch' + CAST(s4.created AS BIGINT)/1000 * interval '1 second' as date) as created,
cast(timestamp 'epoch' + CAST(s4.modified AS BIGINT)/1000 * interval '1 second' as date) as modified

from sub4 s4
where s4.row3 = 1