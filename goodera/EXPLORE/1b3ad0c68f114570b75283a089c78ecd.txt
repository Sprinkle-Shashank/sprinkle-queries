with sub1 as(
  select p1.quarter_timerange as fy_timerange, p1.meet_target, p1.factory_text, p1.cdms_id, 
row_number() over (partition by p1.cdms_id order by cast(p1.quarter_timerange.start as date) desc) as row_number
from profile_66533 p1),

sub2 as(
  select * from sub1
where row_number = 1 and meet_target = 'Yes')

select s2.fy_timerange, s2.factory_text, s2.cdms_id, p2.source_div, p2.region, p2.brand
from sub2 s2
left join profile_60928 p2 on p2.factory_id = s2.cdms_id
