with sub1 as(select p1.name as projectid,t1.name as financial_period,fy_timerange,datatablebase,tablesettings,questiontext

from sus_56551 p1
left join ds_mysql_prod_tagelement t1 on t1.id=p1.financialPeriod
where keyword='gri_hazardouswaste' and datatablesettings is not null),

sub2 as(select * ,temp.gri_biomedicalwaste,temp.gri_ewaste,temp.gri_phosphatedischarge,temp.gri_oil_greasedischarge,temp.gri_ammonia_nitrogen_discharge,temp.gri_spentoil,temp.gri_fusedash,temp.gri_discardedcontainers,temp.gri_batteries,temp.gri_spentcatalyst,temp.gri_oilresidue,temp.gri_chemicalsludge_etp
from sub1 s1, unpivot s1.datatablebase as temp at rows)

select projectid, financial_period,gri_biomedicalwaste, gri_phosphatedischarge, gri_oil_greasedischarge, gri_ammonia_nitrogen_discharge, gri_spentoil, gri_fusedash, gri_discardedcontainers, gri_batteries, gri_spentcatalyst, gri_oilresidue, gri_chemicalsludge_etp, gri_ewaste,('FY' || ' ' || split_part(financial_period, ' ', 2)) as FY,rows,
case rows
when 'gri_biomedicalwaste' then cast(tablesettings."0"."gri_biomedicalwaste"."measureUnitBase" as VARCHAR)
when 'gri_ewaste' then cast(tablesettings."0"."gri_ewaste"."measureUnitBase" as VARCHAR)
when 'gri_phosphatedischarge' then cast(tablesettings."0"."gri_phosphatedischarge"."measureUnitBase" as VARCHAR)
when 'gri_oil_greasedischarge' then cast(tablesettings."0"."gri_oil_greasedischarge"."measureUnitBase" as VARCHAR)
when 'gri_ammonia_nitrogen_discharge' then cast(tablesettings."0"."gri_ammonia_nitrogen_discharge"."measureUnitBase" as VARCHAR)
when 'gri_spentoil' then cast(tablesettings."0"."gri_spentoil"."measureUnitBase" as VARCHAR)
when 'gri_fusedash' then cast(tablesettings."0"."gri_fusedash"."measureUnitBase" as VARCHAR)
when 'gri_discardedcontainers' then cast(tablesettings."0"."gri_discardedcontainers"."measureUnitBase" as VARCHAR)
when 'gri_batteries' then cast(tablesettings."0"."gri_batteries"."measureUnitBase" as VARCHAR)
when 'gri_spentcatalyst' then cast(tablesettings."0"."gri_spentcatalyst"."measureUnitBase" as VARCHAR)
when 'gri_oilresidue' then cast(tablesettings."0"."gri_oilresidue"."measureUnitBase" as VARCHAR)
when 'gri_chemicalsludge_etp' then cast(tablesettings."0"."gri_chemicalsludge_etp"."measureUnitBase" as VARCHAR)
else null
end as units
from sub2
where rows is not null
group by projectid, financial_period,gri_biomedicalwaste, gri_phosphatedischarge, gri_oil_greasedischarge, gri_ammonia_nitrogen_discharge, gri_spentoil, gri_fusedash, gri_discardedcontainers, gri_batteries, gri_spentcatalyst, gri_oilresidue, gri_chemicalsludge_etp, gri_ewaste,questiontext,fy_timerange,rows,units


