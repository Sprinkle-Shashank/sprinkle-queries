with sub3 as(
  select (s1.date_visit || '|' || s1.date_visit) as fy_timerange, p2.name as trucker_id, t1.name as plant,p2.patient,
 case
 when (bp_systolic >=75 and bp_systolic < 90) or (bp_diastolic >= 30 and bp_diastolic < 60)  then 'Hypotension (Low blood pressure)'
 when (bp_systolic >=90 and bp_systolic <= 140) and (bp_diastolic >= 60 and bp_diastolic <= 90) then  'Blood Pressure Normal'
 when (bp_systolic >=141  or bp_diastolic >= 91) then 'Hypertension (High blood pressure)'
 else NULL
 end as bp_range

from profile_73098 s1
left join profile_73096 p2 on p2._id = s1.trucker_id
left join profile_73150 p3 on p3._id = s1.clinic
left join ds_mysql_prod_tagelement t1 on t1.id = p3.plant),
/*

--group by fy_timerange,p2.name,t1.name,t2.name, diabetic_diagnosed,diabetic_range,s1.date_visit)


sub4 as (
select fy_timerange, trucker_id, plant,bp_range from sub2
union all
select fy_timerange, trucker_id, plant, bp_range from sub3)*/

sub4 as (select fy_timerange, plant,bp_range,trucker_id, count(*),patient,
case
when bp_range = 'Blood Pressure Normal' then 1
when bp_range = 'Hypotension (Low blood pressure)' then 2
when bp_range = 'Hypertension (High blood pressure)' then 3
else NULL end as status
from sub3
where bp_range IS NOT NULL
group by trucker_id,fy_timerange, plant, bp_range,patient)







/*select fy_timerange,trucker_id,plant, patient,count(*)
from (select t.*,
             rank() over (partition by trucker_id order by status desc) as prev_status
      from sub4 t
     ) t
where status = 1 and prev_status in (3, 2)
group by trucker_id,fy_timerange,plant,patient*/


select fy_timerange,trucker_id,status, patient,count(*) from ( select t.*,

lag(status) over (partition by trucker_id order by fy_timerange desc) as prev_status from sub4 t ) t

where where status = 1 and prev_status in (3,2)
group by trucker_id,fy_timerange,plant,patient




