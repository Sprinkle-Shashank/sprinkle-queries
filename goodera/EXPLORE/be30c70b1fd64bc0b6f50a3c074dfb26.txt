with table1 as(
  
select * from profile_68161 
),

table2 as 
(
  select p.* , cast( c as varchar ) as programs_run_update  from table1 p , p.programs_run as c 
 
),   
  
table3 as
( 
    select p.projectid, facility_name,  facility_status, facility_rating, pace_status, pace_status_detail, assessor, last_assessment_date,  payment_method, pace, wcp, sst, wep, gbv, goodera_facility_name_text, fac_vpid, parent_vendor_vpid, facility_score, open_issues, total_workers,
	
	programs_run_update_1.name as programs_run, 
	parent_vendor_name_1.name as vendor_name, 
	primary_category_1.name as primary_category,
	country_name_1.name as country_name,
  	case when status_new is null then status_begin else status_new end as wep_status ,
	profile_60670.status_begin as status_begin,
  	profile_65025.status_new as status_new
    
	from table2 p 
	 
	
 	 left join ds_mysql_prod_tagelement programs_run_update_1 on
 	 p.programs_run_update = programs_run_update_1.id
	
	 left join ds_mysql_prod_tagelement parent_vendor_name_1 on
 	 p.parent_vendor_name = parent_vendor_name_1.id
	
	 left join ds_mysql_prod_tagelement  primary_category_1 on
 	 p.primary_category =  primary_category_1.id
	
	 left join ds_mysql_prod_tagelement  country_name_1 on
 	 p.country_name =  country_name_1.id
	
	 left join profile_60670 on 
	 p.goodera_facility_name_text = profile_60670.facility_project_name_main
  
  	 left join profile_65025 on 
	 p.goodera_facility_name_text = profile_65025.facility_project_name_updated
	
	where facility_status in (845097, 845104) and wep = 57472 
  
Group By p.projectid, p.projectid, facility_name,  facility_status, facility_rating, pace_status, pace_status_detail, assessor, last_assessment_date,  payment_method, pace, wcp, sst, wep, gbv, goodera_facility_name_text, fac_vpid, parent_vendor_vpid, facility_score, open_issues, total_workers,wep_status ,
programs_run_update_1.name, parent_vendor_name_1.name , primary_category_1.name ,
country_name_1.name,profile_60670.status_begin,profile_65025.status_new
	
	)
	
	 select p.projectid, facility_name,  facility_status, facility_rating, pace_status, pace_status_detail, assessor, last_assessment_date,  payment_method, pace, wcp, sst, wep, gbv, goodera_facility_name_text, fac_vpid, parent_vendor_vpid, facility_score, open_issues, total_workers,country_name,primary_category ,vendor_name  ,status_begin,status_new,wep_status ,
	 listagg(programs_run ,',') as programs_run from table3 as p 
	 
	 
	 where wep_status <> 'Dropped' and p.projectid like '%%'	
	 
	 group by p.projectid, facility_name,  facility_status, facility_rating, pace_status, pace_status_detail, assessor, last_assessment_date,  payment_method, pace, wcp, sst, wep, gbv, goodera_facility_name_text, fac_vpid, parent_vendor_vpid, facility_score, open_issues, total_workers,country_name ,primary_category ,vendor_name,status_begin,status_new ,wep_status 
	 
