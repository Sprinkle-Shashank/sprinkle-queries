with temp as
(
  select 'energy_levelsachieved_verified' as col
  union all
  select 'wastewater_levelsachieved_verified' as col
  union all
  select 'ems_levelsachieved_verified' as col
  union all
  select 'chemicals_levelsachieved_verified' as col
  union all
  select 'waste_levelsachieved_verified' as col
  union all
  select 'air_levelsachieved_verified' as col
  union all
  select 'water_levels_achieved_verified' as col
  ),
sub1 as(
select _id,group_name, groupid, surveyid, country, energy_levelsachieved_verified, wastewater_levelsachieved_verified, ems_levelsachieved_verified, chemicals_levelsachieved_verified, sq.fy_timerange, waste_levelsachieved_verified, air_levelsachieved_verified, water_levels_achieved_verified, sacid,
case col
	when 'energy_levelsachieved_verified' then sq.energy_levelsachieved_verified
	when 'wastewater_levelsachieved_verified' then sq.wastewater_levelsachieved_verified
	when 'ems_levelsachieved_verified' then sq.ems_levelsachieved_verified
	when 'chemicals_levelsachieved_verified' then sq.chemicals_levelsachieved_verified
	when 'waste_levelsachieved_verified' then sq.waste_levelsachieved_verified
	when 'air_levelsachieved_verified' then sq.air_levelsachieved_verified
	when 'water_levels_achieved_verified' then sq.water_levels_achieved_verified
  else Null
	end as level, temp.col as module
from profile_74133 sq
cross join temp
  )
,sub2 as(
select s1.*, pd.cdms_id,source_div, cr_tier, facility_type, wet_process, timeperiod_timerange, position(1 in level) as level1, position(2 in level) as level2, position(3 in level) as level3, module, upper(substring(module,1,position('_' in module)-1)) as modules 
  from sub1 s1
left join profile_74334 pd
on pd.higg_id=s1.sacid
left join profile_60928 mr
on pd.cdms_id=mr.factory_id
where level!=' '
),
sub3 as
(
select country, fy_timerange, module, cdms_id, level1, first_value(source_div)
over(partition by country, fy_timerange, module, cdms_id, level1
order by timperiod_timerange desc
rows between unbounded preceding and unbounded following) as fa
from sub2
)
select fa, country, fy_timerange, module, cdms_id, level1 from sub3
group by fa, country, fy_timerange, module, cdms_id, level1