with t1 as (select xprojectid, finperiod , fy_timerange,keyword,datatablebase from sus_21557 as p  where keyword = 'recruitments')

, t2 as(
 select xprojectid, finperiod , fy_timerange,keyword,cast(co.name_employee_recruit as varchar),
 case when  is_Array(co.title_recruit) = false or get_array_length(co.title_recurit) = 0 then array(co.title_recurit)
 else co.title_recurit 
 end as title_new
 from t1 as t  ,unpivot t.datatablebase as co  at row
 ), 

  u as (select p.*,z from t2 as p ,p.title_new as z)
  , h as(
  select p1.xprojectid,p1.fy_timerange, t2.keyword, name_employee_recruit as recurit_name ,t6.name as gender,t5.name as country ,count(*) as total
  from u p1
  left join sus_46830 t2
  on p1.xprojectid = t2.xprojectid
 left join project_6664 t4 on t4.id = p1.xprojectid
--left join tagElement_6664 t1 on t1.id = t2.dataselect 
left join project_6664 t5 on t5.id = t4.parent
left join tagElement_6664 t6 on t6.id = p1.z
where t2.keyword = 'company_category' 
group by 1,2,3,4,5,6 )

select xprojectid,fy_timerange, keyword,  recurit_name , gender, country ,
total from h 
where country not in('Sri Lanka','India','Bangladesh')