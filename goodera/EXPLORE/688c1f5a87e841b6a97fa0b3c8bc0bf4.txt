--Target_RSAP_Workforce_Impacted
with table1 as
(select _id , projectId,country, vendor,unwind_cycle, product_category, consultant_tag from profile_64362 as p ,p.cycle as unwind_cycle),

 table2 as
(select _id, projectId,country, vendor,cycle,product_category,consultant_tag from profile_64362
  where _id not in (select _id from table1))
  ,
  
table3 as
 (
	select * from table1
  Union all
  select * from table2
 )
 ,
 table4 as  
(
 select _id,  projectId,country,vendor,unwind_cycle, unwind_product_category,consultant_tag from table3 t3, t3.product_category  as unwind_product_category
 ),

table5 as
(select _id, projectId,country,vendor,unwind_cycle,  null as product_category,consultant_tag from table3 
 where _id not in (select _id from table4)),
 
table6 as
(select * from table4
union all
select * from table5),

sub1 as (
Select p1.name as projectid,p.timerange_timerange,p.num_female,p.num_male,t1.name as training_type,t2.name as year,t3.name as country, a.vendor,tag13.name as consultant , t4.name as cycle , t5.name as product_category
from profile_61528 p 


left join table6 as a
on a.projectId = p.projectId
left join project_7746 p1 on p1.id = p.projectid
  
  

left join tagElement_7746 tag13
on a.consultant_tag = tag13.id
left join tagElement_7746 t1 on t1.id = p.training_type
left join tagElement_7746 t2 on t2.id = p.year
left join tagElement_7746 t3 on t3.id = a.country
left join tagElement_7746 t4 on t4.id = a.unwind_cycle
left join tagElement_7746 t5 on t5.id = a.unwind_product_category),




sub3 as (Select d.projectid,d.timerange_timerange,d.num_female,d.num_male,d.training_type,d.year,d.country,d.vendor,d.consultant,d.product_category,
d.cycle, row_number() over (partition by d.projectid,d.country,d.vendor,d.consultant order by cast (d.timerange_timerange.start as DATE) DESC ) as row
from sub1 d
),

sub4 as ( Select e.* from sub3 e 
		 where row = 1 )


Select f.projectid,f.timerange_timerange,f.num_female, f.num_male,
NVL(f.num_female,0)+ NVL(f.num_male,0) as workforce,
f.training_type,f.cycle,f.year,f.country,f.vendor,f.consultant, f.product_category 
from sub4 f
