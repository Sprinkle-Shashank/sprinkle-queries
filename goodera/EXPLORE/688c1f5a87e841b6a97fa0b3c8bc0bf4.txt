
 with t1 as 
(
  select p3.name  as projectId , timerange_timerange,  tag1.name as training_type, num_female, num_male, tag2.name as  year , tag4.name as country, p4.factory, p2.vendor, p2.cycle, p2.product_category,tag6.name as consultant 
from profile_61528 as p1
left join profile_64362 as p2
on p1.projectId = p2.projectId
left join ds_mysql_prod_project p3
on p1.projectId= p3.id
  left join profile_64170 as p4
on p2.factory = p4._id
left join ds_mysql_prod_tagelement tag1
on p1.training_type = tag1.id
left join ds_mysql_prod_tagelement tag2
on p1.year = tag2.id

left join ds_mysql_prod_tagelement tag4
on p2.country = tag4.id
left join ds_mysql_prod_tagelement tag6
on p2.consultant_tag = tag6.id

--order by timerange_timerange DESC
 ),

 sub1  as(select a.*, unwind_cycle from t1 a,a.cycle as unwind_cycle),
 
t2 as( 
  select c.projectId, c.timerange_timerange,  c.training_type, c.num_female, c.num_male, c.year ,c.country, c.factory, c.vendor, c.product_category,c.consultant ,tag3.name as cycle
	  from sub1 c
left join ds_mysql_prod_tagelement tag3
on c.unwind_cycle = tag3.id ),

		  

sub2 as ( Select b.*,unwind_product_category from t2 b , b.product_category as unwind_product_category
		  ),
		 t3 as
		 (select f.projectId, f.timerange_timerange,  f.training_type, f.num_female, f.num_male, f.year ,f.country, f.factory, f.vendor,
		 f.cycle,f.consultant,tag5.name as product_category
		 from sub2 f
		 left join ds_mysql_prod_tagelement tag5 on tag5.id = f.unwind_product_category),
		 
item as
(
select 'num_female' as t
union all
select 'num_male' as t
)
--,

--t4 as
--(
  select  projectId , timerange_timerange,  training_type,  year , factory, vendor, consultant,  cycle,country  ,  product_category , 
case t
when 'num_female' then f.num_female
when 'num_male' then f.num_male
else null
end as workforce,item.t as gender
from t3 cross join item
--)
 

--select projectId, timerange_timerange,training_type,year,factory,vendor,consultant,cycle,country,product_category,gender , gender, --sum(t2.workforce) as workforce
--from t2 
--group by projectId , timerange_timerange,  training_type,  year , factory, vendor, consultant, cycle,country ,  product_category ,gender
--order by timerange_timerange DESC





