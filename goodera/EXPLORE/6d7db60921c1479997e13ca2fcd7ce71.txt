with sub1 as(
  select p1.*, 
  case
  	when IS_ARRAY(p1.other_brand) = FALSE or GET_ARRAY_LENGTH(p1.other_brand) = 0 then ARRAY(p1.other_brand)
  else p1.other_brand
  end as other_brand_new
from profile_78057 p1),

sub2 as(
  select s1.*, other_brand_unwind from sub1 s1, s1.other_brand_new other_brand_unwind)
  
select s2.fy_timerange, t1.name as country, t2.name as currency, p2.name as global_programs, sum(nvl(s2.no_of_reckitt_prods_donated,0) + nvl(p3.reckitt_kits,0)) as products_donated
from sub2 s2

left join ds_mysql_prod_tagelement t1 on t1.id = s2.country
left join ds_mysql_prod_tagelement t2 on t2.id = s2.currency

left join profile_63775 p2 on p2._id = s2.global_program_name
left join profile_78062 p3 on p3._id = s2.other_brand_unwind

group by s2.fy_timerange, t1.name, t2.name, p2.name