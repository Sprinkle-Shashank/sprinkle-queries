with sub1 as(
  select _id as id, vendor_name, vendor_vms_id, factory_name, factory_vms_id, factory_cdms_id, fy_timerange,
extract(year from cast(fy_timerange.start as date)) as year,
dense_rank() over(partition by year order by fy_timerange.start desc) as row
from profile_81459),

sub2 as(
  select * from sub1 where row = 1),
  
sub3 as(
  select vendor_name as vendor, vendor_vms_id, factory_name, factory_vms_id, year, 1 as count
from sub2 s2
group by vendor_name, vendor_vms_id, year, factory_name, factory_vms_id),

---x----

sub4 as(
  select s2.id, s2.vendor_name as vendor, s2.vendor_vms_id, s2.factory_name, s2.factory_cdms_id, p2.source_div, p2.timeperiod_timerange, s2.factory_vms_id,
row_number() over(partition by s2.id order by cast(p2.timeperiod_timerange.start as date) desc) as row
from sub2 s2
left join profile_60928 p2 on p2.factory_id = s2.factory_cdms_id),

sub5 as (
  select * from sub4 where row = 1),

sub6 as(
  select s5.*, source_div_unwind from sub5 s5, s5.source_div source_div_unwind),
  
sub7 as(
  select s6.vendor, s6.vendor_vms_id, s6.factory_name, s6.factory_cdms_id, t1.name as source_div, nvl(t2.name, t1.name) as business_div , s2.factory_vms_id
from sub6 s6
left join ds_mysql_prod_tagelement t1 on t1.id = s6.source_div_unwind
left join ds_mysql_prod_tagelement t2 on t2.id = t1.parent),

sub8 as(
  select s7.vendor, s7.vendor_vms_id, s7.factory_name, s7.factory_vms_id, s7.business_div, p3.brand_text as brand
from sub7 s7
left join profile_81437 p3 on p3.business_division_text = s7.business_div
group by s7.vendor, s7.vendor_vms_id, s7.business_div, p3.brand_text, s7.factory_name, s7.factory_vms_id)

---x----

select * from sub8