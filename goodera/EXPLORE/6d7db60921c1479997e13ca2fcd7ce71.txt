with sub1 as(
  select p1._id as id, p1.cdms_factory_id, p2.cr_tier, p2.curr_cr_rating, p2.region, p2.source_div, p2.timeperiod_timerange, p1.case_status, 
p1.timeperiod_timerange as fy_timerange, 
extract(year from cast(p1.timeperiod_timerange.start as date)) as year,

p1.country_1_number_of_workers_received_payment, p1.country_2_number_of_workers_received_payment, p1.country_3_number_of_workers_received_payment, p1.country_4_number_of_workers_received_payment, p1.country_5_number_of_workers_received_payment, p1.country_6_number_of_workers_received_payment, p1.country_7_number_of_workers_received_payment,

p1.country_1_reimbursed_amount_per_worker_usd,  p1.country_2_reimbursed_amount_per_worker_usd,  p1.country_3_reimbursed_amount_per_worker_usd,  p1.country_4_reimbursed_amount_per_worker_usd,  p1.country_5_reimbursed_amount_per_worker_usd,  p1.country_6_reimbursed_amount_per_worker_usd, p1.country_7_reimbursed_amount_per_worker_usd,

p1.country_1_median_fee_reported_usd, p1.country_2_median_fee_reported_usd, p1.country_3_median_fee_reported_usd, p1.country_4_median_fee_reported_usd, p1.country_5_median_fee_reported_usd, p1.country_6_median_fee_reported_usd, p1.country_7_median_fee_reported_usd,

p1.country_1__migrant_workers_reported_paying_fees, p1.country_2__migrant_workers_reported_paying_fees, p1.country_3__migrant_workers_reported_paying_fees, p1.country_4__migrant_workers_reported_paying_fees, p1.country_5__migrant_workers_reported_paying_fees, p1.country_6__migrant_workers_reported_paying_fees, p1.country_7__migrant_workers_reported_paying_fees,

row_number() over (partition  by p1._id order by p2.timeperiod_timerange.start desc) as row 

from profile_74372 p1

left join profile_60928 p2 on p2.factory_id = p1.cdms_factory_id

where p1.cdms_factory_id is not null and p1.timeperiod_timerange is not null),

sub2 as(
  select * from sub1 where row = 1)
  
select s2.id, s2.cdms_factory_id, nvl(t1.name, 'NULL') as cr_tier_new, 
nvl(t2.name, 'NULL') as curr_cr_rating_new, s2.region, s2.source_div, t3.name as case_status, s2.fy_timerange, s2.year,

s2.country_1_number_of_workers_received_payment, s2.country_2_number_of_workers_received_payment, s2.country_3_number_of_workers_received_payment, s2.country_4_number_of_workers_received_payment, s2.country_5_number_of_workers_received_payment, s2.country_6_number_of_workers_received_payment, s2.country_7_number_of_workers_received_payment,

s2.country_1_reimbursed_amount_per_worker_usd,  s2.country_2_reimbursed_amount_per_worker_usd,  s2.country_3_reimbursed_amount_per_worker_usd,  s2.country_4_reimbursed_amount_per_worker_usd,  s2.country_5_reimbursed_amount_per_worker_usd,  s2.country_6_reimbursed_amount_per_worker_usd, s2.country_7_reimbursed_amount_per_worker_usd,

s2.country_1_median_fee_reported_usd, s2.country_2_median_fee_reported_usd, s2.country_3_median_fee_reported_usd, s2.country_4_median_fee_reported_usd, s2.country_5_median_fee_reported_usd, s2.country_6_median_fee_reported_usd, s2.country_7_median_fee_reported_usd,

s2.country_1__migrant_workers_reported_paying_fees, s2.country_2__migrant_workers_reported_paying_fees, s2.country_3__migrant_workers_reported_paying_fees, s2.country_4__migrant_workers_reported_paying_fees, s2.country_5__migrant_workers_reported_paying_fees, s2.country_6__migrant_workers_reported_paying_fees, s2.country_7__migrant_workers_reported_paying_fees

from sub2 s2

left join ds_mysql_prod_tagelement t1 on t1.id = s2.cr_tier
left join ds_mysql_prod_tagelement t2 on t2.id = s2.curr_cr_rating
left join ds_mysql_prod_tagelement t3 on t3.id = s2.case_status

where cr_tier_new not in ('Exit', 'Deactivated') and 
curr_cr_rating_new not in ('Gray', 'Red', 'White', 'No Rating') 