with lookup as (select *, coalesce(p.submissionlog, array(0)) as sublog, 									coalesce(p.approvallog, array(0)) as applog
				from ds_mongo_taskresponse p
),

lookup1 as (select 
				CAST(p.taskuserid as INT8) as taskuserid1, p._id, p.status, p.active, p.organizationid, p.data, p.projectid, p.profileid, p.profileinstanceid,approval."approverEmail" as email1,approval,approval."approvercomments" as comment1, slog."email" as Data_Entry, slog
				from lookup p, p.applog approval, p.sublog slog
								

),

lookup2 as (select 
				p._id, p.status, p.active, p.organizationid, p.data, task.projectflowid, p.taskuserid1,taskuser.programuserid, taskuser.taskid,p.email1,p.comment1,p.Data_Entry,
				task.flowtaskid,p.profileinstanceid
				from lookup1 p
			
left join ds_mysql_prod_taskuser taskuser on
taskuser.id = p.taskuserid1					
				
						
left join ds_mysql_prod_task task on
task.id = taskuser.taskid
			

),

lookup3 as (select 
			p._id, p.status, p.active, p.organizationid, p.data, p.flowtaskid,p.projectflowid,
			flowtask.sectionid,
			projectflow.projectid,p.profileinstanceid,
			programuser.programid ,p.email1,p.comment1,p.Data_Entry
			from lookup2 p
 			
left join ds_mysql_prod_flowtask flowtask on 
flowtask.id = p.flowtaskid		
			
left join ds_mysql_prod_projectflow projectflow on 
projectflow.id = p.projectflowid
			
left join ds_mysql_prod_programuser programuser on
programuser.id = p.programuserid
),

lookup4 as (select 
			p._id, p.status, p.active, p.organizationid, p.data, flowtaskid, sectionid, 
			section.profileid, section.name,p.projectid,p.programid,p.email1,p.profileinstanceid,p.comment1,p.Data_Entry
			from lookup3 p
  
left join ds_mysql_prod_section section on
section.id = p.sectionid		
)

Select * from lookup4 where (profileid = 54963) and active = 't' and status in ('PENDING_APPROVAL', 'SUBMITTED')
/*with sub1 as(
  select x1._id as id, x1.profileinstanceid, x1.status, x1.active, x1.data, x1.taskuserid, x2.taskid, x5.projectid, x6.profileid, x4.sectionid, x6.name as section, x7.name as profile, x8.name as project, x1.created, x1.modified, x2.status
  
case
  when is_array(x1.submissionlog) = false or get_array_length(x1.submissionlog) = 0 then 
  	   array(x1.submissionlog)
  else x1.submissionlog
end as submissionlog_new,
case
  when is_array(x1.approvallog) = false or get_array_length(x1.approvallog) = 0 then 
  	   array(x1.approvallog)
  else x1.approvallog
end as approvallog_new
  
from ds_mongo_taskresponse x1 

left join ds_mysql_prod_taskuser x2 on x2.id = x1.taskuserid
left join ds_mysql_prod_task x3 on x3.id = x2.taskid
left join ds_mysql_prod_flowtask x4 on x4.id = x3.flowtaskid
left join ds_mysql_prod_projectflow x5 on x5.id = x3.projectflowid
left join ds_mysql_prod_section x6 on x6.id = x4.sectionid
left join ds_mysql_prod_profile x7 on x7.id = x6.profileid
left join ds_mysql_prod_project x8 on x8.id = x5.projectid

where x6.profileid = 54963 and x1.active = 't' 
and x1.status in ('PENDING_APPROVAL', 'SUBMITTED')

group by x1._id, x1.profileinstanceid, x1.status, x1.active, x1.data, x1.taskuserid, x2.taskid, x5.projectid, x6.profileid, x4.sectionid, x6.name, x7.name, x8.name, x1.created, x1.modified, x1.submissionlog, x1.approvallog)

select * from sub1*/