with sub1 as(
  select vendor_name, vendor_vms_id, vendor_region, factory_name, factory_cdms_id, fy_timerange,
dense_rank() over(order by fy_timerange.start desc) as row
from profile_81459),

sub2 as(
  select vendor_name, vendor_vms_id, count(*) as vendor_factories
from sub1 
where row = 2
group by vendor_name, vendor_vms_id),

----xx-----

sub3 as(
  select p1.quarter_timerange as fy_timerange, p2.name as factory, p1.factory_vms_id, p1.cdms_id as factory_cdms_id, p1.factory_country, p3.name as vendor, p1.vendor_vms_id, p1.vendor_region, p1.democratically_elected, p1.cap_democratically_elected, p1.released, p1.cap_released, p1.reaching_out, p1.cap_reaching_out, p1.atypical_representation, p1.cap_atypical_representation, p1.gender_bc, p1.cap_gender_bc, p1.female_rep, p1.cap_female_rep, p1.manager_wmc, p1.cap_manager_wmc, p1.manager_attendance, p1.cap_manager_attendance, p1.meetings_year, p1.cap_meetings_year, p1.all_members, p1.cap_all_members, p1.updated_list, p1.cap_updated_list, p1.minority, p1.cap_minority, p1.role, p1.cap_role, p1.retaliation, p1.cap_retaliation, p1.issues, p1.cap_issues, p1.followup, p1.cap_followup, p1.review, p1.cap_review, p1.alternative, p1.cap_alternative, p1.grievance, p1.cap_grievance, p1.union, p1.cap_union,

dense_rank() over(partition by p2.name, p1.factory_vms_id, p3.name, p1.vendor_vms_id order by p1.quarter_timerange.start desc) as row

from profile_66533 p1
left join profile_81458 p2 on p2._id = p1.factory_new
left join profile_81524 p3 on p3._id = p1.vendor
where p2.name is not null),

sub4 as(
  select * from sub3 where row = 1)
  
select factory, factory_vms_id, factory_cdms_id, factory_country, vendor, vendor_vms_id, vendor_region,
case 
	when (democratically_elected = 1298221 or democratically_elected = 1298224) or 
		 (democratically_elected = 1298222 and len(cap_democratically_elected) > 10) or 
		 (democratically_elected = 1298223 and len(cap_democratically_elected) > 10) 
		 then 1 
	else 0
end as democratically_elected,

case 
	when (released = 1298221 or released = 1298224) or 
		 (released = 1298222 and len(cap_released) > 10) or 
		 (released = 1298223 and len(cap_released) > 10) 
		 then 1 
	else 0
end as released,

case 
	when (reaching_out = 1298221 or reaching_out = 1298224) or 
		 (reaching_out = 1298222 and len(cap_reaching_out) > 10) or 
		 (reaching_out = 1298223 and len(cap_reaching_out) > 10) 
		 then 1 
	else 0
end as reaching_out,

case 
	when (atypical_representation = 1298221 or atypical_representation = 1298224) or 
		 (atypical_representation = 1298222 and len(cap_atypical_representation) > 10) or 
		 (atypical_representation = 1298223 and len(cap_atypical_representation) > 10) 
		 then 1 
	else 0
end as atypical_representation,

case 
	when (gender_bc = 1298221 or gender_bc = 1298224) or 
		 (gender_bc = 1298222 and len(cap_gender_bc) > 10) or 
		 (gender_bc = 1298223 and len(cap_gender_bc) > 10) 
		 then 1 
	else 0
end as gender_bc,

case 
	when (democratically_elected = 1298221 or democratically_elected = 1298224) or 
		 (democratically_elected = 1298222 and len(cap_democratically_elected) > 10) or 
		 (democratically_elected = 1298223 and len(cap_democratically_elected) > 10) 
		 then 1 
	else 0
end as democratically_elected,

case 
	when (democratically_elected = 1298221 or democratically_elected = 1298224) or 
		 (democratically_elected = 1298222 and len(cap_democratically_elected) > 10) or 
		 (democratically_elected = 1298223 and len(cap_democratically_elected) > 10) 
		 then 1 
	else 0
end as democratically_elected,

case 
	when (democratically_elected = 1298221 or democratically_elected = 1298224) or 
		 (democratically_elected = 1298222 and len(cap_democratically_elected) > 10) or 
		 (democratically_elected = 1298223 and len(cap_democratically_elected) > 10) 
		 then 1 
	else 0
end as democratically_elected,

case 
	when (democratically_elected = 1298221 or democratically_elected = 1298224) or 
		 (democratically_elected = 1298222 and len(cap_democratically_elected) > 10) or 
		 (democratically_elected = 1298223 and len(cap_democratically_elected) > 10) 
		 then 1 
	else 0
end as democratically_elected,

case 
	when (democratically_elected = 1298221 or democratically_elected = 1298224) or 
		 (democratically_elected = 1298222 and len(cap_democratically_elected) > 10) or 
		 (democratically_elected = 1298223 and len(cap_democratically_elected) > 10) 
		 then 1 
	else 0
end as democratically_elected,

case 
	when (democratically_elected = 1298221 or democratically_elected = 1298224) or 
		 (democratically_elected = 1298222 and len(cap_democratically_elected) > 10) or 
		 (democratically_elected = 1298223 and len(cap_democratically_elected) > 10) 
		 then 1 
	else 0
end as democratically_elected,

case 
	when (democratically_elected = 1298221 or democratically_elected = 1298224) or 
		 (democratically_elected = 1298222 and len(cap_democratically_elected) > 10) or 
		 (democratically_elected = 1298223 and len(cap_democratically_elected) > 10) 
		 then 1 
	else 0
end as democratically_elected,

case 
	when (democratically_elected = 1298221 or democratically_elected = 1298224) or 
		 (democratically_elected = 1298222 and len(cap_democratically_elected) > 10) or 
		 (democratically_elected = 1298223 and len(cap_democratically_elected) > 10) 
		 then 1 
	else 0
end as democratically_elected,

case 
	when (democratically_elected = 1298221 or democratically_elected = 1298224) or 
		 (democratically_elected = 1298222 and len(cap_democratically_elected) > 10) or 
		 (democratically_elected = 1298223 and len(cap_democratically_elected) > 10) 
		 then 1 
	else 0
end as democratically_elected

from sub4