with sub1 as(
  select p1._id as id, p1.factory_id, p2.cr_tier, p2.source_div, p2.region, p2.curr_cr_rating, p2.timeperiod_timerange,
  
row_number() over (partition by p1._id order by p2.timeperiod_timerange.start desc) as row,
  
extract(year from cast(p1.timeperiod_timerange.start as date)) as year
  
from profile_60928 p1

left join profile_60928 p2 on p2.factory_id = p1.factory_id

where p1.factory_id is not null),

sub2 as(
  select * from sub1 where row = 1)
  
select s2.factory_id, s2.year, s2.source_div, s2.region,
nvl(t1.name, 'NULL')  as cr_tier_new, nvl(t2.name, 'NULL') as cr_rating_new
from sub2 s2 

left join ds_mysql_prod_tagelement t1 on t1.id = s2.cr_tier
left join ds_mysql_prod_tagelement t2 on t2.id = s2.curr_cr_rating

where cr_tier_new not in ('Exit', 'Deactivated')
and cr_rating_new not in ('Gray', 'Red', 'White', 'No Rating') and s2.year > 2019

group by s2.factory_id, s2.year, s2.source_div, s2.region, t1.name, t2.name