with sub1 as(
  select vendor_name, vendor_vms_id, vendor_region, factory_name, factory_cdms_id, fy_timerange,
dense_rank() over(order by fy_timerange.start desc) as row
from profile_81459),

sub2 as(
  select vendor_name, vendor_vms_id, count(*) as vendor_factories
from sub1 
where row = 2
group by vendor_name, vendor_vms_id)

----xx-----

select p1.quarter_timerange as fy_timerange, p2.name as factory, p1.cdms_id, p1.factory_country, p3.name as vendor, p1.vendor_vms_id, p1.vendor_region, p1.democratically_elected, p1.cap_democratically_elected, p1.released, p1.cap_released, p1.reaching_out, p1.cap_reaching_out, p1.atypical_representation, p1.cap_atypical_representation, p1.gender_bc, p1.cap_gender_bc, p1.female_rep, p1.cap_female_rep, p1.manager_wmc, p1.cap_manager_wmc, p1.manager_attendance, p1.cap_manager_attendance, p1.meetings_year, p1.cap_meetings_year, p1.all_members, p1.cap_all_members, p1.updated_list, p1.cap_updated_list, p1.minority, p1.cap_minority, p1.role, p1.cap_role, p1.retaliation, p1.cap_retaliation, p1.issues, p1.cap_issues, p1.followup, p1.cap_followup, p1.review, p1.cap_review, p1.alternative, p1.cap_alternative, p1.grievance, p1.cap_grievance, p1.union, p1.cap_union
from profile_66533 p1
left join profile_81458 p2 on p2._id = p1.factory_new
left join profile_81524 p3 on p3._id = p1.vendor
where p2.name is not null