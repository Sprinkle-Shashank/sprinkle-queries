with sub1 as(
  select _id as id, vendor_name, vendor_vms_id, factory_name, factory_vms_id, factory_cdms_id, fy_timerange,
extract(year from cast(fy_timerange.start as date)) as year,
dense_rank() over(partition by year order by fy_timerange.start desc) as row
from profile_81459
where factory_vms_id is not null),

sub2 as(
  select * from sub1 where row = 1),
  
sub3 as(
  select vendor_name as vendor, vendor_vms_id, year, 1 as count
from sub2 s2
group by vendor_name, vendor_vms_id, year)

---x---

select s2.id, s2.vendor_name as vendor, s2.vendor_vms_id, s2.factory_name, s2.factory_cdms_id, p2.source_div, p2.timeperiod_timerange,
row_number() over(partition by s2.id order by cast(p2.timeperiod_timerange.start as date) desc) as row
from sub2 s2
left join profile_60928 p2 on p2.factory_id = s2.factory_cdms_id