with sub1 as(
  select x1._id as id, x1.profileinstanceid, x1.status, x1.active, x1.data, x1.taskuserid, x2.taskid, x5.projectid, x6.profileid, x4.sectionid, x6.name as section, x7.name as profile, x8.name as project,
  
case
  when is_array(x1.submissionlog) = false or get_array_length(x1.submissionlog) = 0 then 
  	   array(x1.submissionlog)
  else x1.submissionlog
end as submissionlog_new,
case
  when is_array(x1.approvallog) = false or get_array_length(x1.approvallog) = 0 then 
  	   array(x1.approvallog)
  else x1.approvallog
end as approvallog_new,
  
case
  when x1.status = 'SUBMITTED' then
  	   case 
  			when x1.profileinstanceid is not null or x1.profileinstanceid != ' ' then 1
  	   		else 0
  	   end
  else 1
end as flag
  
from ds_mongo_taskresponse x1 

left join ds_mysql_prod_taskuser x2 on x2.id = x1.taskuserid
left join ds_mysql_prod_task x3 on x3.id = x2.taskid
left join ds_mysql_prod_flowtask x4 on x4.id = x3.flowtaskid
left join ds_mysql_prod_projectflow x5 on x5.id = x3.projectflowid
left join ds_mysql_prod_section x6 on x6.id = x4.sectionid
left join ds_mysql_prod_profile x7 on x7.id = x6.profileid
left join ds_mysql_prod_project x8 on x8.id = x5.projectid

where x6.profileid = 54963 and x1.active = 't' and flag = 1
and x1.status in ('PENDING_APPROVAL', 'SUBMITTED')), 

sub2 as(
  select s1.id, split_part(p2.name, '|', 1) as projectcode, s1.approvallog_new, t1.name as fy, t2.name as month, p1.subcat_output, 1 as total_count, p2.parent, p2.name, p4.name, split_part(p3.name, '|', 1) as p3x, p4.project_manager as project_manager_27396,

case
	when p2.parent = 18943 then split_part(p2.name, '|', 2)
	else split_part(p2.name, '|', 4)
end as project_name,
  
case
  	when p1.subcat_output is not null then 1 
 	else 0
end as subcat_not_null

from sub1 s1

left join profile_54963 p1 on p1._id = s1.profileinstanceid
left join ds_mysql_prod_project p2 on p2.id = s1.projectid 
left join ds_mysql_prod_project p3 on p3.id = p2.parent

left join ds_mysql_prod_tagelement t1 on t1.id = p1.fy
left join ds_mysql_prod_tagelement t2 on t2.id = p1.month
  
left join profile_27396 p4 on p4.name = split_part(p3.name, '|', 1))

select * from sub2