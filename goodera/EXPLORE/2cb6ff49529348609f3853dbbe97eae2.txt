


with t1 as
(SELECT * 
FROM
(Select   projectId, fy_timerange, twopc, setoff_amount, setoff_amount_preceeding, surplus_previousfy, actual_csr, overhead_expense, impact_assessment, unspent_account, netprofit, (twopc+surplus_previousfy+setoff_amount) as total_csr_obligation, ( COALESCE(actual_csr, 0 )+COALESCE(overhead_expense,0)+COALESCE(impact_assessment,0)) as total_amount_current,  case when (COALESCE(actual_csr,0)+COALESCE(overhead_expense,0)+COALESCE(impact_assessment,0)-COALESCE(twopc,0))<=0 then 0 else (COALESCE(actual_csr,0)+COALESCE(overhead_expense,0)+COALESCE(impact_assessment,0)-COALESCE(twopc,0)) end as excess_current,  case when (COALESCE(actual_csr,0)+COALESCE(overhead_expense,0)+COALESCE(impact_assessment,0)-COALESCE(twopc,0)-COALESCE(surplus_previousfy,0))<=0 then 0 else (COALESCE(actual_csr,0)+COALESCE(overhead_expense,0)+COALESCE(impact_assessment,0)-COALESCE(twopc,0)-COALESCE(surplus_previousfy,0)) end  as setoff_succeed from profile_77139 p 


)
UNPIVOT (
    val FOR dim IN (total_amount_current,actual_csr))

)

select  projectid,fy_timerange,val,dim from t1 as p

Group By projectid,fy_timerange,val,dim
  
  
  