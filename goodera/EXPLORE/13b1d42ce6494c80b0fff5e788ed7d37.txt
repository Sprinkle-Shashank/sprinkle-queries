with sub1 as(
  select p1.grantproposalid, p1.createddate, p1.date_of_entry, p1.metrics_1, p1.metrics_2,
  
case
  	when p1.metrics_2 is null then p1.metrics_1
  	else p1.metrics_2
end as metrics_final
  
from profile_43726 p1),

sub2 as(
  select s1.grantproposalid as grantproposalid_1, s1.date_of_entry, s1.createddate, coun.progress as progress_1, coun.uom 
from sub1 as s1, unpivot s1.metrics_final as coun),

sub3 as(
  select p2.grantproposalid, p2.createddate, p2.date_of_entry, p2.metrics_1, p2.metrics_2,
  
case
  	when p2.metrics_2 is null then p2.metrics_1
  	else p2.metrics_2
end as metrics_final
  
from profile_43728 p2),

sub4 as(
  select s3.grantproposalid  as grantproposalid_2 , s3.date_of_entry, s3.createddate, coun2.progress as progress_2, coun2.uom 
from sub3 as s3, unpivot s3.metrics_final as coun2),
  
sub5 as(
  
  select 

case
	when s2.grantproposalid_1 = s4.grantproposalid_2 then s4.progress_2
	else s2.progress_1
end as progress_final,

case
	when s2.grantproposalid_1 = s4.grantproposalid_2 then s4.uom
	else s2.uom
end as uom_final,

case
	when s2.grantproposalid_1 = s4.grantproposalid_2 then s4.date_of_entry
	else s2.date_of_entry
end as date_of_entry_final,

case
	when s2.grantproposalid_1 = s4.grantproposalid_2 then s4.createddate
	else s2.createddate
end as createddate_final,

case
	when s2.grantproposalid_1 = s4.grantproposalid_2 then s4.grantproposalid_2
	else s2.grantproposalid_1
end as grantproposalid_final

from sub2 s2
left join sub4 s4 on s2.grantproposalid_1 = s4.grantproposalid_2)

select grantproposalid_final as grantproposalid, 

case
	 when date_of_entry_final is null then createddate_final
	 else date_of_entry_final
end as date_final,


extract(year from date_final) as year_final, uom_final as uom, progress_final as progress

from sub5
where uom_final in (629186, 629160, 629176, 629174)