with x as (select xprojectid,fy_timerange, financialperiod,datatablebase from sus_9539 where keyword in ('third_party_fleet')
		   and datatablebase is not null and status='APPROVED'),
		   
temp2 as (select * ,temp1.fuel_third, temp1.fuel_consump_third,
		  temp1.dist_third, case
		  	when IS_ARRAY(temp1.fuel_third) = false or GET_ARRAY_LENGTH(temp1.fuel_third) = 0 then ARRAY(temp1.fuel_third)
		  else temp1.fuel_third
		  end as fuel_third_new
		   
		  from x as temp,
		  unpivot temp.datatablebase as temp1 at row),
		  
 y as (select xprojectid,financialperiod,fy_timerange,datatablebase,fuel_third,fuel_consump_third,dist_third from 
		temp2 ytemp,ytemp.fuel_third_new as fuel_third),
		
 z as (select xprojectid,fy_timerange,d1.name  as fuel, dist_third,
	   case d1.name when 'Petrol' then 0.000271
                                   when 'Diesel' then 0.000218
	                               else   0
	                               end  as mf,
	  coalesce(dist_third,0)*mf as Transport_Emissions--fuel_consump_third as Transport_Consumption
	   
from y 
 left join ds_mysql_prod_tagelement d1
on d1.id=y.fuel_third) 
		  
select * from z