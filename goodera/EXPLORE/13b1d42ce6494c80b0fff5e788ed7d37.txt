with sub1 as(
  select p1._id as id, p1.timerange_timerange, p1.year, p1.turnover, substring(p1.name, len(p1.name) - 9, 10) as month,

case
	when IS_ARRAY(p3.product_category) = FALSE or GET_ARRAY_LENGTH(p3.product_category) = 0 then ARRAY(p3.product_category)
	else p3.product_category
end as product_category_new,

case
	when IS_ARRAY(p3.cycle) = FALSE or GET_ARRAY_LENGTH(p3.cycle) = 0 then ARRAY(p3.cycle)
	else p3.cycle
end as cycle_new,

p3.country, p3.vendor, p4.name as consultant
from profile_61528 p1

left join profile_64362 p3 on p3.projectid = p1.projectid
left join profile_61583 p4 on p4._id = p3.consultant

where p1.training_type = 1411055 and p1.turnover is not null),

sub2 as(
  select s1.*, cycle_unwind, product_category_unwind 
from sub1 s1, s1.cycle_new cycle_unwind, s1.product_category_new product_category_unwind)

select s2.id, s2.timerange_timerange, s2.month, s2.vendor, s2.consultant, t1.name as country, t2.name as cycle, t3.name as product_category, sum(s2.turnover) as turnover
from sub2 s2

left join ds_mysql_prod_tagelement t1 on t1.id = s2.country
left join ds_mysql_prod_tagelement t2 on t2.id = s2.cycle_unwind
left join ds_mysql_prod_tagelement t3 on t3.id = s2.product_category_unwind

group by s2.id, s2.timerange_timerange, s2.month, s2.vendor, s2.consultant, t1.name, t2.name, t3.name