with sub1 as(
  select p1._id as id, p1.timeperiod_timerange, p1.factory_name, p1.source_div, t1.name as cr_tier, p1.facility_type, p1.region, t2.name as curr_cr_rating, 

extract(month from cast(p1.timeperiod_timerange.start as DATE)) as start_month,
extract(year from cast(p1.timeperiod_timerange.start as DATE)) as start_year

from profile_60928 p1

left join tagElement_7200 t1 on t1.id = p1.cr_tier
left join tagElement_7200 t2 on t2.id = p1.curr_cr_rating

where start_month = 11 and start_year = 2022) ),--and t1.name in ('1','2')),

sub2 as(
  select s1.*, facility_type_unwind
  from sub1 s1, s1.facility_type facility_type_unwind),
  
sub3 as (
  select s2.id, s2.factory_name, s2.source_div, s2.cr_tier, listagg(t3.name, ', ') as facility_type_new, s2.region, s2.curr_cr_rating,

STRPOS(facility_type_new, 'RMG') as rmg_pos, STRPOS(facility_type_new, 'Mill') as mill_pos, STRPOS(facility_type_new, 'Trim') as trim_pos, STRPOS(facility_type_new, 'Tannery') as tannery_pos,

(rmg_pos + mill_pos + trim_pos + tannery_pos) as facility_filter

from sub2 s2

left join tagElement_7200 t3 on t3.id = s2.facility_type_unwind

group by s2.id, s2.factory_name, s2.source_div, s2.cr_tier, s2.region, s2.curr_cr_rating)

select * from sub3 where facility_filter > 0