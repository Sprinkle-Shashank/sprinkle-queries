with sub1 as(
  select p1._id as id, p2.name as projectid, p1.timerange_timerange, t1.name as year, p1.absenteeism_rate, substring(p1.name, len(p1.name) - 9, 10) as month, t2.name as country, p3.vendor, p4.name as consultant,

case
	when IS_ARRAY(p3.cycle) = FALSE or GET_ARRAY_LENGTH(p3.cycle) = 0 then ARRAY(p3.cycle)
	else p3.cycle
end as cycle_new,
case
	when IS_ARRAY(p3.product_category) = FALSE or GET_ARRAY_LENGTH(p3.product_category) = 0 then ARRAY(p3.product_category)
	else p3.product_category
end as product_category_new

from profile_61528 p1
left join ds_mysql_prod_project p2 on p2.id = p1.projectid
left join profile_64362 p3 on p3.projectid = p1.projectid
left join profile_61583 p4 on p4._id = p3.consultant

left join ds_mysql_prod_tagelement t1 on t1.id = p1.year
left join ds_mysql_prod_tagelement t2 on t2.id = p3.country
where p1.training_type = 1411055 and p1.absenteeism_rate is not NULL),

sub2 as(
  select s1.*, cycle_unwind, product_category_unwind from sub1 s1, s1.cycle_new cycle_unwind, s1.product_category_new product_category_unwind)
  
select s2.id, s2.projectId, s2.timerange_timerange, s2.year, s2.vendor, s2.country, t3.name as cycle, t4.name as product_category, s2.month, s2.consultant, sum(s2.absenteeism_rate) as absenteeism_rate
from sub2 s2
group by s2.id, s2.projectId, s2.timerange_timerange, s2.year, s2.vendor, s2.country, t3.name, t4.name, s2.month, s2.consultant