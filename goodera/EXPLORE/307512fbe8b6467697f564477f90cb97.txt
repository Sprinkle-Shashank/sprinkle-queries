with sub1 as(
  select p2.name as project, p1.fy_timerange, t1.name as document_type, p1.file
from profile_79395 p1
left join ds_mysql_prod_project p2 on p2.id = p1.projectid
left join ds_mysql_prod_tagelement t1 on t1.id = p1.document_type),

sub2 as(
  select p4.name as project, p3.fy_timerange, cast('FUCs' as VARCHAR) as document_type, p3.utilization_certificate as file
from profile_2679 p3
left join ds_mysql_prod_project p4 on p4.id = p3.projectid),

sub3 as(
  select project, fy_timerange, document_type, file from sub1
  union all
  select project, fy_timerange, document_type, file from sub2),
  
sub4 as(
  select s3.project, s3.fy_timerange, s3.document_type, s3.file,

case
	when s3.document_type = 'MOU' then s3.file
	else null
end as mou_file,
case
	when s3.document_type = 'Proposals' then s3.file
	else null
end as proposals_file,
case
	when s3.document_type = 'PPRs' then s3.file
	else null
end as pprs_file,
case
	when s3.document_type = 'FUCs' then s3.file
	else null
end as fucs_file

from sub3 s3),

sub5 as(
  select s4.project, s4.fy_timerange, mou_file_new, proposals_file_new, pprs_file_new, fucs_file_new
from sub4 s4, s4.mou_file, s4.proposals_file, s4.pprs_file, s4.fucs_file)

select s5.project, s5.fy_timerange, listagg(distinct s5.mou_file_new, ',')
from sub5 s5
group by s5.project, s5.fy_timerange
