with table1 as 
(select p.* , fac.name as factory , ven.name as vendor , cou.name as country , extract(year from date) as year ,  case when extract(month from date)=1 then (extract(year from date)-1)
else extract(year from date) end as year_first_update  from profile_64801 as p

left join ds_mysql_prod_project fac 
on p.projectId = fac.id

 left join ds_mysql_prod_project ven 
on fac.parent = ven.id

 left join ds_mysql_prod_project cou 
on ven.parent = cou.id),

 table3 as
(
select p.projectid, p.facility_status , facility.name as facility_status_update , case when facility_status_update='Active' then 'Active' when facility_status_update='Deactivated' then 'Deactive' end as Active_Filter , goodera_facility_name_text from profile_68161 as p
  
left join ds_mysql_prod_tagelement facility 
on p.facility_status = facility.id
)

select p.projectid , factory ,vendor , country , year_first_update as year , num_middle  from table1 p

left join table3 t3 on
p.factory = t3.goodera_facility_name_text