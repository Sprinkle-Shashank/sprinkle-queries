with table1 as(select * from profile_58474),

table2 as (select t1.*, diagno1 from table1 t1 , t1.diagnosis1 as diagno1 ),

table4 as
( select * , Decode(p.reg_date_yn,28005,CONVERT(timestamp,SUBSTRING(p.date_y,1,10)),Convert(timestamp,SUBSTRING(p.reg_date,1,10))) as datefrom , p5.name as gender , p6.name as referred_yn , SUBSTRING(p3.name,0,CHARINDEX('-',p3.name)) as disease , p3.name as full_disease_name,
CAST(DATEDIFF(year,createddate,GETDATE())+age AS FLOAT) as final_age,
CASE 
when final_age >=0 and final_age<=5 then '0-5'
when final_age >=6 and final_age<=18 then '6-18'
when final_age >=19 and final_age<=40 then '19-40'
when final_age >=41 and final_age<=60 then '41-60'
when final_age >60  then 'more than 60'
end as age_category,
case when disease is  null or disease = '' then 0 else 1 end as count ,  row_number() over 
(partition by p.projectid
 order by p._id desc) as row  from table2 as p2
 
left join ds_mysql_prod_tagelement p3
on p2.diagno1=p3.id
  
left join ds_mysql_prod_tagelement p4
on p2.diagnosis2=p4.id
  
left join ds_mysql_prod_tagelement p5
on p.gender=p5.id
  
left join profile_58473 p
on p2.patient = p._id
 
left join ds_mysql_prod_tagelement p6
on p.referred_yn=p6.id

where disease is not null
 ),

 

table3 as
(
select p._id,p5.name as gender,p6.name as referred_yn, age, Decode(reg_date_yn,28005,CONVERT(timestamp,SUBSTRING(date_y,1,10)),Convert(timestamp,SUBSTRING(reg_date,1,10))) as date,createddate,SUBSTRING(p3.name,0,CHARINDEX('-',p3.name)) as disease,p3.name as full_disease_name,
CAST(DATEDIFF(year,createddate,GETDATE())+age AS FLOAT) as final_age,
CASE 
when final_age >=0 and final_age<=5 then '0-5'
when final_age >=6 and final_age<=18 then '6-18'
when final_age >=19 and final_age<=40 then '19-40'
when final_age >=41 and final_age<=60 then '41-60'
when final_age >60  then 'more than 60'
end as age_category,
case when disease is  null or disease = '' then 0 else 1 end as count ,  row_number() over 
(partition by p.projectid
 order by p._id desc) as row

from profile_58473 p
  
left join table2 p2
on p._id=p2.patient
  
left join ds_mysql_prod_tagelement p3
on p2.diagno1=p3.id
  
left join ds_mysql_prod_tagelement p4
on p2.diagnosis2=p4.id
  
left join ds_mysql_prod_tagelement p5
on p.gender=p5.id
  
left join ds_mysql_prod_tagelement p6
on p2.referred_yn=p6.id

where disease is not null

)

select * from table4 where row=1

--where date between '2022-04-01' and '2022-05-19'
--group by p3.name,p4.name,p.createddate,p._id,p.age,p2.diagnosis1,p2.diagnosis2




/*select p2.name,p3.name from profile_58474 p
left join ds_mysql_prod_tagelement p2
on p.diagnosis1=p2.id
left join ds_mysql_prod_tagelement p3
on p.diagnosis2=p3.id
LEFT JOIN Profile_*/


