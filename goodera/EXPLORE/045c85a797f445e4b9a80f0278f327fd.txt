with table1 as 
(
select p.projectid , substring(createddate,1,10) as createddate_update_1 , cast(createddate_update_1 as date) as create_1 from profile_18299 as p ),

table2 as 
(
select p.projectid , substring(createddate,1,10) as createddate_update_2 ,  t1.create_1 , cast(createddate_update_2 as date) as create_2 , datediff(day,create_1, current_date) as f1 ,  datediff(day, create_2 , current_date) as f2 , case when f1>f2 then create_1 else create_2 end as oldest_submission_date , row_number() over (partition by p.projectid order by p._id) as row from profile_18224 as p

left join table1 t1 on 
p.projectid = t1.projectid 
),

table3 as
( select p.projectid , p.sub_unit , s1.name_subunit as sub_unit_18224 from profile_18224 as p 
 
left join profile_16619 s1 on 
 p.sub_unit = s1._id
 
 ),
 
 table4 as 
 ( select p.projectid , name_subunit, 1 as count , row_number() over (partition by p.projectid order by p._id) as row from profile_16619 as p
  
  left join table3 t3 on 
  p.projectid = t3.projectid
  
  where name_subunit = t3.sub_unit_18224
 ),
 
 table6 as 
 ( select * from table4 where row=1 ),
 
 table5 as 
 ( select p.projectid , name_subunit, 1 as count from profile_16619 as p
  
  left join table3 t3 on 
  p.projectid = t3.projectid
  
  where name_subunit is null 
  
  group by p.projectid , name_subunit , count
 ),

table7 as 
( select p.projectid from profile_16619 as p 
 
 left join table6 t6 on 
 p.projectid = t6.projectid 
 )
 
select * from table5 

 
  /*
  , datediff(day, CURRENT_DATE , createddate_update_1) as num 
  --sub_unit
  
   p.sub_unit 
   
left join profile_16619 s1 on 
 p.sub_unit = s1._id
  
  */