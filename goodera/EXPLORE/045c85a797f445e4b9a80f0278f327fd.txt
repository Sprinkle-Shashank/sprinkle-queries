
with table1 as ( select _id ,projectid, pro.name as factory,pace_status as facility_status,row_number() over 
(partition by projectid
 order by _id desc) as row from profile_54267 p
		left join ds_mysql_prod_project as pro
on p.projectid = pro.id	   ),


table2 as ( select * from table1 
		  where row = 1),
		  

factory_locationid as (
  with 
table1 as ( select  p._id, p.projectid,q.factory_vpid as location_id,
		   row_number() over 
           (partition by p._id
            order by p._id desc) as row,r.cp_location_id,q.pace_status_2 from  profile_4227 p
				  left join profile_52713 q on
                  p.projectid = q.projectid
		          left join profile_4948 r on
		          p.projectid = r.projectid
		          left join ds_mysql_prod_project as pro
                  on p.projectid = pro.id
		          where  location_id is not null and cp_location_id is null
  ),
  
table2 as (select p._id,p.projectid,q.cp_location_id as location_id,q.pace_status_2 from profile_4227 p
		   left join profile_4948 q on
		   p.projectid = q.projectid
		  where  location_id is not null
		  ),
  
 table3 as ( 
select * from table1  
 where row = 1)
 select _id,projectid,location_id,pace_status_2 from table3
 union all
  select _id,projectid,location_id,pace_status_2 from table2
  /* 99 factories are not there in add_factory*/
),


table11 as 
(
  select p.projectid , p._id , name_country ,name_vendor , name_rp , name_factory , name_vendor_filter , p4.pace_status from profile_54646 p
  
left join profile_4948 p4 on 
p.projectid = p4.projectid
),

table21 as 
(
  select p.projectid , p._id , name_event , p.date , type_event , other_event , event_description , type_influencer , duration_event , attend ,  t1.name_country , t1.name_vendor , t1.name_rp , t1.name_factory , t1.name_vendor_filter , t1.pace_status from profile_4724 p
  
  left join table11 t1 on 
  p.projectid = t1.projectid
 ),
 
 
user_email as ( SELECT mon._id,mon.creatorid, u.email as cemail, mon.modifierid, m.email as memail
from ds_mongo_profileinstance mon
			   
left join ds_mysql_prod_user u on
mon.creatorid = u.id
			   
left join ds_mysql_prod_user m  on
mon.modifierid = m.id
			   
where mon.profileId='4724' and mon.active = 't' and mon.securitycontextid is not null
			 )
  

select p.*, use.cemail from table21 p

left join user_email use on 
p._id = use._id

