with tab1 as(
select p2.name as projectId, p3.trucker_id,t1.name as city,t2.name as state,first(cast(p1.date_visit) as datetime)as fy_timerange,ttt.code as map_code,first(q.name) as clinic from profile_73098 p1
left join ds_mysql_prod_project p2 on
p2.id= p1.projectId
left join profile_73096 p3 on
p3._id=p1.trucker_id
left join profile_73150 q on
q._id=p1.clinic
left join ds_mysql_prod_tagelement t on
t.id=q.states
left join ds_mysql_prod_tagelement t1 on
t.parent=t1.id
left join ds_mysql_prod_tagelement t2 on
t1.parent=t2.id
left join ds_mongo_reftagelementmetadata ttt
on t2.reftagelementmetadataid=ttt._id
where t2.name is not null
group by  p2.name, p3.trucker_id,t1.name,t2.name,ttt.code,p1.date_visit,q.name)
--order by p1.date_visit
select s.projectId as clinic_type,s.fy_timerange,s.map_code,count(*) as beneficiaries from tab1 s
group by clinic_type, fy_timerange, map_code
