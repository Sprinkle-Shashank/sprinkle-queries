with sub1 as(
select fy_timerange, promotions, p1.project_id, promotions_1, p2.pvh_id, p3.timeperiod_timerange, rtrim(ltrim(json_serialize(p3.region),'['),']') as region
from profile_62491 p1
left join profile_62948 p2
on p1.project_id=p2.project_id
left join profile_60928 p3
on p2.pvh_id=p3.factory_id),
sub2 as(
  select fy_timerange, promotions, promotions_1, pvh_id,
  first_value(region)
over(partition by fy_timerange, promotions, promotions_1, pvh_id
order by cast(timeperiod_timerange.start as date) desc
rows between unbounded preceding and unbounded following) as region from sub1),
sub3 as(
  select fy_timerange, promotions, promotions_1, pvh_id, region from sub2
  group by fy_timerange, promotions, promotions_1, pvh_id)
  select * from sub3