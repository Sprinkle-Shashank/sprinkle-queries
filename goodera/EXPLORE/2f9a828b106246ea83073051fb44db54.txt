with sub1 as (select p1.name as projectid,t1.name as financial_period, datatablebase, tablesettings, questiontext, fy_timerange, 

from sus_56551 p1
left join ds_mysql_prod_tagelement t1 on t1.id=p1.financialperiod
where keyword='gri_water_withdrawal_details'),

sub2 as (select *,temp.consumption,cast(temp.quality as varchar),cast(temp.importance_local as varchar) from sub1 s1,unpivot s1.datatablebase as temp at source)

select projectid, financial_period, consumption, quality, importance_local, questiontext, fy_timerange, (Initcap(split_part(source, '_', 1)) || ' ' || split_part(source, '_', 2)) as source_text,('FY' || ' ' || split_part(financialperiod, ' ', 2) as FY,
case
when source='ground_water' then cast(tablesettings."ground_water"."consumption"."measureUnitBase" as VARCHAR)
when source='purchased_water' then cast(tablesettings."purchased_water"."consumption"."measureUnitBase" as VARCHAR)
when source='surface_water' then cast(tablesettings."surface_water"."consumption"."measureUnitBase" as VARCHAR)
when source='rain_water' then cast(tablesettings."rain_water"."consumption"."measureUnitBase" as VARCHAR)
when source='sea_water' then 
cast(tablesettings."sea_water"."consumption"."measureUnitBase" as VARCHAR)
when source='river_water' then cast(tablesettings."river_water"."consumption"."measureUnitBase" as VARCHAR)
when source='municipal_water' then cast(tablesettings."municipal_water"."consumption"."measureUnitBase" as VARCHAR)
else null
end as units
from sub2
where source is not null
group by projectid, financial_period,source_text,consumption, quality, importance_local,questiontext,fy_timerange,source,units
--switch(month(dateFromString($fy_timerange.start)),case(1,January),case(2,February),case(3,March),case(4,April),case(5,May),case(6,June),case(7,July),case(8,August),case(9,September),case(10,October),case(11,November),case(12,December) )