with tab1 as (select cast(q.name as varchar) as project_code,f.name as fy,m.name as manager
from profile_27420 d
left join ds_mysql_prod_tagelement f on
d.fy=f.id
left join ds_mysql_prod_tagelement m on
d.project_manager=m.id
left join profile_27396 q on
d.project_code=q._id
		   
union all
		   
select cast(c.name as varchar)as project_code,f.name as fy,m.name as manager 
from profile_27396 c	
left join ds_mysql_prod_tagelement f on
c.fy=f.id
left join ds_mysql_prod_tagelement m on
c.project_manager=m.id
where manager is not null
group by project_code,f.name,m.name),

tab2 as(select distinct(k.village),split_part(prod.name,'|',3) as CensusCode, cast(q.name as varchar) project_code,q1.name as fy,sum(p.total_cost_yearly) as Total_Direct_Budget, sum(p.hdfc_cost_yearly) as HDFC_Bank_Contribution, sum(p.gov_cost_yearly) as Government_Contribution, sum(p.comm_cost_yearly) as Community_Contribution_by_fy from profile_29973 p 
left join profile_27396 q
on q._id=p.prj_code
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement q1 on
q1.id=p.fy
left join profile_27489 k on
split_part(prod.name,'|',3)=k.name
group by project_code,q1.name,split_part(prod.name,'|',3),k.village)

select distinct(t2.village),t1.project_code,t1.fy,t1.manager,t2.Total_Direct_Budget,t2.HDFC_Bank_Contribution,t2.Government_Contribution,t2.Community_Contribution_by_fy from tab1 t1
left join tab2 t2 on
t1.project_code=t2.project_code
group by t1.fy,t1.project_code,t1.manager,t2.village,t2.Total_Direct_Budget,t2.HDFC_Bank_Contribution,t2.Government_Contribution,t2.Community_Contribution_by_fy