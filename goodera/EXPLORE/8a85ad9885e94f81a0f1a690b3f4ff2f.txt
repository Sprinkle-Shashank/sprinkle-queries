
with table1 as
( select p.batch, man_scan_work, p.state , p1.fy as name_update , sta.name as state_update, 'man' as man,
 CASE when man_scan_work = 476506 
then 1 else 0 end as sca
 from profile_30527 as p
 
 left join profile_30532 p1 on
 p.batch = p1._id
 
 left join ds_mysql_prod_tagelement sta 
 on p.state = sta.id 
 
 where man_scan_work in ('476506','476507')
 ),
 
  table2 as
 (
    select state_update, sum(sca) as num , man, name_update, count(name_update) as den from table1
  
  ),
  table3 as
 (
   select state_update, name_update, man, (num/den)*100 as percentage, avg(percentage) as percentage from table2
   
   group by state_update , name_update, man
   
   order by name_update asc
   )
 select state_update, name_update, man, percentage from table3
 