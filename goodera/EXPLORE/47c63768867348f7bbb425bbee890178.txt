with t1 as
(SELECT * 
FROM
(select t.projectId, ngo, schedule_vii, local_yn, t.fy_timerange,  COALESCE(CAST(t.project_end_date as char),'') as endd, t.project_start_date as start,imp_direct, csr_reg_num, state_district, ongoing,
concat(concat(SUBSTRING(t.project_start_date, 1, 10),'-'),SUBSTRING(t.project_end_date, 1, 10)) as fy_timerange1,
 

 
 sum(p2.prescribed_csr) as allocated, sum(p3.amount) as disbursed,sum(p4.amount) as utilized,
 sum(p3.amount)-sum(p4.amount) as unspent from profile_46325 t

left join profile_76972 p2
on p2.projectid=t.projectid

left join profile_76976 p3
on p3.projectid=t.projectid

left join profile_76977 p4
on p4.projectid=t.projectid

where ongoing is not null 


group by t.projectId, ngo, schedule_vii, local_yn, t.fy_timerange,start,endd, imp_direct,t.project_end_date, csr_reg_num, state_district, ongoing

order by t.fy_timerange desc
)
UNPIVOT (
    val FOR dim IN (allocated,disbursed,utilized,unspent))

),



table1 as(select projectId,ngo, schedule_vii, case when local_yn IS TRUE THEN 'YES' else 'NO' end as local_yn, fy_timerange1,
 endd,start,imp_direct, csr_reg_num, state_district, ongoing,sum(val) as val,dim,fy_timerange from t1
		 Group By projectId, fy_timerange, Dim,ngo, schedule_vii, local_yn, fy_timerange1, endd,start,imp_direct, csr_reg_num, state_district, ongoing
		 ),

table2 as (select t11.*,state_distric from t1 t11 , t11.state_district as state_distric),

tab3 as (select  projectId,ngo, schedule_vii, case when local_yn='true' THEN 'YES' else 'NO' end as local_yn, fy_timerange1, endd,table2.start,case when imp_direct IS TRUE THEN 'YES' else 'NO' end as imp_direct, csr_reg_num,cast(state_distric AS INT) as state_distri,case when ongoing IS TRUE THEN 'YES' else 'NO' end as   ongoing,sum(val) as val,dim,fy_timerange  from table2



Group By projectId, state_distric,fy_timerange, fy_timerange1,Dim,ngo, schedule_vii, local_yn,  endd,table2.start,imp_direct, csr_reg_num,  ongoing),

tab4 as(
select   projectId,ngo, schedule_vii, case when local_yn='true' THEN 'YES' else 'NO' end as local_yn, fy_timerange1, endd,tb.start,case when imp_direct='true' THEN 'YES' else 'NO' end as imp_direct, csr_reg_num, t.name as state_district,t2.name as state,case when ongoing ='true' THEN 'YES' else 'NO' end as   ongoing,sum(val) as val,dim,fy_timerange  from tab3 tb

left join ds_mysql_prod_tagelement t on t.id=tb.state_distri
left join ds_mysql_prod_tagelement t2 on t2.id=t.parent

Group By projectId, fy_timerange, Dim,ngo, schedule_vii, local_yn, fy_timerange1, endd,tb.start,imp_direct, csr_reg_num,  ongoing ,t.name,t2.name)

select   projectId,ngo, schedule_vii, case when local_yn='true' THEN 'YES' else 'NO' end as local_yn, fy_timerange1, fy_timerange1,endd,tb.start,case when imp_direct='true' THEN 'YES' else 'NO' end as imp_direct, csr_reg_num, LISTAGG(state_district,',') as state_district,listagg(state,',') as state,case when ongoing ='true' THEN 'YES' else 'NO' end as   ongoing,sum(val) as val,dim  from tab4 tb

Group By projectId, fy_timerange, Dim,ngo, schedule_vii, local_yn, fy_timerange1, endd,tb.start,imp_direct, csr_reg_num,  ongoing 



/*


select  projectId,ngo, schedule_vii, local_yn, fy_timerange, endd,start,imp_direct, csr_reg_num, state_district, ongoing,sum(val) as val,dim from t1 
   
Group By projectId, fy_timerange, Dim,ngo, schedule_vii, local_yn, fy_timerange, endd,start,imp_direct, csr_reg_num, state_district, ongoing

Bengaluru Urban
Uttar Pradesh,Haryana
	
*/
  
  