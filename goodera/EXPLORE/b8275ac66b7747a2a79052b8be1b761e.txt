with sub1 as(
SELECT mr.region as region, mr.timeperiod_timerange,sq.pvh_id
FROM profile_62948 sq
LEFT JOIN profile_60928 mr
ON mr.factory_id=sq.pvh_id
  group by sq.pvh_id,mr.timeperiod_timerange,mr.region
ORDER BY mr.timeperiod_timerange DESC
  ),
  sub3 as(
	SELECT region1,s1.* from sub1 s1,s1.region region1  
	),
  sub2 as(
select t.name as region,timeperiod_timerange,region as region1,program
	from sub3
	left join ds_mysql_prod_tagelement t
	on t.id=sub3.region1
	left join profile_62972 ad
	on ad.cdms_id=sub3.pvh_id
 -- where ad.program!=1140839
	)
	SELECT region,count(*),region1,program from sub2
	group by region,region1,program