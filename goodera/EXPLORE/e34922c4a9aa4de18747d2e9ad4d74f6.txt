with sub1 as(
  select p1._id as id, p1.cdms_factory_id, p1.timeperiod_timerange,
p1.country_1__migrant_workers_reported_paying_fees, p1.country_1_number_of_workers_received_payment,
p1.country_2__migrant_workers_reported_paying_fees, p1.country_2_number_of_workers_received_payment,
p1.country_3__migrant_workers_reported_paying_fees, p1.country_3_number_of_workers_received_payment,
p1.country_4__migrant_workers_reported_paying_fees, p1.country_4_number_of_workers_received_payment,
p1.country_5__migrant_workers_reported_paying_fees, p1.country_5_number_of_workers_received_payment,
p1.country_6__migrant_workers_reported_paying_fees, p1.country_6_number_of_workers_received_payment,
p1.country_7__migrant_workers_reported_paying_fees, p1.country_7_number_of_workers_received_payment,

(nvl(p1.country_1__migrant_workers_reported_paying_fees, 0) + nvl(p1.country_2__migrant_workers_reported_paying_fees, 0) + nvl(p1.country_3__migrant_workers_reported_paying_fees, 0) +  nvl(p1.country_4__migrant_workers_reported_paying_fees, 0) + nvl(p1.country_5__migrant_workers_reported_paying_fees, 0) + nvl(p1.country_6__migrant_workers_reported_paying_fees, 0) + nvl(p1.country_7__migrant_workers_reported_paying_fees, 0)) as migrant_workers_reported_paying_fees,

(nvl(p1.country_1_number_of_workers_received_payment, 0) + nvl(p1.country_2_number_of_workers_received_payment, 0) + nvl(p1.country_3_number_of_workers_received_payment, 0) + nvl(p1.country_4_number_of_workers_received_payment, 0) + nvl(p1.country_5_number_of_workers_received_payment, 0) + nvl(p1.country_6_number_of_workers_received_payment, 0) + nvl(p1.country_7_number_of_workers_received_payment, 0)) as workers_received_payment,

(migrant_workers_reported_paying_fees - workers_received_payment) as migrant_workers_not_reimbursed

from profile_74372 p1),

sub2 as(
  select p2.factory_id, p2.factory_name, p2.source_div, p2.cr_tier, p2.region, p2.curr_cr_rating, p2.timeperiod_timerange,
dense_rank() over(order by cast(p2.timeperiod_timerange.start as DATE) DESC) as row
   
from profile_60928 p2

where p2.timeperiod_timerange is not null),

sub3 as (select * from sub2 where row = 1)

select s1.id, s1.cdms_factory_id, s1.timeperiod_timerange, s1.migrant_workers_not_reimbursed, s3.factory_name, s3.source_div, s3.cr_tier, s3.region, s3.curr_cr_rating
from sub1 s1

left join sub3 s3 on s3.factory_id = s1.cdms_factory_id

where s3.factory_name is not null