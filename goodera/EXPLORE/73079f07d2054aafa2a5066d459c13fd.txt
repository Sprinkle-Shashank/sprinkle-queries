with sub1 as(select p1.name as projectid,t1.name as financial_period,p1.fy_timerange,datatablebase,questiontext,tablesettings

from sus_56551 p1
left join ds_mysql_prod_tagelement t1 on t1.id=p1.financialPeriod
where keyword= 'cdp_cc_7_purchased')

sub2 as (select temp.cdp_cc_7_1_heat,temp.cdp_cc_7_1_steam,temp.cdp_cc_7_1_cooling,temp.cdp_cc_7_1_electricity from sub1 s1, unpivot s1.datatablebase as temp at rows),

sub3 as(
select 'Heat' as consumption_type
union all
select 'Steam' as consumption_type 
union all
select 'Cooling' as consumption_type 
union all
select 'Electricity' as consumption_type)

select proejctid,financial_period,fy_timerange,questiontext,rows,
sum(
case consumption_type
when 'Heat' then cdp_cc_7_1_heat
when 'Steam' then cdp_cc_7_1_steam
when 'Cooling' then cdp_cc_7_1_cooling
when 'Electricity' then cdp_cc_7_1_electricity
else null
end)
as values,

case consumption_type
when 'Heat' then cast(tablesettings."0"."cdp_cc_7_1_heat"."measureUnitBase" as VARCHAR)
when 'Steam' then cast(tablesettings."0"."cdp_cc_7_1_steam"."measureUnitBase" as VARCHAR)
when 'Cooling' then cast(tablesettings."0"."cdp_cc_7_1_cooling"."measureUnitBase" as VARCHAR)
when 'Electricity' cast(tablesettings."0"."cdp_cc_7_1_electricity"."measureUnitBase" as VARCHAR)
else null
end as units

from sub2
cross join sub3
group by projectid,financial_period,fy_timerange,questiontext,rows,values