with main as (select p.subcat_output ,r.name as fy_timerange,n.name as months, cast((split_part(split_part(prod.name,'|',1),'.',1)) as varchar) as ProjectCode,CONCAT(ProjectCode,fy_timerange) as code from profile_54963 p

left join ds_mysql_prod_project prod on
prod.id=p.projectid

left join ds_mysql_prod_tagelement r on
r.id=p.fy

left join ds_mysql_prod_tagelement n on
n.id=p.month),

lookup as (select cast(q.name as varchar) as ProjectCode,f.name as fy_timerange,m.name as Project_Manager,CONCAT(ProjectCode,fy_timerange) as code
from profile_27420 d
left join ds_mysql_prod_tagelement f on
d.fy=f.id
left join ds_mysql_prod_tagelement m on
d.project_manager=m.id
left join profile_27396 q on
d.project_code=q._id
union
select cast(c.name as varchar)as ProjectCode,f.name as fy_timerange,m.name as Project_Manager,CONCAT(ProjectCode,fy_timerange) as code 
from profile_27396 c	
left join ds_mysql_prod_tagelement f on
c.fy=f.id
left join ds_mysql_prod_tagelement m on
c.project_manager=m.id)

select b.fy_timerange,b.months,b.code,q.Project_Manager as level1,sum(b.subcat_output) as output from main b
left join lookup q on
q.code = b.code
group by b.fy_timerange,b.months,b.code,q.Project_Manager




