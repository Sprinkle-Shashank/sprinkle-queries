with table1 as
(
select fac.name as van, d2.name as partner,                  --van
cast(substring(d1.req_date,1,10) as date) as date_update_1 , cast(substring(d1.date_n,1,10) as date) as date_update_2 ,
case when d1.date_yn = 28005 then date_update_2 else date_update_1 end as date,    --date
  case when referred_yn = 28005 then diagnosis1.name 
       when referred_yn = 42693 then diagnosis2.name end as name
,p1.age,cast(DATEPART(YEAR,p1.createddate) as varchar) as created_year ,
cast(DATEPART(YEAR,current_date) as varchar) as current_year ,
(current_year - created_year)+ age as current_age, 1 as count ,
case when current_age>= 0 and current_age<=5 then '0-5'    
	 when current_age>= 6 and current_age<=18 then '6-18'
     when current_age>=19 and current_age<=40 then '19-40'
     when current_age>=41 and current_age<=60 then '41-60'
     when current_age > 60  then '60+' else null end as category	   
from profile_58474 p
left join profile_58473 p1
on p.patient = p1._id
left join profile_58511 d1
on p.sel_camp = d1._id
left join profile_51990 d2
on d1.imple_partner = d2._id
  
left join ds_mysql_prod_project fac
on p.projectid = fac.id
left join ds_mysql_prod_tagelement diagnosis1
on p.diagnosis1 = diagnosis1.id
 left join ds_mysql_prod_tagelement diagnosis2
on p.diagnosis2 = diagnosis2.id
  
  group by fac.name,d2.name,d1.req_date,d1.date_n,d1.date_yn,diagnosis1.name,diagnosis2.name,p1.createddate,p1.age,p.referred_yn
 ),
 
 
/* table2 as
(
  select fac.name as van,d2.name as partner,                   --van
  cast(substring(d1.req_date,1,10) as date) as date_update_1 , cast(substring(d1.date_n,1,10) as date) as date_update_2 ,
  case when d1.date_yn = 28005 then date_update_2 else date_update_1 end as date,    --date
  diagnosis.name, p1.age,cast(DATEPART(YEAR,p1.createddate) as varchar) as created_year , 
  cast(DATEPART(YEAR,current_date) as varchar) as current_year ,
(current_year - created_year)+ age as current_age, 1 as count ,
case when current_age>= 0 and current_age<=5 then '0-5y'    
	 when current_age>= 6 and current_age<=18 then '6-18y'
     when current_age>=19 and current_age<=40 then '19-40y'
     when current_age>=41 and current_age<=60 then '41-60y'
     when current_age > 60  then '60+' else null end as category	   
from profile_58474 p
left join profile_58473 p1
on p.patient = p1._id
left join profile_58511 d1
on p.sel_camp = d1._id
left join profile_51990 d2
on d1.imple_partner = d2._id
  
left join ds_mysql_prod_tagelement diagnosis
on p.diagnosis2 = diagnosis.id
left join ds_mysql_prod_project fac
on p.projectid = fac.id
  
  group by fac.name,d2.name,d1.req_date,d1.date_n,d1.date_yn,diagnosis.name,p1.createddate,p1.age
  
 ),
 table3 as
 (
 select * from table1
 union
 select * from table2
   ),*/
   table4 as(
   select t.category,t.date,t.van ,t.partner,
   nvl2(SUBSTRING(t.name, 1, POSITION(' -' in t.name)), SUBSTRING(t.name, 1, POSITION(' -' in t.name)),t.name) as diagnosis, case when diagnosis='' then t.name else diagnosis end as disease from table1 t
   )
   select disease , date , van , partner,
   count( case when category = '0-5y' then 1 end) as "0-5 yrs"  ,
   count( case when category = '6-18y' then 1 end) as "6-18 yrs" ,
   count( case when category = '19-40y' then 1 end) as "19-40 yrs" ,
   count( case when category = '41-60y' then 1 end) as "41-60 yrs" ,
   count( case when category = '60+' then 1 end) as "Above 60 yrs", count(category) as "total patients"
   from table4
   group by disease,date,van,partner