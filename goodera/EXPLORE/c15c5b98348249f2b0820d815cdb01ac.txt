with s as 
(Select t.name as projectid,EXTRACT(YEAR FROM(CAST(startdate AS datetime))) as year, datatablebase, questiontext
from sus_79028
left join ds_mysql_prod_project t
on xprojectid=t.id
where keyword='heat_map'
),
s2 as (
Select projectid , year , coun.suppliers_in_this_city_state,coun.state
from s as p, unpivot p.datatablebase as coun at xyz
)

Select projectid , year,tt.name as state,t.name as state_code,sum(suppliers_in_this_city_state)
from s2
left join ds_mysql_prod_tagelement tt
  on state =tt.id
 left join ds_mongo_reftagelementmetadata t
  on tt.reftagelementmetadataid=t._id
group by 1,2,3,4
