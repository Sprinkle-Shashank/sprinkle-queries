with lookup as (select split_part(split_part(prod.name,'|',1),'.',1) as ProjectCode,split_part(prod.name,'|',3) as census from profile_54963 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid),Base1 as
(select p.name as ProjectCode,l.name as NGO,concat(p.start_date,concat('-',p.end_date)),m.name  as Project_Manager,s.name as State from profile_27396 p
left join profile_27395 l on
p.ngo_partner=l._id
left join ds_mysql_prod_tagelement m on
p.project_manager=m.id
left join ds_mysql_prod_tagelement s on
p.state=s.id
union
select l.name as ProjectCode,p.ngo as NGO,concat(p.start_date,concat('-',p.end_date)),m.name as Project_Manager,s.name as state from profile_27420 p
left join profile_27396 l on
p.project_code=l._id
left join ds_mysql_prod_tagelement s on
l.state=s.id
left join ds_mysql_prod_tagelement m on
p.project_manager=m.id
)
,Base2 as(select *,l.state from lookup p left join
profile_27489 l		  
on p.census=l.name)
select * from Base2
