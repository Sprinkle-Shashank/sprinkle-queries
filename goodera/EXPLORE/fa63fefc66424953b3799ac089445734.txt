
with tab1 as (select  distinct split_part(split_part(p1.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange, p1.curr_yr_budget,p8.name as interventiontype,
concat(projectcode,fy_timerange) as CODE
from profile_27396 p1
left join ds_mysql_prod_tagelement f on
p1.fy=f.id
left join profile_28235 p8
on p8._id=p1.intervention_type),

tab2 as (select  distinct split_part(split_part(prod.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange,p2.hdfc_cost_monthly,
concat(projectcode,fy_timerange) as CODE
from profile_29974 p2
left join ds_mysql_prod_project prod
on prod.id=p2.projectid
left join ds_mysql_prod_tagelement f on
p2.fy=f.id),


tab3 as (select  distinct split_part(split_part(prod.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange,p6.monthly_cost,
concat(projectcode,fy_timerange) as CODE
from profile_30171 p6
left join ds_mysql_prod_project prod
on prod.id=p6.projectid
left join ds_mysql_prod_tagelement f on
p6.fy=f.id),

tab4 as (select  distinct split_part(split_part(split_part(p3.name,'|',1),'.',1),' ',1 ) as projectcode,
f.name as fy_timerange,p3.curr_yr_budget,
concat(projectcode,fy_timerange) as CODE
from profile_27420 p3
left join ds_mysql_prod_tagelement f on
p3.fy=f.id)

Select tab1.interventiontype, case tab1.interventiontype when 'Indirect' then sum(tab2.hdfc_cost_monthly+tab3.monthly_cost)
  else sum(tab4.curr_yr_budget+tab1.curr_yr_budget)  end as AllocatedAmount, tab1.fy_timerange from tab1 
  inner join tab4 on tab1.CODE=tab4.CODE
  inner join tab2 on tab1.CODE=tab2.CODE
  inner join tab3 on tab2.CODE=tab3.CODE
 where tab1.fy_timerange not in ('2015-2016','2016-2017','2017-2018')
group by tab1.fy_timerange ,tab1.interventiontype
  
  /*select sum(x.AllocatedAmount) as AllocatedAmount, x.fy_timerange from x group by x.fy_timerange*/

/*select p8.name, case p8.name  when 'Indirect' then sum(p2.hdfc_cost_monthly+p6.monthly_cost)
  else sum(p3.curr_yr_budget+p1.curr_yr_budget)  end as AllocatedAmount , f.name  as financial_year from profile_27396 p1
left join ds_mysql_prod_tagelement f on
p1.fy=f.id 
left join profile_28235 p8
on p8._id=p1.intervention_type
left join profile_29974 p2 on
p1._id=p2.prj_code and  p1.fy=p2.fy
left join profile_30171 p6 on
p2.prj_code=p6.prj_code and  p2.fy=p6.fy
left join profile_27420 p3
on p1._id=p3.project_code and  p1.fy=p3.fy

 where f.name not in ('2015-2016','2016-2017','2017-2018')
group by f.name , p8.name*/

/*select * from tab1 left join tab2 on tab1.CODE=tab2.CODE*/