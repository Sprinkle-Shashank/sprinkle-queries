with sub1 as(
SELECT sq.projectId as partner, sq.proj_name, 
	EXTRACT(Year FROM(CAST(sq.proj_start_date AS datetime))) as start_year,
  	EXTRACT(Year FROM(CAST(sq.proj_end_date AS datetime))) as end_year,t1.name as projectId, pd.ia_sel_ngop as impl_agency, sq._id as id1, SUM(mr.allocated) as budget from profile_65552 sq
left join ds_mysql_prod_tagelement t
on t.id=projectId
left join ds_mysql_prod_tagelement t1
on t.name=t1.parent
left join profile_65576 pd
on sq.impl_agency=pd.ia_sel_ngop
left join profile_65557 mr
on mr.project_name=sq._id
group by sq.proj_name, start_year, end_year, t1.name, pd.ia_sel_ngop, sq._id, sq.projectId),
sub2 as
(
  SELECT proj_name, start_year, end_year, projectId, impl_agency, id1, partner, budget, listagg( distinct p.name) as location
  from sub1 
  left join profile__65603 na
  on na.proj_name=id1
  left join ds_mysql_prod_tagelement p
  on na.location=p.id
  group by partner, proj_name, start_year, end_year, projectId, impl_agency, budget
  )
  select * from sub2
  
