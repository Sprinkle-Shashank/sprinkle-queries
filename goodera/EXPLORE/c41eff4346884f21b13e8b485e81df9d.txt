



with table1 as 
(
select projectId, ven.name as vendor, cou.name as country,nvl2(SUBSTRING(vendor, 1, POSITION(' (' in vendor)), SUBSTRING(vendor, 1, POSITION(' (' in vendor)), vendor) as vendor_name, case when vendor_name='' then vendor else vendor_name end as vendor_first_update from profile_64801 as q
  
left join ds_mysql_prod_project fac 
on q.projectId = fac.id

 left join ds_mysql_prod_project ven 
on fac.parent = ven.id

 left join ds_mysql_prod_project cou 
on ven.parent = cou.id
)
, table2 as 
(
select p.projectId, ven.name as vendor, cou.name as country, nvl2(SUBSTRING(vendor, 1, POSITION(' (' in vendor)), SUBSTRING(vendor, 1, POSITION(' (' in vendor)), vendor) as vendor_name, case when vendor_name='' then vendor else vendor_name end as vendor_first_update from profile_61572 as p

left join ds_mysql_prod_project fac 
on p.projectId = fac.id

 left join ds_mysql_prod_project ven 
on fac.parent = ven.id

 left join ds_mysql_prod_project cou 
on ven.parent = cou.id
)
, table3 as
(
select * from table2 as tab2 union all select * from table1 as tab1 
)

select distinct vendor_first_update, vendor_name, country /*, 9) stage error projectId as facility */ from table3

where country is not null and vendor_first_update <> 'Test Vendor'

group by vendor_first_update,country /* , tab3.projectId  */ , tab3.vendor_name
  
order by vendor_first_update asc


/*
select distinct vendor_first_update, vendor_name,  projectId, country, projectId as facility  from table3 as tab3

where country is not null and vendor_first_update <> 'Test Vendor'

group by vendor_first_update,country, tab3.projectId, tab3.vendor_name
  
order by vendor_first_update asc
*/

  /*
group by tab3.vendor_first_update, country, tab3.vendor_name, tab3.projectid
)
select distinct vendor, vendor_name, projectId, country, projectId as facility from table4 as tab4
*/
  
  
  
/*
with table1 as 
(
select q.projectId, ven.name as vendor, cou.name as country , nvl2(SUBSTRING(vendor, 1, POSITION(' (' in vendor)), SUBSTRING(vendor, 1, POSITION(' (' in vendor)), vendor) as vendor_name, case when vendor_name='' then vendor else vendor_name end as vendor_first_update, q.projectId as facility from profile_64801 as q

left join ds_mysql_prod_project fac 
on q.projectId = fac.id

 left join ds_mysql_prod_project ven 
on fac.parent = ven.id

 left join ds_mysql_prod_project cou 
on ven.parent = cou.id
)
, table2 as 
(
select p.projectId, ven.name as vendor, cou.name as country , nvl2(SUBSTRING(vendor, 1, POSITION(' (' in vendor)), SUBSTRING(vendor, 1, POSITION(' (' in vendor)), vendor) as vendor_name, case when vendor_name='' then vendor else vendor_name end as vendor_first_update, p.projectId as facility from profile_61572 as p

left join ds_mysql_prod_project fac 
on p.projectId = fac.id

 left join ds_mysql_prod_project ven 
on fac.parent = ven.id

 left join ds_mysql_prod_project cou 
on ven.parent = cou.id
)
, table3 as
(
select * from table2 as tab2 union all select * from table1 as tab1
)
select distinct vendor_first_update as vendor, projectId, country, vendor_name, facility from table3

where country is not null and vendor <> 'Test Vendor'

group by vendor, vendor_name, country, table3.vendor_first_update, table3.facility, table3.projectId

order by vendor asc

*/