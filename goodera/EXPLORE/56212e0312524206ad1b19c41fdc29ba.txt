with test1 as(
select p.fy_timerange, p.projectid, 'Allied' as f_category, cast('near_vision' as text) as vision,  (nv_allied + nv_partner) as final_sum from profile_63886 p where final_sum is not null
  union all
select p.fy_timerange, p.projectid, 'Allied' as f_category, cast('distance_vision' as text) as vision,  (dv_allied + dv_partner) as final_sum from profile_63886 p where final_sum is not null
  union all
select p.fy_timerange, p.projectid, 'Allied' as f_category, cast('complex_vision' as text) as vision,  (cv_allied + cv_partner) as final_sum from profile_63886 p where final_sum is not null
  union all
select p.fy_timerange, p.projectid, 'Allied' as f_category, cast('cataract' as text) as vision,  (cata_partner + cata_allied) as final_sum from profile_63886 p where final_sum is not null
  union all
select p.fy_timerange, p.projectid, 'Allied' as f_category, cast('cataract_surgery' as text) as vision,  (cata_surgery_allied + cata_surgery_partner) as final_sum from profile_63886 p where final_sum is not null
  
union all
  
select p.fy_timerange, p.projectid, 'Trucker' as f_category, cast('near_vision' as text) as vision, nv_truck as final_sum from profile_63886 p where final_sum is not null
  union all
select p.fy_timerange, p.projectid, 'Trucker' as f_category, cast('distance_vision' as text) as vision, dv_truck as final_sum from profile_63886 p where final_sum is not null
  union all
select p.fy_timerange, p.projectid, 'Trucker' as f_category, cast('complex_vision' as text) as vision, cv_truck as final_sum from profile_63886 p where final_sum is not null
  union all
select p.fy_timerange, p.projectid, 'Trucker' as f_category, cast('cataract' as text) as vision, cata_truck as final_sum from profile_63886 p where final_sum is not null
  union all
select p.fy_timerange, p.projectid, 'Trucker' as f_category, cast('cataract_surgery' as text) as vision,  cata_surgery_truck as final_sum from profile_63886 p where final_sum is not null
),

test2 as(
select concat(f_reg_date, concat('|', f_reg_date)) as fy_timerange, p.projectid, p.p_id, p.f_category, 
  	case
  		when vision = '1012445' then 'distance_vision'
  		when vision = '1012446' then 'cataract'
  		when vision = '1012447' then 'complex_vision'
  		when vision = '1012448' then 'near_vision'
  		when vision = '1059858' then 'cataract_surgery'
  		when vision = '1012449' then 'normal_vision'
  		else null
  	end as vision,
  	count(*) as final_sum
  	from profile_59462 p
  	where vision in ('1012445', '1012446', '1012447', '1012448', '1059858','1012449')
  	group by 1,2,3,4,5
),


final as(
select concat(cast(fy_timerange.start as varchar), concat('|', cast(fy_timerange.end as varchar))) as p.fy_timerange, p.projectid, p.f_category, p.vision, sum(p.final_sum) as final_sum from test1 p group by 1,2,3,4
  
  union all
  
select t.fy_timerange, t.projectid, t.f_category, t.vision, sum(t.final_sum) as final_sum from test2 t group by 1,2,3,4
)


select * from final
 