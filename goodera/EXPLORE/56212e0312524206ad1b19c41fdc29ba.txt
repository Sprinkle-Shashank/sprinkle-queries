with test1 as(
select p.fy_timerange.start as fy_timerange, p.projectid, 'Allied' as f_category, (nv_allied + nv_partner) as         "Near Vision", (dv_allied + dv_partner) as "Distance Vision", (cv_allied + cv_partner) as "Complex Vision", (cata_partner + cata_allied) as Cataract, (cata_surgery_allied + cata_surgery_partner) as "Cataract Surgery" from profile_63886 p
),


test2 as(
select p.fy_timerange.start as fy_timerange, p.projectid, 'Trucker' as f_category, nv_truck as
"Near Vision", dv_truck as "Distance Vision", cv_truck as "Complex Vision", cata_truck as Cataract,
cata_surgery_truck as "Cataract Surgery" from profile_63886 p
  
 union all
  
select * from test1
),


pivot as(
select 'Near Vision' as vision from test2
  union all
select 'Distance Vision' as vision from test2
  union all
select 'Complex Vision' as vision from test2
  union all
select 'Cataract' as vision from test2
  union all
select 'Cataract Surgery' as vision from test2
),


test3 as(
select p.fy_timerange, p.projectid, p.f_category, t.vision,
  case t.vision
  when 'Near Vision' then p."Near Vision"
  when 'Distance Vision' then p."Distance Vision"
  when 'Complex Vision' then p."Complex Vision"
  when 'Cataract' then p.Cataract
  when 'Cataract Surgery' then p."Cataract Surgery"
  else null
  end as total_sum
  from test2 p cross join pivot t
),

test4 as(
select concat(p.f_reg_date,'T00:00:00.000Z') as fy_timerange, p.projectid, p.p_id, p.f_category, 
  	case
  		when vision = '1012445' then 'Distance Vision'
  		when vision = '1012446' then 'Cataract'
  		when vision = '1012447' then 'Complex Vision'
  		when vision = '1012448' then 'Near Vision'
  		when vision = '1059858' then 'Cataract Surgery'
  		when vision = '1012449' then 'Normal Vision'
  		else null
  	end as vision,
  	count(*) as total_sum
  	from profile_59462 p
  	where vision in ('1012445', '1012446', '1012447', '1012448', '1012449', '1059858')
  	group by 1,2,3,4,5
),


final as(
select p.fy_timerange, p.projectid, p.f_category, p.vision, sum(p.total_sum) as total_sum from test3 p
group by 1,2,3,4
  
  union all
  
select t.fy_timerange, t.projectid, t.f_category, t.vision, t.total_sum from test4 t
)


select p.fy_timerange, t.name as projectid, f_category, vision, sum(total_sum) as total_sum
from final p
left join ds_mysql_prod_project as t
on t.id = p.projectid
group by 1,2,3,4

 