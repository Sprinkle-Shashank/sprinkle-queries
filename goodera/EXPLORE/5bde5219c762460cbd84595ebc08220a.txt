with table1 as
( select project_code,completed,fy_timerange,progress,month from(select project_code,completed,fy_timerange,progress,month,row_number() over 
(partition by p.project_code
 order by p._id desc) as row from profile_55471 p)
  where row = 1
 ),
 table2 as (
 select  m.projectId, m._id , project_name, vertical, focus, cast(start_date as date) as start_date, m.project_code, entity,compl.name as completed ,r.fy_timerange,prog.name as progress,r.month, cast(r.fy_timerange.end as date) as update_date,
 concat(start_date,'T00:00:00.000Z') as start1,
concat(update_date,'T00:00:00.000Z') as end2,
concat(concat(concat(concat('{"start":"',start1),'","end":"'),end2),'"}') as fy_1
   from profile_62881 as m
 
 LEFT JOIN table1 AS r
ON m.project_code = r.project_code
 left join ds_mysql_prod_tagelement as prog
  on r.progress = prog.id  
 left join ds_mysql_prod_tagelement as compl
  on r.completed = compl.id  
  
 ),
 
 table3 as (
select focus, project_code,vertical_new,start_date, progress, completed, fy_1 as fy_timerange, entity,
case when vert1.name is null then vert.name
     else vert1.name end as vertical
from table2 t2,t2.vertical vertical_new

 left join ds_mysql_prod_tagelement as vert
  on t2.vertical_new = vert.id 
 left join ds_mysql_prod_tagelement as vert1
  on vert.parent = vert1.id )
  
 select vertical_new,case when vert1.name is null then vert.name
     else vert1.name end as vertical from table3 t3  
 left join ds_mysql_prod_tagelement as vert
  on t3.vertical_new = vert.id 
 left join ds_mysql_prod_tagelement as vert1
  on vert.parent = vert1.id  

