with table1 as
( select project_code,completed,fy_timerange,progress,month from(select project_code,completed,fy_timerange,progress,month,row_number() over 
(partition by p.project_code
 order by p._id desc) as row from profile_55471 p)
  where row = 1
 ),
 table2 as (
 select  m.projectId, m._id , project_name, vertical, focus, cast(start_date as date) as start_date, m.project_code, entity,r.completed ,r.fy_timerange,r.progress,r.month, cast(r.fy_timerange.end as date) as update_date,
 concat(start_date,'T00:00:00.000Z') as start1,
concat(update_date,'T00:00:00.000Z') as end2,
concat(concat(concat(concat('{"start":"',start1),'","end":"'),end2),'"}') as fy_1
   from profile_62881 as m
 
 LEFT JOIN table1 AS r
ON m.project_code = r.project_code
 )
 
 
select * from table2


/*

With temp1 AS 
(SELECT m.projectId, m._id, m.project_name, m.vertical, m.focus, m.start_date, m.project_code, m.entity,
r.completed, r.fy_timerange AS fy_timerange_r, r.progress , ROW_NUMBER() over (order by m.projectId ) as row

FROM profile_62881 AS m

LEFT JOIN profile_55471 AS r
ON m.project_code = r.project_code

Group by m.projectId, m._id, m.project_name, m.vertical, m.focus, m.start_date, m.project_code, m.entity, r.completed, r.fy_timerange, r.progress
)

SELECT * from temp1 where row = 1






, LISTAGG(CAST(fy_timerange_r.end AS date),',') AS update_date_1, LISTAGG(prog.name,',') AS progress_2, LISTAGG(compl.name,',') AS complete_2,

CASE when compl.name = 'Yes' THEN CAST(fy_timerange_r.end AS date) when compl.name IS NULL Then CAST('2030-01-01' AS date) END AS end_date, CASE when end_date IS NULL Then CAST('2030-01-01' AS date) ELSE end_date END AS end_date_new,


left join ds_mysql_prod_tagelement as prog
  on r.progress = prog.id

left join ds_mysql_prod_tagelement as compl
  on r.completed = compl.id

, compl.name, end_date, end_date_new

ORDER BY m.project_code ASC, update_date_1 ASC
*/