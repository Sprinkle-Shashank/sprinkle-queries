with sub1 as(
  select p1._id as id, p1.project_name, p1.program_type, p1.fy_timerange, cast(p1.start_date as date) as start_date, cast(p2.offset_date as date) as offset_date, p4.projcode_factory, p1.end_date_2 as end_date, p1.num_females, p3.timeperiod_timerange, p3.region, p3.source_div, p3.brands,
  
case
	when p4.projcode_factory like 'C%' or p4.projcode_factory like '%PVH' then 1 
	else 0
end as filter, 

case
	when end_date_2 is null then 'Ongoing'
	else 'Completed'
end as batch_status,
  
row_number() over (partition by p1._id order by p3.timeperiod_timerange.start desc) as row

from profile_62491 p1
left join profile_62948 p2 on p2.project_id = p1.project_id
left join profile_60928 p3 on p2.pvh_id = p3.factory_id
left join profile_62482 p4 on p4.project_id = p1.project_id

where extract(year from start_date) >= 2020 and start_date >= nvl(offset_date,'2020-01-01') and filter = 1
and nvl(p1.lg_status,0) != 1105812 and p2.pvh_id is not NULL),

sub2 as(
  select s1.*,
  
case
  	when IS_ARRAY(s1.brands) = false or GET_ARRAY_LENGTH(s1.brands) = 0 then ARRAY(s1.brands)
  	else s1.brands
end as brands_new,
  
case
  	when IS_ARRAY(s1.source_div) = false or GET_ARRAY_LENGTH(s1.source_div) = 0 then ARRAY(s1.source_div)
  	else s1.source_div
end as source_div_new
  
  from sub1 s1 where row = 1),
  
sub3 as(
  select s2.*, country_unwind, brands_unwind, source_div_unwind
from sub2 s2, s2.region country_unwind, s2.brands_new brands_unwind, s2.source_div_new source_div_unwind)

select s3.id, s3.project_name, s3.program_type, s3.fy_timerange, s3.num_females, s3.batch_status, t1.name as country, t4.name as brands_sub, nvl(t5.name, 'All Brands') as brands, t6.name as source_div, 
nvl(t7.name, t6.name) as bus_div,

case 
	when t2.name = 'Community Program' then t3.name
	else t2.name
end as region

from sub3 s3

left join ds_mysql_prod_tagelement t1 on t1.id = s3.country_unwind
left join ds_mysql_prod_tagelement t2 on t2.id = t1.parent
left join ds_mysql_prod_tagelement t3 on t3.id = t2.parent

left join ds_mysql_prod_tagelement t4 on t4.id = s3.brands_unwind
left join ds_mysql_prod_tagelement t5 on t5.id = t4.parent

left join ds_mysql_prod_tagelement t6 on t6.id = s3.source_div_unwind
left join ds_mysql_prod_tagelement t7 on t7.id = t6.parent