--sakshi_API1
--select * from ds_mysql_prod_grantproposal --where proposalinstanceid = '5d42c4025570e08c058b5410'
with table1 as (
select p.id as grantApplicationId,partner.id as grantPartnerId1, 
proposal.id as grantProposalId1, proposallog.*,p.active as isactive, partner.active as activepartner, proposal.active as activeproposal, proposallog.active as activeproposallog
  
  from ds_mysql_prod_grantapplication p 
			   
left join ds_mysql_prod_grantpartner partner on
partner.grantapplicationid = p.id	
			
left join ds_mysql_prod_grantproposal proposal on
proposal.grantpartnerid = partner.id

left join ds_mongo_grantproposallog proposallog on
cast(proposallog.grantproposalid as int) = proposal.id
  
  
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17		   
),
t2 as(
select * from table1 where grantApplicationId = 1792 and isactive = 1 and activepartner = 1 and activeproposal = 1 and activeproposallog = 't' --and _id = '600eade8e37d56760546e4d6' 
),
t3 as (
Select tt.*,cgf from t2 as tt,tt.completedgrantflowtask cgf
)
,
t4 as(
Select t3.*, cast(t3.todo."action" as varchar) as action,
case
	when cgf."status" = 'COMPLETED' and cgf."taskId"=47474 then grantproposalid
	end as comp47474,
case
	when action = 'PENDING' and t3.todo."taskId"=47474 then grantproposalid
	end as pend47474,
case
	when action = 'REJECTED' and todo."taskId"=47474 then grantproposalid
	end as rej47474,

case
	when cgf."status" = 'COMPLETED' and cgf."taskId"=47477 then grantproposalid
	end as comp47477,
case
	when action = 'PENDING' and t3.todo."taskId"=47477 then grantproposalid
	end as pend47477,
case
	when action = 'REJECTED' and todo."taskId"=47477 then grantproposalid
	end as rej47477,
  

object(
'In Progress', 
ARRAY(JSON_PARSE(case
	when action = 'PENDING' and t3.todo."taskId"=47474 then grantproposalid
	end)),
  'Completed', LISTAGG(comp,','),
 'Rejected', jSON_PARSE(case
	when action = 'REJECTED' and todo."taskId"=47474 then grantproposalid
	end)

) as Approval_by_CSR_team
 from t3
group by 

grantapplicationid	,grantpartnerid1	,grantproposalid1,	_id,	grantproposalid	,grantflowtaskid,	active,	completedgrantflowtask,	todo,	created,	creatorid,	modified,	modifierid,	grantpartnerid,	isactive,	activepartner,	activeproposal,	activeproposallog,	cgf
--approval_by_csr_team
)
Select grantapplicationid  ,SPLIT_TO_ARRAY(listagg(distinct comp47474,', ')) as comp_47474,get_array_length(comp_47474),listagg(distinct pend47474,' ') as pend_47474, listagg(distinct rej47474,' ') as rej_47474,

SPLIT_TO_ARRAY(listagg(distinct comp47477,', ')) as comp_47477,get_array_length(comp_47477),listagg(distinct pend47477,' ') as pend_47477, listagg(distinct rej47477,' ') as rej_47477
from t4
group by 1