


select distinct p4.village as village, f.name as fy, p4.state as State, p4.district as District,
count(distinct p2.name) as no_of_projects, count(distinct p2.ngo_partner) as no_of_implementing_agencies,
sum(case p1.hdfc_cost_monthly when null then 0
		 else p1.hdfc_cost_monthly end) as totalhdfccost,
		 count(split_part(split_part( p1.census_code,'|',2),'|',2)) as villagecount, 
sum(case p3.monthly_cost when null then 0
		 else p3.monthly_cost end) as totalmonthlycost, totalhdfccost+(totalmonthlycost/villagecount) as allocatedamount

																															   
from profile_29974 p1
left join profile_27489 p4 on
p1.census_code=p4._id 
left join ds_mysql_prod_tagelement f on
p1.fy=f.id 
left join profile_27396 p2 on 
p1.prj_code=p2._id and p1.fy=p2.fy
left join profile_30171 p3 on 
p1.prj_code=p3.prj_code and p1.fy=p3.fy

/* join ds_mysql_prod_tagelement m on
p2.project_manager=m.id*/
			where f.name in('2019-2020')																							
group by p4.village,p4.state, p4.district,f.name/*village wise finances  final*/


