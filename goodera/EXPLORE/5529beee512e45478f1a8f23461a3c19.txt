with sub1 as(
select sq.*, pd.pvh_id, pd.offset_date, mr.partner_type, mr.name_vendor, mr.name_vendor_filter, json_serialize(ab.source_div) as source_div, json_serialize(ab.region) as region, ab.region_parent, ab.timeperiod_timerange, cast(sq.start_date as date) as start_date, cast(pd.offset_date as date) as offset_date
from profile_62491 sq
left join profile_62948 pd
on sq.project_id=pd.project_id
left join profile_62482 mr
on mr.projectId=sq.projectId
left join profile_60928 ab
on ab.factory_id=pd.pvh_id
where coalesce(lg_status,0)!=1105812 and pd.pvh_id is not null 
  --and start_date >= nvl(offset_date,'2020-01-01')
order by ab.timeperiod_timerange desc),
sub2 as (
  select projectId, name, fy_timerange, num_females, pvh_id, partner_type, name_vendor, name_vendor_filter, first_value(source_div)
over(partition by name, fy_timerange, num_females, project_id, pvh_id, partner_type, name_vendor, name_vendor_filter
order by cast(timeperiod_timerange.start as date) desc
rows between unbounded preceding and unbounded following) as source_div_new, 
	first_value(region)
over(partition by name, fy_timerange, num_females, project_id, pvh_id, partner_type, name_vendor, name_vendor_filter
order by cast(timeperiod_timerange.start as date) desc
rows between unbounded preceding and unbounded following) as region_new
from sub1 ), 
sub3 as (
select projectId, name, fy_timerange, num_females, pvh_id, partner_type, name_vendor, name_vendor_filter, source_div_new as source_div, region_new as region from sub2
  where source_div_new is not null and region_new is not null
group by projectId, name, fy_timerange, num_females, pvh_id, partner_type, name_vendor, name_vendor_filter, source_div_new, region_new),
sub4 as(
select source_div, region, fy_timerange, sum(num_females) as num_females from sub3
group by source_div, region, fy_timerange), 
sub5 as(
select source_div, region2, fy_timerange, num_females from sub4 s4
  --, s4.source_div source_div2
  , s4.region region2),
sub6 as(
  select t1.name as source_div, t2.name as region, fy_timerange, num_females from sub5
left join ds_mysql_prod_tagelement t1
on t1.id=source_div2
left join ds_mysql_prod_tagelement t2
on t2.id=region2)
select * from sub6