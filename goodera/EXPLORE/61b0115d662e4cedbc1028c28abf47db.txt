with temp as(
  select 'energy_levelsachieved_verified' as col 
  union all
  select 'wastewater_levelsachieved_verified' as col 
  union all
  select 'ems_levelsachieved_verified' as col 
  union all
  select 'chemicals_levelsachieved_verified' as col 
  union all
  select 'waste_levelsachieved_verified' as col 
  union all
  select 'air_levelsachieved_verified' as col 
  union all
  select 'water_levels_achieved_verified' as col 
),

sub1 as(
  select p1._id as id, p1.sacid, p1.country, p1.fy_timerange, p2.cdms_id, temp.col as module, p3.timeperiod_timerange, json_serialize(p3.source_div) as source_div,
  case when get_array_length(source_div) = 0 then array(0)
  else COALESCE(source_div,array(0)) end new_source, rtrim(ltrim(json_serialize(new_source),'['),']') as new_source1,
case col
		when 'energy_levelsachieved_verified' then p1.energy_levelsachieved_verified
		when 'wastewater_levelsachieved_verified' then p1.wastewater_levelsachieved_verified
		when 'ems_levelsachieved_verified' then p1.ems_levelsachieved_verified
		when 'chemicals_levelsachieved_verified' then p1.chemicals_levelsachieved_verified
		when 'waste_levelsachieved_verified' then p1.waste_levelsachieved_verified
		when 'air_levelsachieved_verified' then p1.air_levelsachieved_verified
		when 'water_levels_achieved_verified' then p1.water_levels_achieved_verified
  		else Null
end as level,
position(1 in level) as level1, upper(substring(temp.col,1,position('_' in temp.col)-1)) as modules
from profile_74133 p1
cross join temp
left join profile_74334 p2 on p2.higg_id = p1.sacid
left join profile_60928 p3 on p3.factory_id = p2.cdms_id
--where p2.cdms_id is not null
)
select * from sub1