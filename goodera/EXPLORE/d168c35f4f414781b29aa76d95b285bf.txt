
with table1 as
(select p.projectid , p._id ,  fac.name as factory,  status from profile_16619 as p
 
 left join ds_mysql_prod_project fac 
on p.projectId = fac.id

where status !=437658 and status!=437659),


table2 as 
( select p.projectid , p._id , factory_id from profile_4722 as p), 


table3 as
( select p.projectid , p._id , 
 
ven.name as vendor1,nvl2(SUBSTRING(vendor1, 1, POSITION(' (' in vendor1)), SUBSTRING(vendor1, 1, POSITION(' (' in vendor1)), vendor1) as vendor_name, case when vendor_name='' then vendor1 else vendor_name end as vendor,cou.name as country,case when country in ('India', 'Bangladesh', 'Sri Lanka')
then 'South Asia'
when country in ('China')
then 'North Asia'
when country in ('Guatemala', 'El Salvador', 'Dominican Republic')
then 'Americas'
when country in ('Philippines', 'Cambodia',  'Vietnam',  'Indonesia', 'Myanmar')
then 'South East Asia'
end as region,DATEPART(YEAR,p.date_enrollment) as year_new,case when p.name_subunit is null or p.name_subunit=' ' then 'N/A' else p.name_subunit end  as unit , esa.name as last_level , case when extract(month from date_enrollment)=1 then (extract(year from date_enrollment)-1) else extract(year from date_enrollment) end as batch , substring(date_enrollment, 0,11) as WCP_Start_Date ,  substring(date, 0,11) as module_1, substring(date_2, 0,11) as module_2 , substring(date_3, 0,11) module_3, substring(date_4, 0,11) module_4, substring(date_5, 0,11) module_5, substring(date_6, 0,11) module_6, substring(date_7, 0,11) module_7, substring(date_8, 0,11) module_8 , substring(date_completion, 0,11) end as end_date from profile_16619 as p

left join ds_mysql_prod_project fac 
on p.projectId = fac.id

left join ds_mysql_prod_project ven 
on fac.parent = ven.id

left join ds_mysql_prod_project cou 
on ven.parent = cou.id

left join ds_mysql_prod_project esa 
on cou.parent = esa.id
 
 ),
 
 
 table4 as 
 (
   select p.projectid , p._id ,  date, Date_2, Date_3, Date_4, Date_5, Date_6, Date_7, Date_8 , 1 as Number_of_Modules_Completed from profile_16619 as p 
   
   where p.date is not null 
   and Date_2 is not null and Date_3 is not null and Date_4 is not null   and Date_5 is not null and Date_6 is not null and Date_7 is not null and Date_8 is not null 
),


table5 as
( 
   select p.projectid , p._id from profile_16619 as p 
),


table6 as 
(
select p.projectid ,  case when date is not null then total_trained end as total_trained_s1 , case when date_2 is not null then total_trained_2 end as total_trained_s2 , case when date_3 is not null then total_trained_3 end as total_trained_s3 ,case when date_4 is not null then total_trained_4 end as total_trained_s4 ,case when date_5 is not null then total_trained_5 end as total_trained_s5 ,case when date_6 is not null then total_trained_6 end as total_trained_s6 ,case when date_7 is not null then total_trained_7 end as total_trained_s7 , case when date_8 is not null then total_trained_8 end as total_trained_s8 , avg(total_trained_s1 + total_trained_s2 + total_trained_s3 + total_trained_s4 + total_trained_s5 + total_trained_s6 + total_trained_s7 +total_trained_s8) as average_value , avg(sum( total_trained + total_trained_2 + total_trained_3 + total_trained_4 + total_trained_5 + total_trained_6 + total_trained_7 + total_trained_8)) as r1 from profile_16619 as p 
  
  group by p.projectid ,  date, Date_2, Date_3, Date_4, Date_5, Date_6, Date_7, Date_8 , total_trained , total_trained_2 , total_trained_3 , total_trained_4 , total_trained_5 , total_trained_6 , total_trained_7 , total_trained_8
 ), 
 
 
table7 as 
( select p.projectid , sum( total_trained + total_trained_2 + total_trained_3 + total_trained_4 + total_trained_5 + total_trained_6 + total_trained_7 + total_trained_8) as r1 , sum( total_trained) as d1 , avg(d1) from profile_16619 as p
 ),
  
 
select * from table7
   
   /*
    date, Date_2, Date_3, Date_4, Date_5, Date_6, Date_7, Date_8
  
-------------------------------
 table6 and table 7 for average 
-------------------------------
  case when date is not null then total_trained end as total_trained_a1 , case when date_2 is not null then total_trained_2 end as total_trained_s2 , case when date_3 is not null then total_trained_3 end as total_trained_s3 ,case when date_4 is not null then total_trained_4 end as total_trained_s4 ,case when date_5 is not null then total_trained_5 end as total_trained_s5 ,case when date_6 is not null then total_trained_6 end as total_trained_s6 ,case when date_7 is not null then total_trained_7 end as total_trained_s7 , case when date_8 is not null then total_trained_8 end as total_trained_s8
   */