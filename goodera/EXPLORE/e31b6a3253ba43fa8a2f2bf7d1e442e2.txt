with sub1 as (
Select
sp.pvh_id,sq.partner_type, sq.name_vendor, sq.name_vendor_filter, ss.region_parent, ss.timeperiod_timerange
from profile_62491 fr
left join profile_62948 sp
on sp.project_id=fr.project_id
LEFT JOIN profile_62482 sq
on fr.project_id=sq.project_id
LEFT JOIN profile_60928 ss
on sp.pvh_id=ss.factory_id
where sp.pvh_id IS NOT NULL and lg_status!=1105812
),
sub2 as (
  select project_id, project_name, end_date, fy_timerange, pvh_id, region, source_div, sum(num_females) as num_females from sub1
group by name, fy_timerange, num_females, project_id, pvh_id, partner_type, name_vendor, name_vendor_filter, start_date),

sub3 as(
  select s2.*, country from sub2 s2, s2.region country)

SELECT s3.fy_timerange, s3.pvh_id, sum(s3.num_females) as num_females, t1.name as region, s3.program
FROM sub3 s3
left join ds_mysql_prod_tagelement t1 on t1.id = s3.country
group by s3.fy_timerange, s3.pvh_id, t1.name, s3.program
order by ss.timeperiod_timerange DESC
