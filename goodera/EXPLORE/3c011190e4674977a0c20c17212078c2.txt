
with table5 as
( select p._id , p.projectid,p.name, cast(concat('FY ',start_year) as varchar) as start_year,to_char(start_date,'YYYY') as start_date, case when end_date_2 is not null then to_char(start_date,'YYYY-MM-DD') end as start_date_update,to_char(end_date_2,'YYYY-MM-DD') as end_date_2,num_females,num_females_graduated , type_program ,substring(sub_date,1,10) as sub_date ,  to_char(end_date,'YYYY-MM-DD') as end, to_char(end_date_2,'YYYY-MM-DD') as end_2 , to_char(dateadd(day , 90 , end_date_2),'YYYY-MM-DD') as end_2_90 ,  z.projcode_factory , substring(z.projcode_factory,0,2) as projcode_factory_updated1 , z.name_country ,  z.name_vendor , z.name_rp , z.name_factory , z.name_vendor_filter ,
 
case when projcode_factory_updated1='C' or (projcode_factory_updated1='F' and type_program <> 'Workplace Program') then 'NA' when sub_date is not null then 'Completed' when CURRENT_DATE>=end_2 and CURRENT_DATE<end_2_90 then 'upcoming' when CURRENT_DATE>=end_2_90 then 'Past Due date' end as business_outcomes from profile_4227 p 
 
 left join profile_54646 z on 
 p.projectid = z.projectid
 
 where end_date_2 is not null),

table6 as
( select p.projectid , p.name , projcode_factory , substring(projcode_factory,0,2) as projcode_factory_updated1 from profile_54646 p
 )
 
 select p.* from table5 p
 