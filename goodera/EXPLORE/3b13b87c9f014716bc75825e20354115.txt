with sub1 as(
  select p1._id as p3id, p1.creatorid, t1.email, p1.fy_timerange, p1.country, p1.product_brand, p1.other_brands_involved, p1.activity, p1.activity_description, p1.partner, p1.business_units, p1.focus_area, p1.focus_area_other, p1.currency, p1.direct_cash, p1.direct_cash_donations, p1.product_donation, p1.value_of_reckitt_products, p1.brand_of_prods_donated, p1.other_brand, p1.product_description, p1.no_of_reckitt_prods_donated, p1.sold_destroyed, p1.estimate_cost, p1.emp_volunteering, p1.total_amount_donated_payroll, p1.supplier_contribution, p1.no_of_individuals_directly_engaged, p1.people_engaged_explanation, p1.measure_outcome, p1.no_of_individuals_better_knowledge, p1.no_of_individuals_behaviour_changed, p1.no_of_individuals_reporting_improvement, p1.charity_measured_outcome, p1.outcome_evidence, p1.photos_reports, p1.sequence, is_array(p1.other_brand) as array_check,
case
  when array_check = false then array(p1.other_brand)
  else p1.other_brand
end as other_brand_new
from profile_78057 p1
left join ds_mysql_prod_user t1 on t1.id = p1.creatorid),

sub2 as(
  select s1.*, other_brand_2 from sub1 s1, s1.other_brand_new other_brand_2)
  
select s2.p3id, s2.sequence, s2.email as user_email, s2.fy_timerange, t1.name as country, t2.name as product_brand, s2.other_brands_involved, s2.activity, s2.activity_description, s2.partner, t3.name as business_units, t4.name as focus_area, s2.focus_area_other, t5.name as currency, p2.conversion_factor, t6.name as direct_cash, s2.direct_cash_donations, 
(s2.direct_cash_donations * p2.conversion_factor) as direct_cash_donations_GBP, t7.name as product_donation, s2.value_of_reckitt_products,
(s2.value_of_reckitt_products * p2.conversion_factor) as value_reckitt_products_gbp, t8.name as brand_of_prods_donated, s2.product_description, s2.no_of_reckitt_prods_donated, t9.name as sold_destroyed, s2.estimate_cost, (s2.estimate_cost * p2.conversion_factor) as estimate_cost_gbp, t10.name as emp_volunteering,
s2.total_amount_donated_payroll, 
(s2.total_amount_donated_payroll * p2.conversion_factor) as total_amount_donated_payroll_gbp, s2.supplier_contribution, (s2.supplier_contribution * p2.conversion_factor) as supplier_contribution_gbp, s2.no_of_individuals_directly_engaged, s2.people_engaged_explanation, t11.name as measure_outcome, s2.no_of_individuals_better_knowledge, s2.no_of_individuals_behaviour_changed, s2.no_of_individuals_reporting_improvement, s2.charity_measured_outcome, s2.outcome_evidence, s2.photos_reports,
listagg(p3.name, ', ') as other_brands,

case
	when s2.outcome_evidence is null or get_array_length(s2.outcome_evidence) = 0 then '-'
	else 'Evidence Download'
end as outcome_evidence_download,

case
	when s2.photos_reports is null or get_array_length(s2.photos_reports) = 0 then '-'
	else 'Reports Download'
end as photos_reports_download

from sub2 s2
left join ds_mysql_prod_tagelement t1 on t1.id = s2.country
left join ds_mysql_prod_tagelement t2 on t2.id = s2.product_brand
left join ds_mysql_prod_tagelement t3 on t3.id = s2.business_units
left join ds_mysql_prod_tagelement t4 on t4.id = s2.focus_area
left join ds_mysql_prod_tagelement t5 on t5.id = s2.currency
left join ds_mysql_prod_tagelement t6 on t6.id = s2.direct_cash
left join ds_mysql_prod_tagelement t7 on t7.id = s2.product_donation
left join ds_mysql_prod_tagelement t8 on t8.id = s2.brand_of_prods_donated
left join ds_mysql_prod_tagelement t9 on t9.id = s2.sold_destroyed
left join ds_mysql_prod_tagelement t10 on t10.id = s2.emp_volunteering
left join ds_mysql_prod_tagelement t11 on t11.id = s2.measure_outcome
left join profile_78083 p2 on p2.name = (t5.name||'_'||extract(year from cast(s2.fy_timerange.start as date)))
left join profile_78062 p3 on p3._id = s2.other_brand_2

group by s2.p3id, s2.sequence, s2.email, s2.fy_timerange, t1.name, t2.name, s2.other_brands_involved, s2.activity, s2.activity_description, s2.partner, t3.name, t4.name, s2.focus_area_other, t5.name, p2.conversion_factor, t6.name, s2.direct_cash_donations, t7.name, s2.value_of_reckitt_products, t8.name, s2.product_description, s2.no_of_reckitt_prods_donated, t9.name, s2.estimate_cost, t10.name,
s2.total_amount_donated_payroll, s2.supplier_contribution, s2.no_of_individuals_directly_engaged, s2.people_engaged_explanation, t11.name, s2.no_of_individuals_better_knowledge, s2.no_of_individuals_behaviour_changed, s2.no_of_individuals_reporting_improvement, s2.charity_measured_outcome, s2.outcome_evidence, s2.photos_reports

order by s2.sequence asc