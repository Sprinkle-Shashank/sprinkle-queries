
with table_z0 as
( select p.projectid , p._id , quarter , fy , qua.name as quarter_update , f.name as fy_update , concat( quarter_update, ' , ') as quarter_update_new , concat(quarter_update_new,fy_update) as Latest_Impact_Data , p2.name_subunit , row_number() over 
(partition by p.projectid
 order by p._id desc) as row , case when Latest_Impact_Data is null then 'N/A' else Latest_Impact_Data end as Latest_Impact_Data_update from profile_16862 as p
 
left join ds_mysql_prod_tagelement qua 
on p.quarter = qua.id
 
left join ds_mysql_prod_tagelement f 
on p.fy = f.id
 
left join ds_mysql_prod_project fac 
on p.projectId = fac.id

left join ds_mysql_prod_project ven 
on fac.parent = ven.id

left join ds_mysql_prod_project cou 
on ven.parent = cou.id
 
left join profile_16619 p2 on 
 p.projectid = p2.projectid
 
where cou.name != 'Test Country' and cou.name !='GAP Inc'
),

table_z01 as 
(
 select * from table_z0 where row=1
  ),

table_z1 as
( select p.projectid , p._id , quarter , fy , qua.name as quarter_update , f.name as fy_update , concat( quarter_update, ' , ') as quarter_update_new , concat(quarter_update_new,fy_update) as Latest_Grievance_Data , p2.name_subunit , row_number() over 
(partition by p.projectid
 order by p._id desc) as row , case when Latest_Grievance_Data is null then 'N/A' else Latest_Grievance_Data end as Latest_Grievance_Data_update , fac.name as factory from profile_16863 as p
 
left join ds_mysql_prod_tagelement qua 
on p.quarter = qua.id
 
left join ds_mysql_prod_tagelement f 
on p.fy = f.id
 
left join ds_mysql_prod_project fac 
on p.projectId = fac.id

left join ds_mysql_prod_project ven 
on fac.parent = ven.id

left join ds_mysql_prod_project cou 
on ven.parent = cou.id
 
left join profile_16619 p2 on 
 p.projectid = p2.projectid
 
where cou.name != 'Test Country' and cou.name !='GAP Inc'
 
 order by fy_update desc , quarter_update desc
),

 
table_z11 as 
(
 select p.projectid , p._id , quarter_update , fy_update , Latest_Grievance_Data from table_z1 as p where row=1 
  ),
  
table_z12 as 
(
  select p.projectid , p._id , Latest_Grievance_Data  from table_z1 as p limit 1
 )
 
 select p.*, case when z12.Latest_Grievance_Data= Latest_Grievance_Data then 'Up to Date' else 'Pending' end as Grievance_Data_Approval_Status from table_z11 as p
 
 left join table_z12 z12 on 
 p._id = z12._id 
  
  --select p.* , Greatest(fy_update , quarter_update) from table_z11 as p
  
 -- where fy_update=max(fy_update) 
  
/* group by p.projectid , p._id , Latest_Grievance_Data , p.quarter_update , p.fy_update
  case when fy_update=max(fy_update) and quarter_update=max(quarter_update) then 'Up to Date' else 'Pending' end as grievance_filter
  */
