with 
temp as(
Select 'Total Direct Budget' as col
union all
Select 'Total Indirect Budget' as col
),


tab1 as(Select distinct(p.village), p3.name fy_timerange, sum(hdfc_cost_yearly) hdfc_cost_yearly,sum(gov_cost_yearly) as gov_cost_yearly,sum(comm_cost_yearly) comm_cost_yearly, p1.name as projectcode, p2.name as project_manager
from profile_29973 sq
left join profile_27489 p
on sq.census_code=p._id
left join profile_27396 p1
on sq.prj_code=p1._id
left join ds_mysql_prod_tagelement p2
on p1.project_manager=p2.id
left join ds_mysql_prod_tagelement p3
on p3.id=sq.fy
group by p.village,p1.name,p2.name,p3.name),

tab2 as(select distinct(t.village),sum(t.hdfc_cost_yearly+t.gov_cost_yearly+t.comm_cost_yearly) as total_direct,t.fy_timerange,t.project_manager,t.projectcode from tab1 t
group by t.fy_timerange,t.project_manager,t.projectcode,t.village),

tab3 as(SELECT q.name as projectcode,t.name as fy_timerange,
       sum(CASE 
             WHEN p.budget_head = 'Admin Cost' THEN p.cost_yearly 
             ELSE 0 
           END) AS Admin_cost,
       sum(CASE 
             WHEN p.budget_head = 'Human Resource' THEN p.cost_yearly
             ELSE 0 
           END) AS Human_resource,
		sum(CASE 
             WHEN p.budget_head = 'NGO Management Cost' THEN p.cost_yearly
             ELSE 0 
           END) AS NGO_Management_Cost 
FROM   profile_29976 p
left join ds_mysql_prod_tagelement t on
p.fy=t.id
left join profile_27396 q on
p.prj_code=q._id
left join ds_mysql_prod_tagelement t2 on
q.project_manager=t2.id

GROUP  BY 1,2),
tab4 as(select distinct(k.village),q.name as projectcode,t2.name as project_manager
		  from profile_29973 p
		  left join profile_27489 k
          on p.census_code=k._id
		  left join profile_27396 q on
          p.prj_code=q._id
		  left join ds_mysql_prod_tagelement t2 on
          q.project_manager=t2.id
		  group by 1,2,3),
		  
		  
tab5 as(select count(t1.village)as number_of_villages,t.projectcode,t.fy_timerange,t1.project_manager,t.Admin_cost,t.Human_resource,t.NGO_Management_Cost from tab3 t
left join tab4 t1 on
t.projectcode=t1.projectcode
group by 2,3,4,t.Admin_cost,t.Human_resource,t.NGO_Management_Cost),

tab6 as(select t3.village,t2.projectcode,t2.fy_timerange,t2.project_manager,(t2.Admin_cost/t2.number_of_villages) as AC,(t2.Human_resource/t2.number_of_villages) as HRC,(t2.NGO_Management_Cost/t2.number_of_villages) as NMC from tab5 t2
left join tab4 t3 on
t3.projectcode=t2.projectcode
where t2.number_of_villages!=0),

tab7 as(select sum(t.HRC+t.NMC+t.AC) as total_indirect,t.fy_timerange,t.project_manager,t.projectcode,t.village from tab6 t
group by t.fy_timerange,t.project_manager,t.projectcode,t.village)

Select distinct(t.village), t.fy_timerange, 
case col
		when 'Total Direct Budget' then t1.total_direct
		when 'Total Indirect Budget' then  t.total_indirect
		
	else 0
	end as values,
	temp.col as contri_types,
t.projectcode, t.project_manager
from tab7 t
left join tab2 t1 on
t1.projectcode=t.projectcode
cross join temp






