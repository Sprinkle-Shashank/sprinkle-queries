with tab2 as (select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange, 
concat(projectcode,fy_timerange) as CODE,
		sum(case p2.hdfc_cost_monthly when null then 0
		 else p2.hdfc_cost_monthly end) as finalhdfc_cost_monthly,
		 count(split_part(split_part( p2._id,'|',2),'|',2)) as villagecount,
		 p2.census_code as census_code
from profile_29974 p2
left join ds_mysql_prod_project prod
on prod.id=p2.projectid
left join ds_mysql_prod_tagelement f on
p2.fy=f.id

group by projectcode,f.name,census_code ),


tab3 as (select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange,
concat(projectcode,fy_timerange) as CODE,sum(case p6.monthly_cost when null then 0
		 else p6.monthly_cost end) as finalmonthly_cost
from profile_30171 p6
left join ds_mysql_prod_project prod
on prod.id=p6.projectid
left join ds_mysql_prod_tagelement f on
p6.fy=f.id

group by projectcode,f.name),


		 
finaltab as (select tab2.CODE,tab2.census_code, sum (tab2.villagecount) as totalvillagecount,
			 case totalvillagecount when null then tab2.finalhdfc_cost_monthly 
else (tab3.finalmonthly_cost/totalvillagecount) +(tab2.finalhdfc_cost_monthly) end
 as AllocatedAmount, 
tab2.fy_timerange 
from tab2 
left join tab3 on tab2.CODE=tab3.CODE
group by 	tab2.CODE,tab2.census_code,	tab2.fy_timerange ,tab2.finalhdfc_cost_monthly,tab3.finalmonthly_cost	),
			
tab1 as (select split_part(split_part(p1.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange, 
concat(projectcode,fy_timerange) as CODE,count(distinct p1.name) as no_of_projects, count(distinct p1.ngo_partner) as no_of_implementing_agencies
from profile_27396 p1
left join ds_mysql_prod_tagelement f on
p1.fy=f.id
		 group by projectcode,fy_timerange)
		 
select distinct p4.village as village, p4.state as State, p4.district as District,
tab1.no_of_projects,tab1.no_of_implementing_agencies,finaltab.AllocatedAmount,finaltab.fy_timerange from finaltab 

left join tab1 on tab1.CODE=finaltab.CODE
left join profile_27489 p4 on
finaltab.census_code=p4._id where finaltab.fy_timerange in('2019-2020')