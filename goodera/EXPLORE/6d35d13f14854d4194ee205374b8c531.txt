with tab1 as(select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,t.name as fy_timerange,concat(projectcode,fy_timerange) as CODE,split_part(prod.name,'|',3) as censuscode,q.village,q.state,q.district,sum(case p.hdfc_cost_monthly when null then 0 else p.hdfc_cost_monthly end) as hdfc_cost from profile_29974 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement t
on p.fy=t.id
/*left join ds_mysql_prod_tagelement t1
on p.month_number=t1.id
left join ds_mysql_prod_tagelement t2
on t1.parent=t2.id*/
left join profile_27489 q on
split_part(prod.name,'|',3)=q.name
group by 1,2,3,4,5,6,7),/*sum of HDFC_cost_monthly from 29974*/


tab2 as(select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,t.name as fy_timerange,concat(projectcode,fy_timerange) as CODE,sum( case p.monthly_cost when null then 0 else p.monthly_cost end) as monthlycost  from profile_30171 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement t
on p.fy=t.id
/*left join ds_mysql_prod_tagelement t1
on p.month_number=t1.id
left join ds_mysql_prod_tagelement t2
on t1.parent=t2.id*/
group by 1,2,3),/* sum of monthly_cost from 30171*/
tab3 as(select t.projectcode,t.fy_timerange,t.hdfc_cost a,t1.monthlycost b,t.CODE,t.censuscode,t.village,t.state,t.district from tab1 t
left join tab2 t1 on
t.CODE=t1.CODE ),/*join of tab1(29974) and tab2(30171)*/
tab4 as(select count(distinct(t1.censuscode)) as number_of_villages,t.fy_timerange,t.projectcode,t.CODE from tab1 t
left join tab3 t1 on
t.CODE=t1.CODE  
group by t.fy_timerange,t.CODE,t.projectcode),/*calculate count of distinct cencuscode from 29974 on basis of CODE*/
tab5 as(select t.fy_timerange,t.projectcode,t.CODE,t1.village,t1.state,t1.district,t1.b/t.number_of_villages c,t1.a d,c+d total,t.number_of_villages
from tab4 t
left join tab3 t1 on
t.CODE=t1.CODE),/*calculate allocated amount as (monthly_cost/no.ofvillages) +hdfccost
from tab4*/
tab6 as ( select split_part(split_part(p1.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange, concat(projectcode,fy_timerange) as CODE, count(distinct p1.name) as no_of_projects, count(distinct p1.ngo_partner) as no_of_implementing_agencies
from profile_27396 p1
left join ds_mysql_prod_tagelement f on
p1.fy=f.id
	group by p1.name,2
		union all
select split_part(split_part(split_part(p3.name,'|',1),'.',1),' ',1 ) as projectcode,
f.name as fy_timerange,concat(projectcode,fy_timerange) as CODE,count(distinct p3.name) as no_of_projects, count(distinct p3.ngo) as no_of_implementing_agencies
from profile_27420 p3
left join ds_mysql_prod_tagelement f on
p3.fy=f.id 
group by p3.name,2),


main as (select r.name as fy_timerange, cast((split_part(split_part(prod.name,'|',1),'.',1)) as varchar) as ProjectCode,CONCAT(ProjectCode,fy_timerange) as code from profile_54963 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement r on
r.id=p.fy),

lookup as (select cast(q.name as varchar) as ProjectCode,f.name as fy_timerange,m.name as Project_Manager,CONCAT(ProjectCode,fy_timerange) as code
from profile_27420 d
left join ds_mysql_prod_tagelement f on
d.fy=f.id
left join ds_mysql_prod_tagelement m on
d.project_manager=m.id
left join profile_27396 q on
d.project_code=q._id
		   
union all
		   
select cast(c.name as varchar)as ProjectCode,f.name as fy_timerange,m.name as Project_Manager,CONCAT(ProjectCode,fy_timerange) as code 
from profile_27396 c	
left join ds_mysql_prod_tagelement f on
c.fy=f.id
left join ds_mysql_prod_tagelement m on
c.project_manager=m.id),

main2 as (
select b.fy_timerange as fy,q.Project_Manager as level1,b.CODE from main b
left join lookup q on
q.code = b.code
group by b.fy_timerange,q.Project_Manager),

level1tab as (select m.name as level1 ,p.approver as level2,p.name as level1email from profile_27424 p
left join ds_mysql_prod_tagelement m on
m.id = p.pm_name),

level2tab as (select m.name as level1 , z.level1 as level2 from profile_27424 p
left join ds_mysql_prod_tagelement m on
m.id = p.pm_name
left join level1tab z on
z.level1email = p.approver),

new1 as (select p.fy,p.level1,d.level2,p.CODE from main2 p
left join level2tab d on
d.level1 = p.level1)



select  t.village,t.state,t.district,t.number_of_villages,t.c indirect,
t.d as direct,t.CODE,new1.level1 as level1manager, new1.level2 as level2manager, t.fy_timerange,t.projectcode,tab6.no_of_projects,tab6.no_of_implementing_agencies,t.total as Allocated_amount
from tab5 t
left join tab6 on t.CODE=tab6.CODE
left join new1 on t.CODE=new1.CODE



/*with tab2 as (select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange, 
concat(projectcode,fy_timerange) as CODE,
		sum(case p2.hdfc_cost_monthly when null then 0
		 else p2.hdfc_cost_monthly end) as finalhdfc_cost_monthly,
		 count(split_part(split_part( p2._id,'|',2),'|',2)) as villagecount,
		 p2.census_code as census_code
from profile_29974 p2
left join ds_mysql_prod_project prod
on prod.id=p2.projectid
left join ds_mysql_prod_tagelement f on
p2.fy=f.id

group by projectcode,f.name,census_code ),


tab3 as (select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange,
concat(projectcode,fy_timerange) as CODE,sum(case p6.monthly_cost when null then 0
		 else p6.monthly_cost end) as finalmonthly_cost
from profile_30171 p6
left join ds_mysql_prod_project prod
on prod.id=p6.projectid
left join ds_mysql_prod_tagelement f on
p6.fy=f.id

group by projectcode,f.name),


		 
finaltab as (select tab2.CODE,tab2.census_code, sum (tab2.villagecount) as totalvillagecount,
			 case totalvillagecount when null then tab2.finalhdfc_cost_monthly 
else (tab3.finalmonthly_cost/totalvillagecount) +(tab2.finalhdfc_cost_monthly) end
 as AllocatedAmount, 
tab2.fy_timerange 
from tab2 
left join tab3 on tab2.CODE=tab3.CODE
group by 	tab2.CODE,tab2.census_code,	tab2.fy_timerange ,tab2.finalhdfc_cost_monthly,tab3.finalmonthly_cost	),
			
tab1 as (select split_part(split_part(p1.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange, 
concat(projectcode,fy_timerange) as CODE,count(distinct p1.name) as no_of_projects, count(distinct p1.ngo_partner) as no_of_implementing_agencies
from profile_27396 p1
left join ds_mysql_prod_tagelement f on
p1.fy=f.id
		 group by projectcode,fy_timerange)
		 
select distinct p4.village as village, p4.state as State, p4.district as District,
tab1.no_of_projects,tab1.no_of_implementing_agencies,finaltab.AllocatedAmount,finaltab.fy_timerange from finaltab 

left join tab1 on tab1.CODE=finaltab.CODE
left join profile_27489 p4 on
finaltab.census_code=p4._id where finaltab.fy_timerange in('2019-2020')*/