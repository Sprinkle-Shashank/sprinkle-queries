WITH Y AS (
  SELECT P1.name AS projectname,
  P2.name AS partner,
  P3.name AS projectcategory,
  P4.name AS vertical,
  K.indicator AS indicator,
  RY.fy_timerange,
  RY._id,
  SUM(RY.value) AS progress,
  SUM(TY.value) AS target
  
  
  FROM profile_80302 AS RY

  LEFT JOIN ds_mysql_prod_project AS P1
  ON RY.projectid = P1.id

  LEFT JOIN ds_mysql_prod_project AS P2
  ON P1.parent = P2.id

  LEFT JOIN ds_mysql_prod_project AS P3
  ON P2.parent = P3.id

  LEFT JOIN ds_mysql_prod_project AS P4
  ON P3.parent = P4.id

  LEFT JOIN profile_80401 AS TY
  ON TY.indicator = RY.indicator
  AND TY.fy_timerange = RY.fy_timerange

  LEFT JOIN profile_80301 AS K
  ON RY.indicator = K._id
  
  GROUP BY 1,2,3,4,5,6,7,8,9
),

HY AS (
  SELECT P1.name AS projectname,
  P2.name AS partner,
  P3.name AS projectcategory,
  P4.name AS vertical,
  K.indicator AS indicator,
  RHY.fy_timerange,
  RHY._id,
  SUM(RHY.value) AS progress,
  SUM(THY.value) AS target
  
  FROM profile_80304 AS RHY

  LEFT JOIN ds_mysql_prod_project AS P1
  ON RHY.projectid = P1.id

  LEFT JOIN ds_mysql_prod_project AS P2
  ON P1.parent = P2.id

  LEFT JOIN ds_mysql_prod_project AS P3
  ON P2.parent = P3.id

  LEFT JOIN ds_mysql_prod_project AS P4
  ON P3.parent = P4.id

  LEFT JOIN profile_80402 AS THY
  ON THY.indicator = RHY.indicator
  AND THY.fy_timerange = RHY.fy_timerange

  LEFT JOIN profile_80301 AS K
  ON RHY.indicator = K._id
  
  GROUP BY 1,2,3,4,5,6,7,8,9
),

Q AS (
  SELECT P1.name AS projectname,
  P2.name AS partner,
  P3.name AS projectcategory,
  P4.name AS vertical,
  K.indicator AS indicator,
  RQ.fy_timerange,
  RQ._id,
  SUM(RQ.value) AS progress,
  SUM(TQ.value) AS target
  
  FROM profile_80305 AS RQ

  LEFT JOIN ds_mysql_prod_project AS P1
  ON RQ.projectid = P1.id

  LEFT JOIN ds_mysql_prod_project AS P2
  ON P1.parent = P2.id

  LEFT JOIN ds_mysql_prod_project AS P3
  ON P2.parent = P3.id

  LEFT JOIN ds_mysql_prod_project AS P4
  ON P3.parent = P4.id

  LEFT JOIN profile_80403 AS TQ
  ON TQ.indicator = RQ.indicator
  AND TQ.fy_timerange = RQ.fy_timerange

  LEFT JOIN profile_80301 AS K
  ON RQ.indicator = K._id
  
  GROUP BY 1,2,3,4,5,6,7
)

SELECT * FROM Y
UNION ALL
SELECT * FROM HY
UNION ALL
SELECT * FROM Q








































/*
with q as (
SELECT P1.name AS projectname,
P2.name AS partner,
P3.name AS projectcategory,
P4.name AS vertical,indicator as tq_indicator,fy_timerange,value as target

FROM profile_80403 AS tq

LEFT JOIN ds_mysql_prod_project AS P1
ON tq.projectid = P1.id

LEFT JOIN ds_mysql_prod_project AS P2
ON P1.parent = P2.id

LEFT JOIN ds_mysql_prod_project AS P3
ON P2.parent = P3.id

LEFT JOIN ds_mysql_prod_project AS P4
ON P3.parent = P4.id
)
, q1 as (
Select projectname,
 partner, projectcategory,
 vertical,tq_indicator,q.fy_timerange, target,rq.value as progress
 from q
LEFT JOIN profile_80305 AS RQ
ON q.tq_indicator = RQ.indicator
)
 ,
 hy as (
 SELECT P1.name AS projectname,
P2.name AS partner,
P3.name AS projectcategory,
P4.name AS vertical,indicator as thy_indicator,fy_timerange,value as target

FROM profile_80402 AS thy

LEFT JOIN ds_mysql_prod_project AS P1
ON thy.projectid = P1.id

LEFT JOIN ds_mysql_prod_project AS P2
ON P1.parent = P2.id

LEFT JOIN ds_mysql_prod_project AS P3
ON P2.parent = P3.id

LEFT JOIN ds_mysql_prod_project AS P4
ON P3.parent = P4.id
 )
,
hy1 as (

Select projectname,
 partner, projectcategory,
 vertical,thy_indicator,hy.fy_timerange, target,rhy.value as progress
 from hy
LEFT JOIN profile_80304 AS rhy
ON hy.thy_indicator = RHY.indicator
),

y as (
 SELECT P1.name AS projectname,
P2.name AS partner,
P3.name AS projectcategory,
P4.name AS vertical,indicator as y_indicator,fy_timerange,value as target

FROM profile_80401 AS y

LEFT JOIN ds_mysql_prod_project AS P1
ON y.projectid = P1.id

LEFT JOIN ds_mysql_prod_project AS P2
ON P1.parent = P2.id

LEFT JOIN ds_mysql_prod_project AS P3
ON P2.parent = P3.id

LEFT JOIN ds_mysql_prod_project AS P4
ON P3.parent = P4.id

),

y1 as (

Select projectname,
 partner, projectcategory,
 vertical,y_indicator,y.fy_timerange, target,ry.value as progress
 from y
LEFT JOIN profile_80302 AS ry
ON y.y_indicator = rY.indicator
)

, 

ff as (
Select * from q1
union all
Select * from hy1
union all
Select * from y1
)
, ff1 as (
Select projectname,
 partner, projectcategory,
 vertical, kpi.indicator ,kpi.type
 ,fy_timerange, target, progress,(progress - target) AS variance
 from ff
 left join profile_80301 as kpi
 on kpi._id=ff.tq_indicator
  
  group by 1,2,3,4,5,6,7,8,9
  
 )
 
 Select projectname,
 partner, projectcategory,
 vertical, indicator ,t.name as type
 ,fy_timerange, target, progress,variance
 from ff1
 LEFT JOIN ds_mysql_prod_tagelement AS T
ON ff1.type = t.id
  */