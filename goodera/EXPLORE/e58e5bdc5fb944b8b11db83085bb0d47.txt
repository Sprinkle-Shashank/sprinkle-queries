with sub1 as(
  select p1.*, 
  
  case
  		when IS_ARRAY(p1.annual_reports_ngo) = FALSE or GET_ARRAY_LENGTH(p1.annual_reports_ngo) = 0 				then ARRAY(p1.annual_reports_ngo)
  		else p1.annual_reports_ngo
  end as annual_reports_ngo_new,
  
  case
  		when IS_ARRAY(p1.audited_financials) = FALSE or GET_ARRAY_LENGTH(p1.audited_financials) = 0 				then ARRAY(p1.audited_financials)
  		else p1.audited_financials
  end as audited_financials_new,
  
  case
  		when IS_ARRAY(p1.itr_filed) = FALSE or GET_ARRAY_LENGTH(p1.itr_filed) = 0 				
  				then ARRAY(p1.itr_filed)
  		else p1.itr_filed
  end as itr_filed_new
  
  from profile_41361 p1),
  
sub2 as(
  select s1.*, cast(annual_reports_ngo_unwind as VARCHAR), cast(audited_financials_unwind as VARCHAR), cast(itr_filed_unwind as VARCHAR)
from sub1 s1, s1.annual_reports_ngo_new annual_reports_ngo_unwind, s1.audited_financials_new audited_financials_unwind, s1.itr_filed_new itr_filed_unwind)

select s2._id as id, nvl(p3.name, p2.name) as partner, t1.name as fy, s1.fy_timerange, s2.spoc_name, s2.spoc_number, s2.spoc_mail,

case
	when p2.name like '%COVID-19%' then split_part(p2.name, ' - ', 1)
	else p2.name
end as projectid

from sub2 s2

left join ds_mysql_prod_project p2 on p2.id = s2.projectid
left join ds_mysql_prod_project p3 on p3.id = p2.parent

left join ds_mysql_prod_tagelement t1 on t1.id = s2.fy