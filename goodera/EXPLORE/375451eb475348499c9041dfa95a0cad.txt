with base1 as(
select p._id, proj1.name as projectid, split_part(proj1.name,'|',1) as project_code, split_part(proj1.name,'|',4) as project_name, tag1.name as fy1, split_part(proj2.name,'|',1) as parent_code, p2.project_manager as project_manager_p2,  tag2.name as fy_p2, p3.project_manager as project_manager_p3, tag3.name as fy_p3, tag4.name as month from profile_54963 p
  left join ds_mysql_prod_project proj1 on p.projectid=proj1.id
  left join ds_mysql_prod_project proj2 on proj1.parent=proj2.id
  left join profile_27396 p2 on split_part(proj2.name,'|',1) = p2.name
  left join profile_27420 p3 on p3.project_code = p2._id
  left join ds_mysql_prod_tagelement tag1 on p.fy=tag1.id
  left join ds_mysql_prod_tagelement tag2 on p2.fy=tag2.id
  left join ds_mysql_prod_tagelement tag3 on p3.fy=tag3.id
  left join ds_mysql_prod_tagelement tag4 on p.month=tag4.id
  
),

base2 as(
select case when p.fy_p3 is not null or p.fy1<p.fy_p3 then p.fy_p2 else p.fy_p3 end as fy_p3, decode(p.project_manager_p3,null,p.project_manager_p2,p.project_manager_p3) as project_manager_p3, 
case when p.fy_p3<=p.fy1 or p.fy_p2<=p.fy1 then 1 else 0 end as flag, 
p.project_code, p.project_name, p.projectid, p.month, p.fy1, p.project_manager_p2,p.fy_p2, p._id from base1 p 
),

base3 as(
select p.* from base2 p where p.flag=1 order by p.fy_p3 desc
),

base4 as(
select *, row_number() over(partition by _id) as row_num from base3
),

base5 as(
select * from base4 where row_num=1
),

base6 as(
select p.*, case when p.fy_p3<=p.fy1 then p.project_manager_p3 else p.project_manager_p2 end as project_manager from base5 p
),

base7 as(
select p.project_code, p.project_name, p.project_manager, count(*) as activities_planned, listagg(distinct p.month,', ') as month, p.fy_timerange,p.projectid  from
  (
	select first_value(p.fy1) over (partition by p.project_code, p.project_name, p.project_manager) as fy_timerange, first_value(p.projectid) over (partition by p.project_code, p.project_name, p.project_manager) as projectid,p.* from base6 p
  ) as p
  group by 1,2,3,4,5,6
)

select p.* from base7 p
