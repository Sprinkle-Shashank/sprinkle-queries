with q as(
  select split_part(split_part(p1.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange,p1.name_project,
concat(projectcode,fy_timerange) as CODE,p7.name as ImplementingAgency,p8.name as interventiontype,p10.name as CoreArea , concat(concat(split_part(p1.start_date,' ',1),' to '), split_part(p1.end_date,' ',1)) as duration,m.name as project_manager, p1.state,
sum(case
   when interventiontype='Indirect - Others' then curr_yr_budget
   when interventiontype='Direct' then curr_yr_budget
   end)
as curr_yr_budget
from profile_27396 p1
left join ds_mysql_prod_tagelement f on
p1.fy=f.id
left join profile_27395 p7
on p7._id=p1.ngo_partner
left join profile_28235 p8
on p8._id=p1.intervention_type
left join ds_mysql_prod_tagelement p10
on p10.id=p1.focus_area
left join ds_mysql_prod_tagelement m on
p1.project_manager=m.id

	group by 1,2,3,4,5,6,7,8,9,10
union all
  
select split_part(split_part(split_part(p3.name,'|',1),'.',1),' ',1 ) as projectcode,
f.name as fy_timerange, p3.name_project,
concat(projectcode,fy_timerange) as CODE,p3.ngo as ImplementingAgency,p3.int_type_calc2 as interventiontype,p3.focus_area as CoreArea ,
concat(concat(split_part(p3.start_date,' ',1),' to '), split_part(p3.end_date,' ',1)) as duration,m.name as project_manager,' 'as state,
sum(case
   when interventiontype='Indirect - Others' then curr_yr_budget
   when interventiontype='Direct' then curr_yr_budget
   end)
as curr_yr_budget
from profile_27420 p3
left join ds_mysql_prod_tagelement f on
p3.fy=f.id 
left join ds_mysql_prod_tagelement m on
p3.project_manager=m.id
group by 1,2,3,4,5,6,7,8,9,10), /*data req from 27396 and 27420*/

q1 as (select qq.projectcode,qq.fy_timerange,qq.name_project,qq.curr_yr_budget,qq.CODE,qq.ImplementingAgency,qq.interventiontype,qq.CoreArea , qq.duration,qq.project_manager, st 
	   from q as qq,qq.state as st),
	
newtab1 as ( Select qq.projectcode, qq.fy_timerange ,qq.name_project, qq.curr_yr_budget total_allocated_amnt, (qq.curr_yr_budget/4) allocated_amnt_Q1, (qq.curr_yr_budget/4) allocated_amnt_Q2,(qq.curr_yr_budget/4) allocated_amnt_Q3, (qq.curr_yr_budget/4) allocated_amnt_Q4, qq.CODE, qq.ImplementingAgency, qq.interventiontype,qq.CoreArea , qq.duration,qq.project_manager, t1.name state
from q1 qq
left join ds_mysql_prod_tagelement t1
ON t1.id=qq.st),

new1 as (Select  split_part(split_part(prod.name,'|',1),'.',1) as projectcode,t.name as fy_timerange,concat(projectcode,fy_timerange) as CODE, split_part(prod.name,'|',3) as censuscode, 

case 
when p.month='April' then 'Quarter 1' 
when p.month='May' then 'Quarter 1' 
when p.month='June' then 'Quarter 1' 
when p.month='July' then 'Quarter 2' 
when p.month='August' then 'Quarter 2' 
when p.month='September' then 'Quarter 2' 
when p.month='October' then 'Quarter 3' 
when p.month='November' then 'Quarter 3' 
when p.month='December' then 'Quarter 3' 
when p.month='January' then 'Quarter 4' 
when p.month='February' then 'Quarter 4' 
when p.month='March' then 'Quarter 4' 
end as quarters,
		 
sum(case
	when p.hdfc_cost_monthly is null then 0 
	else p.hdfc_cost_monthly 
	end) 
as hdfc_cost_monthly
from profile_29974 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement t
on p.fy=t.id
group by 1,2,3,4),

new11 as (
  Select projectcode, fy_timerange, CODE, censuscode
  from new1
)

new2 as (
  select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,t.name as fy_timerange,concat(projectcode,fy_timerange) as CODE,
  sum(case 
	when p.monthly_cost is null then 0 
	  else p.monthly_cost  
	  end) 
 as monthly_cost 
  		 from profile_30171 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement t
on p.fy=t.id
left join ds_mysql_prod_tagelement t1
on p.month=t1.id
group by 1,2,3),

new3 as (Select new1.projectcode,  new1.fy_timerange, (new1.hdfc_cost_monthly+new2.monthly_cost) as allocated_amount,new1.CODE
from new1
left join new2
on new1.CODE=new2.CODE),

new4 as (Select projectcode,  new3.fy_timerange, sum(allocated_amount),CODE
from new3
group by 1,2,4)

Select * from new1