with sub1 as(
  select p1.time_timerange as fy_timerange, t1.name as focus_area
from profile_32441 p1
left join profile_63775 p2 on p2._id = p1.program_name
left join ds_mysql_prod_tagelement t1 on t1.id = p2.focus_area),

--Investment Details (Above)

sub2 as(
  select p3.fy_timerange, t2.name as focus_area
from profile_78057 p3
left join ds_mysql_prod_tagelement t2 on t2.id = p3.focus_area),

--ONE OFF (Above)

sub3 as(
  select p4.fy_timerange, t3.name as focus_area
from profile_78057 p4
left join ds_mysql_prod_tagelement t3 on t3.id = p4.focus_area),

--Brand Led (Above)

sub4 as(
  select p5.*, is_array(p5.indicator) as indicator_array_check,
  case 
  	when (indicator_array_check = false) then array(p5.indicator)
	else p5.indicator
  end as indicator_new
  from profile_55605 p5),
  
sub5 as(
  select s4.*, indicator_605 from sub4 s4, s4.indicator_new indicator_605),
  
sub6 as(
  select s5.time_timerange as fy_timerange, t4.name as focus_area
from sub5 s5
left join profile_55606 p6 on p6._id = s5.indicator_605
left join profile_55604 p7 on p7._id = p6.indicator
left join profile_63775 p8 on p8._id = p7.prog_name
left join ds_mysql_prod_tagelement t4 on t4.id = p8.focus_area),

--KPIs Data Input

sub7 as(
  select r1.*, len(cast(r1.start_date as varchar)) as start_date_len,
len(cast(r1.end_date as varchar)) as end_date_len,

case
	when (start_date_len = 13) then 
		cast(timestamp 'epoch' + CAST(r1.start_date AS BIGINT)/1000 * interval '1 second' as varchar)
	else r1.start_date
end as start_date_new,

case
	when (end_date_len = 13) then 
		cast(timestamp 'epoch' + CAST(r1.end_date AS BIGINT)/1000 * interval '1 second' as varchar)
	else r1.end_date
end as end_date_new,

case
	when r1.unwind_focus_area is not null 
	then r1.focus_area_name
	when r1.unwind_focus_area is null and r1.focus_area_array is not null and r1.focus_area_2_name is not null
	then r1.focus_area_2_name
  	when r1.unwind_focus_area is null and r1.focus_area_array is not null and r1.focus_area_2_name is null
	then 'Others'
	when r1.unwind_focus_area is null and r1.focus_area_array is null
	then r1.focus_area_2_name
	else null
end as focus_area

from rb_loghours r1),

sub8 as(
  select (s7.start_date_new||'|'||s7.end_date_new) as fy_timerange, t5.name as focus_area
  from sub7 s7
  left join profile_78929 p9 on p9.vol_focus_area_full = s7.focus_area
  left join ds_mysql_prod_tagelement t5 on t5.id = p9.focus_area),
  
--- Log Hours (Above) -- 
 
sub9 as(
  select (r2.start_date||'|'||r2.end_date) as fy_timerange, t6.name as focus_area
  from rb_volhours r2
  left join profile_78929 p10 on p10.vol_focus_area_full = r2.focus_area
  left join ds_mysql_prod_tagelement t6 on t6.id = p10.focus_area),

-- Volunteering Hours (Above) --

sub10 as(
  select fy_timerange, focus_area from sub1
	union all
  select fy_timerange, focus_area from sub2
	union all
  select fy_timerange, focus_area from sub3
	union all
  select fy_timerange, focus_area from sub6
	union all
  select fy_timerange, focus_area from sub8
	union all
  select fy_timerange, focus_area from sub9)
  
select fy_timerange, focus_area from sub10
where focus_area is not null


