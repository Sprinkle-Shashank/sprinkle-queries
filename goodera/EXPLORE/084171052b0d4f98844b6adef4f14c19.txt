--MylanIndia_Partnership_Projects_Project_Detail_KPI_Outline
with temp1 as
( select  p._id, projectId, fy_timerange, vertical, focus, description, sta.name as state_update, start_date, direct_or_partner, partner, place, district, project_code, entity , p.name as project_code_new , ent.name as entity_name from profile_62881 as p
 
 left join ds_mysql_prod_tagelement ent
 on p.entity = ent.id
 
 left join ds_mysql_prod_tagelement sta
 on p.state = sta.id
 ),
 
 temp2 as
 (
 select p._id, projectId , fy_timerange, vertical, focus, description, state_update, to_char(start_date ,'Month') as month_update , to_char(start_date ,'YY') as year_update , concat(month_update , year_update) as start_date_project , direct_or_partner, partner, place, district, project_code_new , entity_name as entity, vertical_new from temp1 as p, p.vertical vertical_new
   ),
   
  temp3 as
  (
   select _id, projectId , fy_timerange, focus, description, state_update , start_date_project , direct_or_partner, partner, place, district, project_code_new , entity, 
  
case 
when vert1.name IS NULL AND vert.name IS NOT NULL THEN vert.name
else vert1.name 
END AS vertical
from temp2 as p 
   
left join ds_mysql_prod_tagelement as vert
  on p.vertical_new = vert.id
  
left join ds_mysql_prod_tagelement as vert1
  on vert.parent = vert1.id
)
	
select * from temp3
   