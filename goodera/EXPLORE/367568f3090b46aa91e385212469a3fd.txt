

with table12 as
 ( 
  select p.projectid , p._id , status from profile_16619 as p
 ),
 
 table14 as
 (
 select p.projectid , p._id , ROW_NUMBER() over (partition by p.projectid order by p._id desc) as row, 1 as count , sta.name as status_update , status  from table12 as p
   
   
left join ds_mysql_prod_tagelement sta
on p.status = sta.id
   
),

table15 as
( select p.projectid , p._id , status_update , status from table14 as p where row=1 ),

table18 as
(
  select p.projectid , p._id , last_day_workers , workers_exited , day_1_workers , fac.name as factory , ven.name as vendor , cou.name as country , t5.status_update , ((last_day_workers + day_1_workers)/2) as d1 , (workers_exited/d1)*100 as inside from profile_16862 as p

left join ds_mysql_prod_project fac
on  p.projectid = fac.id

left join ds_mysql_prod_project ven
on fac.parent = ven.id

left join ds_mysql_prod_project cou
on ven.parent = cou.id

left join table15 t5
on p.projectid = t5.projectid 

where country != 'Test Country' and (t5.status_update is null or t5.status_update='Completed') )

select * from table20
