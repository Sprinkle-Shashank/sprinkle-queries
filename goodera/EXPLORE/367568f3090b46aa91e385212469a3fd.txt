with table12 as
(
select p.projectid , p._id , p.status , case when status is null then 0 else status end as status_update from profile_16619 as p 
),


table1 as 
(
  select p.sub_unit, t12.status_update as status,p._id,
  --filters
cou.name as country , 
nvl2(SUBSTRING(ven.name, 1, POSITION(' (' in ven.name)), SUBSTRING(ven.name, 1, POSITION(' (' in ven.name)),ven.name) as vendor_name, case when vendor_name='' then ven.name else vendor_name end as vendor, fac.name as factory ,
case when country in ('India', 'Bangladesh', 'Sri Lanka')
then 'South Asia'
when country in ('China')
then 'North Asia'
when country in ('Guatemala', 'El Salvador', 'Dominican Republic')
then 'Americas'
when country in ('Philippines', 'Cambodia',  'Vietnam',  'Indonesia', 'Myanmar')
then 'South East Asia'
end as region , 
case when p1.name_subunit is null or p1.name_subunit=' ' then  'N/A' else p1.name_subunit end  as unit,
cast(DATEPART(YEAR,p1.date_enrollment) as varchar) as year_new ,
--fy1.name as year_new,  
quarter1.name as quarter, fy1.name as fy
     
from profile_16863 p
  
 left join profile_16619  p1  
on  p.sub_unit =  p1._Id
  
  left join table12 t12 
  on p.sub_unit = t12._id
  
left join ds_mysql_prod_project fac
on p.projectid = fac.id
  
left join ds_mysql_prod_project ven
on fac.parent = ven.id
  
left join ds_mysql_prod_project cou
on ven.parent = cou.id
  
  left join ds_mysql_prod_tagelement quarter1 on
  p.quarter = quarter1.id
  
  left join ds_mysql_prod_tagelement fy1 on
  p.fy = fy1.id
  
  )
  
  select p.projectid , p._id , fac.name as factory  from profile_16863 as p
   
left join ds_mysql_prod_project fac
on p.projectid = fac.id