
with table1 as(select  _id, projectId, title, type, ngo, schedule_7, sdg, sdg_icon, s_date, e_date, p.desc, spoc_name, spoc_email, location, proj_img, outcome, spoc_contact, budget, status,TO_CHAR(s_date,'MM-DD-YYYY') as start_year,LEFT(e_date,10) as end_year, ((CAST(round(budget,2) as FLOAT))/(CAST(round(10000000,2) as FLOAT))) as real_budget from profile_76534 p),

table2 as (select t1.*,pic_1_befor from table1 t1 , t1.sdg_icon as pic_1_befor)
,
temp3 as(

select _id, projectId, title, type, ngo, schedule_7, sdg, sdg_icon, s_date,e_date, p.desc, spoc_name, spoc_email, location, proj_img, outcome, spoc_contact, budget, status,TO_CHAR(s_date,'DD-MM-YYYY') as start_year,TO_CHAR(e_date,'DD-MM-YYYY') as end_year,  CONCAT(CAST(real_budget as DECIMAL(10,2)),'Cr') AS real_budget,cast(pic_1_befor as varchar) as sdg_image_real,reg.name as ngo_name from table2 p


left join ds_mysql_prod_tagelement reg
on p.ngo= reg.id
)
select  _id, projectId, title, type, ngo, schedule_7, sdg, sdg_icon, s_date,e_date, p.desc, spoc_name, spoc_email, location, proj_img, outcome, spoc_contact, budget, status,start_year,end_year,  real_budget, listagg(sdg_image_real,',') as real , ngo_name from temp3 as p

group by  _id, projectId, title, type, ngo, schedule_7, sdg, sdg_icon, s_date,e_date, p.desc, spoc_name, spoc_email, location, proj_img, outcome, spoc_contact, budget, status,start_year,end_year,  real_budget, ngo_name

/*

with table12 as
 ( 
  select p.projectid , p._id , status from profile_16619 as p
 ),
 
 table14 as
 (
 select p.projectid , p._id , ROW_NUMBER() over (partition by p.projectid order by p._id desc) as row, 1 as count , sta.name as status_update from table12 as p
   
   
left join ds_mysql_prod_tagelement sta
on p.status = sta.id
   
),

table15 as
( select p.projectid , p._id , status_update from table14 as p where row=1 ),

table18 as
(
  select p.projectid , p._id , last_day_workers , workers_exited , day_1_workers , fac.name as factory , ven.name as vendor , cou.name as country , t5.status_update , ((last_day_workers + day_1_workers)/2) as d1 , (workers_exited/d1)*100 as inside from profile_16862 as p

left join ds_mysql_prod_project fac
on  p.projectid = fac.id

left join ds_mysql_prod_project ven
on fac.parent = ven.id

left join ds_mysql_prod_project cou
on ven.parent = cou.id

left join table15 t5
on p.projectid = t5.projectid 

where country != 'Test Country' and (t5.status_update is null or t5.status_update='Completed') ),

table20 as
(
  select p.projectid , factory , country , vendor , inside , count(p.projectid) as coun ,  from table18 as p
  
  where country != 'Test Country'
  
  group by 
   p.projectid , factory , country , vendor , inside  
 
  )

select * from table20

*/
