with tab1 as(SELECT q.name as project_code,t.name as fy,
       sum(CASE 
             WHEN p.budget_head = 'Admin Cost' THEN p.cost_yearly 
             ELSE 0 
           END) AS Admin_cost,
       sum(CASE 
             WHEN p.budget_head = 'Human Resource' THEN p.cost_yearly
             ELSE 0 
           END) AS Human_resource,
		sum(CASE 
             WHEN p.budget_head = 'NGO Management Cost' THEN p.cost_yearly
             ELSE 0 
           END) AS NGO_Management_Cost 
FROM   profile_29976 p
left join ds_mysql_prod_tagelement t on
p.fy=t.id
left join profile_27396 q on
p.prj_code=q._id
left join ds_mysql_prod_tagelement t2 on
q.project_manager=t2.id

GROUP  BY 1,2),
tab2 as(select distinct(k.village),q.name as project_code,t2.name as project_manager
		  from profile_29973 p
		  left join profile_27489 k
          on p.census_code=k._id
		  left join profile_27396 q on
          p.prj_code=q._id
		  left join ds_mysql_prod_tagelement t2 on
          q.project_manager=t2.id
		  group by 1,2,3),
		  
		  
tab3 as(select count(distinct(t1.village))as number_of_villages,t1.village,t.project_code,t.fy,t1.project_manager,t.Admin_cost,t.Human_resource,t.NGO_Management_Cost from tab1 t
left join tab2 t1 on
t.project_code=t1.project_code
group by 2,3,4,5,t.Admin_cost,t.Human_resource,t.NGO_Management_Cost),

tab4 as(select t2.village,t2.project_code,t2.fy,t2.project_manager,(t2.Admin_cost/t2.number_of_villages) as AC,(t2.Human_resource/t2.number_of_villages) as HRC,(t2.NGO_Management_Cost/t2.number_of_villages) as NMC from tab3 t2
where t2.number_of_villages!=0)
 SELECT distinct(t2.village),t2.project_code,t2.fy,t2.project_manager,t2.AC,t2.HRC,t2.NMC,(t2.AC/t3.number_of_villages) as AC1,(t2.HRC/t3.number_of_villages) as HRC1,(t2.NMC/t3.number_of_villages)as NMC1 from tab4 t2
 left join tab3 t3 on
 t3.project_code=t2.project_code
 where t3.number_of_villages!=0


