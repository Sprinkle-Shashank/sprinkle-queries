with tab1 as(select split_part(split_part(p1.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange,p1.name_project, 
concat(projectcode,fy_timerange) as CODE,p7.name as ImplementingAgency,p8.name as interventiontype,p10.name as CoreArea , concat(concat(split_part(p1.start_date,' ',1),' to '), split_part(p1.end_date,' ',1)) as duration,m.name as project_managerfromtab1
from profile_27396 p1
left join ds_mysql_prod_tagelement f on
p1.fy=f.id
left join profile_27395 p7
on p7._id=p1.ngo_partner
left join profile_28235 p8
on p8._id=p1.intervention_type
left join ds_mysql_prod_tagelement p10
on p10.id=p1.focus_area
left join ds_mysql_prod_tagelement m on
p1.project_manager=m.id
	
union all
select split_part(split_part(split_part(p3.name,'|',1),'.',1),' ',1 ) as projectcode,
f.name as fy_timerange, p3.name_project,
concat(projectcode,fy_timerange) as CODE,p3.ngo as ImplementingAgency,p3.int_type_calc2 as interventiontype,p3.focus_area as CoreArea ,
concat(concat(split_part(p3.start_date,' ',1),' to '), split_part(p3.end_date,' ',1)) as duration,m.name as project_managerfromtab1
from profile_27420 p3
left join ds_mysql_prod_tagelement f on
p3.fy=f.id 
left join ds_mysql_prod_tagelement m on
p3.project_manager=m.id
), /*data req from 27396 and 27420*/

tab2 as (select p.submission_date , t4.name as tranche,substring(p.submission_date,6,2) as months,t5.name as fy_timerange,(t.name) as response,case when response='Yes' then split_part(t2.name,'[',1)  when response ='No' then t3.name end as projectcode,case when response='Yes' then m.name when response ='No' then n.name end as project_manager,case when p.payment_amount is null then 0 else p.payment_amount  end as Amount_Disbursed,case when p.amnt_nt_utlzd is null then 0 else p.amnt_nt_utlzd  end as Amount_not_Utilised,RTRIM(projectcode)||fy_timerange as CODE from profile_27398 p
left join ds_mysql_prod_tagelement t
on p.renewal=t.id
left join profile_27396 t3 on
p.project_name=t3._id
left join profile_27420 t2 on
p.project_renew=t2._id
left join ds_mysql_prod_tagelement n on
t3.project_manager=n.id
left join ds_mysql_prod_tagelement m on
t2.project_manager=m.id
left join ds_mysql_prod_tagelement t4
on p.tranche=t4.id
left join ds_mysql_prod_tagelement t5
on p.fy=t5.id
where response is not null),

tab3 as (select t.fy_timerange,t.projectcode,t.name_project,
t.CODE,t.ImplementingAgency,t.interventiontype,t.CoreArea ,t.duration,
t2.project_manager,t2.submission_date ,t2.tranche,t2.Amount_Disbursed,t2.Amount_not_Utilised, 
case 
when t2.months='01' then 'Quarter 4' 
when t2.months='02' then 'Quarter 4' 
when t2.months='03' then 'Quarter 4' 
when t2.months='04' then 'Quarter 1' 
when t2.months='05' then 'Quarter 1' 
when t2.months='06' then 'Quarter 1' 
when t2.months='07' then 'Quarter 2' 
when t2.months='08' then 'Quarter 2' 
when t2.months='09' then 'Quarter 2' 
when t2.months=10 then 'Quarter 3' 
when t2.months=11 then 'Quarter 3' 
when t2.months=12 then 'Quarter 3' 

end as Quarters

from tab1 t
left join tab2 t2 on
t.CODE=t2.CODE)
select tab3.fy_timerange,tab3.projectcode,tab3.name_project,
tab3.CODE,tab3.ImplementingAgency,tab3.interventiontype,tab3.CoreArea ,tab3.duration,
tab3.project_manager,tab3.submission_date ,tab3.tranche,tab3.Quarters,tab3.Amount_Disbursed,tab3.Amount_not_Utilised, sum(tab3.Amount_Disbursed) as Amount_DisbursedforCurrentFY_total
from tab3 group by tab3.fy_timerange,tab3.projectcode,tab3.name_project,
tab3.CODE,tab3.ImplementingAgency,tab3.interventiontype,tab3.CoreArea ,tab3.duration,
tab3.project_manager,tab3.submission_date ,tab3.tranche,tab3.Quarters,tab3.Amount_Disbursed,tab3.Amount_not_Utilised,tab3.CODE

