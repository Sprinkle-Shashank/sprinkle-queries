select  sum(p2.payment_amount) as disbursed_amountforyear, f.name  as fy ,p1.name as projectcode ,
t1.name as Quarter,
case when p2.tranche= 'Tranche 1' then p2.payment_amount
else 0
	end as DisbursedAmountforQ1,
case when p2.tranche='Tranche 2' then (p2.payment_amount)
else '0'
	end as DisbursedAmountforQ2,
case when p2.tranche='Tranche 3' then (p2.payment_amount)
else '0'
	end as DisbursedAmountforQ3,
case when p2.tranche='Tranche 4' then (p2.payment_amount)
else '0'
	end as DisbursedAmountforQ4
	
from  profile_27398 p2 
left join profile_27396 p1 on
p1._id=p2.project_name
left join ds_mysql_prod_tagelement t1
on p2.tranche=t1.id
left join ds_mysql_prod_tagelement t2
on t1.parent=t2.id
left join ds_mysql_prod_tagelement f on
p2.fy=f.id
where f.name not in ('2015-2016','2016-2017','2017-2018')
group by f.name ,p1.name,t1.name, DisbursedAmountforQ1,DisbursedAmountforQ2,DisbursedAmountforQ3,DisbursedAmountforQ4

/*select  p2.payment_amount as disbursed_amountforyear, f.name  as fy ,p1.name as projectcode ,
t2.name as Quarter,
case when t2.name='Quarter 1' then (p2.payment_amount)
else '0'
	end as DisbursedAmountforQ1,
case when t2.name='Quarter 2' then (p2.payment_amount)
else '0'
	end as DisbursedAmountforQ2,
case when t2.name='Quarter 3' then (p2.payment_amount)
else '0'
	end as DisbursedAmountforQ3,
case when t2.name='Quarter 4' then (p2.payment_amount)
else '0'
	end as DisbursedAmountforQ4
	
from  profile_27398 p2 
left join profile_27396 p1 on
p1._id=p2.project_name
left join profile_29974 p3 on
p2.project_name=p3.prj_code
left join ds_mysql_prod_tagelement t1
on p3.month_number=t1.id
left join ds_mysql_prod_tagelement t2
on t1.parent=t2.id
/*left join profile_27398 p2 on
p1._id=p2.project_name	*/
left join ds_mysql_prod_tagelement f on
p2.fy=f.id
where f.name not in ('2015-2016','2016-2017','2017-2018')*/
/* disbursed amount for all year quarter wise*/

/*select sum(x.disbursed_amountforyear),x.fy,x.projectcode,x.quarter,x.DisbursedAmountforQ1,x.DisbursedAmountforQ2,x.DisbursedAmountforQ3,x.DisbursedAmountforQ4 from x group by x.fy,x.projectcode,x.quarter,x.DisbursedAmountforQ1,x.DisbursedAmountforQ2,x.DisbursedAmountforQ3,x.DisbursedAmountforQ4*/


/*group by f.name , p1.name, t2.name,DisbursedAmountforQ1,DisbursedAmountforQ2,DisbursedAmountforQ3,DisbursedAmountforQ4*/

/*select sum(x.disbursed_amountforyear),x.fy,x.projectcode,x.DisbursedAmountforQ1,x.DisbursedAmountforQ2,x.DisbursedAmountforQ3,x.DisbursedAmountforQ4 from x group by x.fy,x.projectcode,x.DisbursedAmountforQ1,x.DisbursedAmountforQ2,x.DisbursedAmountforQ3,x.DisbursedAmountforQ4 */
/* quarter wise disbursed amount fr projectwise financies with pivot*/



/*With x as(Select distinct(p9.village) as Village,p9.state as State,p1.name pd,t2.name as Quarter
from profile_29974 p8
left join ds_mysql_prod_project t5
on p8.projectid=t5.id
left join profile_27489 p9
on split_part(t5.name,'|',3)=p9.name
left join profile_27396 p1
on p1._id=p8.prj_code
left join ds_mysql_prod_tagelement t1
on p8.month_number=t1.id
left join ds_mysql_prod_tagelement t2
on t1.parent=t2.id),

y as(select p1.name as projectcode ,sum(d.payment_amount) as DisbursedAmount,sum(d.amnt_utlzd) as Utilized, f.name  as financial_year,t3.name as Core_Ares,t4.name as ProjectManager,p6.name as Intervention_Type,p7.name as Ngo_Partner
from profile_27396 p1
left join profile_27398 d on
p1._id=d.project_name 
left join ds_mysql_prod_tagelement f on
d.fy=f.id 
left join ds_mysql_prod_tagelement t3
on p1.focus_area=t3.id
left join ds_mysql_prod_tagelement t4
on p1.project_manager=t4.id
left join profile_28235 p6
on p1.intervention_type=p6._id
left join profile_27395 p7
on p1.ngo_partner=p7._id
group by f.name,p1.name,t3.name,t4.name,P6.NAME,P7.NAME)

Select distinct(x.village),x.state,y.projectcode,y.DisbursedAmount,Y.Utilized,x.Quarter,y.financial_year,y.Core_Ares,
y.ProjectManager,y.Intervention_Type,y.Ngo_Partner
from x
left join y
on x.pd=y.projectcode*/


/*select p8.name, case p8.name  when 'Indirect' then sum(p2.hdfc_cost_monthly+p6.monthly_cost)
  else sum(p3.curr_yr_budget+p1.curr_yr_budget)  end as AllocatedAmount , f.name  as financial_year from profile_27396 p1
left join profile_27420 p3
 on p1._id=p3.project_code
left join profile_29974 p2 on
p1._id=p2.prj_code 
left join profile_30171 p6 on
p1._id=p6.prj_code
left join ds_mysql_prod_tagelement f on
p1.fy=f.id 
left join profile_28235 p8
on p8._id=p1.intervention_type where f.name not in ('2015-2016','2016-2017','2017-2018')
group by f.name , p8.name*//*  allocated amount as Vidur said*/

/*with x as (select  case p8.name  when 'Indirect' then sum(p2.hdfc_cost_monthly+p6.monthly_cost)
  else sum(p3.curr_yr_budget+p1.curr_yr_budget)  end as AllocatedAmount , f.name  as financial_year from profile_27396 p1
left join profile_27420 p3
 on p1._id=p3.project_code
left join profile_29974 p2 on
p1._id=p2.prj_code 
left join profile_30171 p6 on
p1._id=p6.prj_code
left join ds_mysql_prod_tagelement f on
p1.fy=f.id 
left join profile_28235 p8
on p8._id=p1.intervention_type where f.name not in ('2015-2016','2016-2017','2017-2018')
group by f.name , p8.name)
select sum(x.AllocatedAmount) , x.financial_year from x group by  x.financial_year*/


/*with x as (select sum(p3.curr_yr_budget+p1.curr_yr_budget) as AllocatedAmount, f.name  as financial_year from profile_27396 p1
left join profile_27420 p3
 on p1._id=p3.project_code
left join ds_mysql_prod_tagelement f on
p1.fy=f.id where f.name not in ('2015-2016','2016-2017','2017-2018')
group by f.name 
		   union all 
		   Select sum(p1.allocated) as AllocatedAmount,f.name  as financial_year from profile_36762 p1
left join ds_mysql_prod_tagelement f on
p1.fy=f.id where f.name in ('2015-2016','2016-2017','2017-2018')
group by f.name )
select * from x*/

/*select p8.name as intervention_type,p1.name as projectcode, p2.hdfc_cost_monthly,p6.monthly_cost,p4.curr_yr_budget,
	  sum (p2.hdfc_cost_monthly+p6.monthly_cost+p4.curr_yr_budget)as allocatedamount, f.name as financial_year from  profile_27396 p1
left join profile_29974 p2 on
p1._id=p2.prj_code
left join profile_28235 p8
on p8._id=p1.intervention_type
left join profile_27420 p4 on
p1._id=p4.project_code 
left join profile_30171 p6 on
p1._id=p6.prj_code

left join ds_mysql_prod_tagelement f on
p1.fy=f.id where f.name  in ('2019-2020')
	   group by f.name,p8.name,p1.name,p2.hdfc_cost_monthly,p6.monthly_cost,p4.curr_yr_budget*//*year over yearsummary*/
	 
	  
/*with x as (select p8.name as intervention_type,p1.name as projectcode from profile_27396 p1
 left join profile_28235 p8
on p8._id=p1.intervention_type),
y as (select case x.intervention_type when 'Indirect' then sum(p2.hdfc_cost_monthly+p6.monthly_cost)
                                      else sum(p2.hdfc_cost_monthly+p6.monthly_cost+p4.curr_yr_budget)
	                                  end as AllocatedAmount ,f.name as financial_year from profile_29974 p2 
	  left join x on x.projectcode=p2.prj_code
left join profile_27420 p4 on
p2.prj_code=p4.project_code 
left join profile_30171 p6 on
p2.prj_code=p6.prj_code

left join ds_mysql_prod_tagelement f on
p2.fy=f.id where f.name not in ('2015-2016','2016-2017','2017-2018')
	  group by f.name,x.intervention_type) 
select * from y*/


 /*with x as (select p8.name as intervention_type,p1.name as projectcode from profile_27396 p1
 left join profile_28235 p8
on p8._id=p1.intervention_type),
y as (select case x.intervention_type when 'Indirect' then sum(p2.hdfc_cost_monthly+p6.monthly_cost)
                                      else sum(p2.hdfc_cost_monthly+p6.monthly_cost+p4.curr_yr_budget)
	                                  end as AllocatedAmount ,f.name as financial_year from profile_29974 p2 
	  left join x on x.projectcode=p2.prj_code
left join profile_27420 p4 on
p2.prj_code=p4.project_code 
left join profile_30171 p6 on
p2.prj_code=p6.prj_code

left join ds_mysql_prod_tagelement f on
p2.fy=f.id group by f.name,x.intervention_type) 
select * from y*/

/*join profile_29974 p2 on
p1._id=p2.prj_code


left join profile_27420 p4 on
p1._id=p4.project_code 
left join profile_30171 p6 on
p1._id=p6.prj_code

left join ds_mysql_prod_tagelement f on
p2.fy=f.id 
group by f.name,p8.name)
select sum(x.AllocatedAmount) as AllocatedAmount, x.financial_year from x group by x.financial_year*/

/*with x as (select sum(p2.payment_amount) as DisbursedAmount, f.name  as financial_year from profile_27398 p2
left join ds_mysql_prod_tagelement f on
p2.fy=f.id
group by f.name), 

y as  (Select sum(p1.two_percent) as TwoPercentAmount,f.name  as financial_year from profile_36762 p1
left join ds_mysql_prod_tagelement f on
p1.fy=f.id
group by f.name), 
z as (select x.financial_year from x
union select y.financial_year from y)


select x.DisbursedAmount, y.TwoPercentAmount, z.financial_year from z
left join x on z.financial_year=x.financial_year
left join y on z.financial_year=y.financial_year*//* year over year summary final two_percent, disbursed*/

/*select  split_part(split_part(prj_code,'|',1),'.',1)  as projectcode , prj_code from  profile_30171 p*/
/*select p1.name as Project_code  ,p7.name as ImplementingAgency,  p9.name as ProjectLive, p8.name as intervention_type, p10.name as CoreArea , concat(concat(split_part(p1.start_date,' ',1),' to '), split_part(p1.end_date,' ',1)) as duration, m.name as project_manager ,f.name as fy_timerange ,sum(p2.hdfc_cost_monthly+p6.monthly_cost+p4.curr_yr_budget) as AmountallocatedforthecurrentFYinINR/*,sum(p2.hdfc_cost_monthly+p6.monthly_cost) as AmountallocatedforQ1inINR, p6.month_number as quarter*/
from profile_27396 p1
left join profile_30171 p6 on
p1._id=p6.prj_code
left join profile_27395 p7 on 
p7._id=p1.ngo_partner
left join profile_28235 p8
on p8._id=p1.intervention_type
left join ds_mysql_prod_tagelement p9
on p9.id=p1.monitoring_live
left join ds_mysql_prod_tagelement p10
on p10.id=p1.focus_area
left join profile_29974 p2 on
p1._id=p2.prj_code
left join profile_27420 p4 on
p1._id=p4.project_code
left join ds_mysql_prod_tagelement f on
p1.fy=f.id
left join ds_mysql_prod_tagelement m on
p1.project_manager=m.id
group by  p1.name,p7.name, p9.name,p8.name ,p10.name,duration,m.name ,f.name*/

