select p1.projectId, p1.country, p1.vendor, p1.cycle,  p1.product_category ,p2.name as consultant,p3.end_date, p3.actual_end_date, p3.program_level_milestone as milestone,
--if(ne($actual_end_date,NA), if(lte($actual_end_date,$end_date),"Completed", if(gt($actual_end_date,$end_date),"Delayed, but Completed",NA)),NA)

case 
when actual_end_date = Null or actual_end_date <= p3.end_date  then 'Compeleted'
when actual_end_date >= p3.end_date then  'Delayed but completed' 
else 'NA'
end as status ,
count(*) as count
from profile_64362 p1
left join profile_61583 p2
on p1.consultant= p2._id
left join profile_64141 p3
on p1.projectId=p3.projectId
where status = 'Delayed but completed'
Group by p1.projectId, p1.country, vendor, p1.cycle, product_category, consultant, p3.end_date, actual_end_date, milestone, status,p2.name,p3.program_level_milestone

