with t1 as
(select * from
(
  select projectid.name as projectid, fy_timerange, bd_1 as bd_1_update, bd_2 as bd_2_update, bd_3 as bd_3_update, bd_4 as bd_4_update , bd_1, bd_2, bd_3, bd_4
 
from profile_55424 as p
 
 left join ds_mysql_prod_project as projectid
 on p.projectid = projectid.id
   )
 UNPIVOT (
  disbursed_amount for allocated IN (bd_1, bd_2, bd_3, bd_4))),

 
 t2 as
 (
 select projectid, fy_timerange, allocated, bd_1_update, bd_2_update, bd_3_update, bd_4_update, sum(disbursed_amount) as disbursed_amount_sum
   from t1
 group by projectid, fy_timerange, bd_1_update, bd_2_update, bd_3_update, bd_4_update, allocated
   ),
   
   t3 as
   (
	 select p.*, 
	 
	 case when allocated=bd_1_update then "Tool Development and Completion"
  when allocated=bd_2_update then "Sign-Off"
  when allocated=bd_3_update then "Live"
  when allocated=bd_4_update then "AMC"
  else '-'
  end as status
	 from t2 as p
	 )
   select projectid, fy_timerange, allocated, disbursed_amount_sum from t2
 

