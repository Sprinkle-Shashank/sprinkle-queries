with sub1 as(
select sq.*,pd.pvh_id, mr.partner_type, mr.name_vendor, mr.name_vendor_filter, json_serialize(ab.source_div) as source_div, rtrim(ltrim(json_serialize(ab.region),'['),']') as region, ab.region_parent, ab.timeperiod_timerange
from profile_62491 sq
left join profile_62948 pd
on sq.project_id=pd.project_id
left join profile_62482 mr
on mr.project_id=sq.project_id
left join profile_60928 ab
on ab.factory_id=pd.pvh_id
where coalesce(lg_status,0)!=1105812 and pd.pvh_id is not null
order by ab.timeperiod_timerange desc
  ),
  sub2 as (
	select name, fy_timerange, num_females, project_id, pvh_id, partner_type, name_vendor, name_vendor_filter,
   first_value(source_div)
over(partition by name, fy_timerange, num_females, project_id, pvh_id, partner_type, name_vendor, name_vendor_filter
order by cast(timeperiod_timerange.start as date) desc
rows between unbounded preceding and unbounded following) as source_div_new, 
	first_value(region)
over(partition by name, fy_timerange, num_females, project_id, pvh_id, partner_type, name_vendor, name_vendor_filter
order by cast(timeperiod_timerange.start as date) desc
rows between unbounded preceding and unbounded following) as region_new
	from sub1
  ), 
  sub3 as(
	select name, fy_timerange, num_females, project_id, pvh_id, partner_type, name_vendor, name_vendor_filter,SPLIT_TO_ARRAY(source_div_new,',') as source, SPLIT_TO_ARRAY(region_new,',') as region from sub2
	group by name, fy_timerange, num_females, project_id, pvh_id, partner_type, name_vendor, name_vendor_filter, source_div_new, region_new),
	
	sub31 as(
	  select fy_timerange, pvh_id, cast(region_new as varchar), num_females, source from sub3 s2, s2.region region_new),
	sub4 as
	(
	select fy_timerange, pvh_id, t.name as region, sum(num_females) as num_females from sub31
	  left join ds_mysql_prod_tagelement t
	  on t.id=region_new
	  where source is not null and region_new is not null
	group by fy_timerange, pvh_id, t.name), 
	sub5 as
	(select region, fy_timerange, 'P.A.C.E.' as program, listagg(distinct pvh_id,', ') as count from sub4
	 group by region, fy_timerange)
	 /*
	 select region, fy_timerange,program from sub5
	 where cast*/
	 select * from sub5