with sub1 as (select p1.name as projectid,t1.name as financial_period, datatablebase, tablesettings, questiontext, fy_timerange

from sus_56551 p1
left join ds_mysql_prod_tagelement t1 on t1.id=p1.financialperiod
where keyword='cdp_cc_8_consumed'),

sub2 as (select *,temp.consumption,cast(temp.quality as varchar),cast(temp.importance_local as varchar) from sub1 s1,unpivot s1.datatablebase as temp at source)

select projectid, financial_period, consumption, quality, importance_local, questiontext, fy_timerange, (Initcap(split_part(source, '_', 1)) || ' ' || split_part(source, '_', 2)) as source_text,('FY' || ' ' || split_part(financial_period, ' ', 2)) as FY,source,
case
when source='ground_water' then cast(tablesettings."ground_water"."consumption"."measureUnitBase" as VARCHAR)
when source='purchased_water' then cast(tablesettings."purchased_water"."consumption"."measureUnitBase" as VARCHAR) 