with sub1 as (select p1.name as projectid,t1.name as financial_period, datatablebase, tablesettings, questiontext, fy_timerange

from sus_56551 p1
left join ds_mysql_prod_tagelement t1 on t1.id=p1.financialperiod
where keyword='cdp_cc_8_consumed'),

sub2 as (select *,temp.cdp_cc_8_1_heat,cast(temp.cdp_cc_8_1_country as varchar),temp.cdp_cc_8_1_steam,temp.cdp_cc_8_1_cooling,temp.cdp_cc_8_1_electricity from sub1 s1,unpivot s1.datatablebase as temp at rows)

select projectid, financial_period, cdp_cc_8_1_heat,cdp_cc_8_1_country, cdp_cc_8_1_steam, cdp_cc_8_1_cooling, cdp_cc_8_1_electricity, questiontext, fy_timerange,('FY' || ' ' || split_part(financial_period, ' ', 2)) as FY,rows,
case
when source='cdp_cc_8_1_heat' then cast(tablesettings."0"."cdp_cc_8_1_heat"."measureUnitBase" as VARCHAR)
when source='cdp_cc_8_1_country' then cast(tablesettings."0"."cdp_cc_8_1_country"."measureUnitBase" as VARCHAR) 
when source='cdp_cc_8_1_steam' then cast(tablesettings."0"."cdp_cc_8_1_steam"."measureUnitBase" as VARCHAR)
when source='cdp_cc_8_1_cooling' then cast(tablesettings."0"."cdp_cc_8_1_steam"."measureUnitBase" as VARCHAR) 
when source='cdp_cc_8_1_electricity' then cast(tablesettings."0"."cdp_cc_8_1_steam"."measureUnitBase" as VARCHAR) 
else null
end as units
from sub2
where rows is not null
group by projectid, financial_period, cdp_cc_8_1_heat,cdp_cc_8_1_country, cdp_cc_8_1_steam, cdp_cc_8_1_cooling, cdp_cc_8_1_electricity, questiontext,fy_timerange,rows,units