with sub1 as(
	select p1.project_id, p1.fy_timerange, p2.pvh_id, p3.region
from profile_62491 p1
	left join profile_62948 p2 on p2.project_id = p1.project_id
	left join profile_60928 p3 on p2.pvh_id = p3.factory_id),
	
sub2 as(
  select s1.*, cast(country as int) from sub1 s1, s1.region country)
  
select project_id, fy_timerange, pvh_id, first_value(country) over (partition by project_id, pvh_id,fy_timerange order by cast(fy_timerange.start_date as date) desc rows between unbounded preceding and unbounded following) as country from sub2 group by project_id, pvh_id, country, fy_timerange