with temp as(
  Select 'Q1' as col
  union all
    Select 'Q2' as col
  union all
    Select 'Q3' as col
  union all
    Select 'Q4' as col
),
s as(
select f.name  as fy ,p1.name as projectcode ,

case when t1.name= 'Tranche 1' then p2.payment_amount
else 0
    end as DisbursedAmountforQ1,
case when t1.name='Tranche 2' then (p2.payment_amount)
else '0'
    end as DisbursedAmountforQ2,
case when t1.name='Tranche 3' then (p2.payment_amount)
else '0'
    end as DisbursedAmountforQ3,
case when t1.name='Tranche 4' then (p2.payment_amount)
else '0'
    end as DisbursedAmountforQ4
    
from  profile_27396 p1
left join profile_27398 p2  on
p1._id=p2.project_name
left join ds_mysql_prod_tagelement t1
on p2.tranche=t1.id
left join ds_mysql_prod_tagelement t2
on t1.parent=t2.id
left join ds_mysql_prod_tagelement f on
p2.fy=f.id
where f.name not in ('2015-2016','2016-2017','2017-2018')
group by 1,2,3,4,5,6
),
s2 as (
Select fy , projectcode ,temp.col as quarter,
sum(case col 
    when 'Q1' then s.DisbursedAmountforQ1
	when 'Q2' then s.DisbursedAmountforQ2
	when 'Q3' then s.DisbursedAmountforQ3
	when 'Q4' then s.DisbursedAmountforQ4
	else 0
	end) as DisbursedAmount
from s
cross join temp
group by fy , projectcode ,temp.col
)
Select fy , projectcode , 
Sum(CASE 
             WHEN quarter = 'Q1' THEN DisbursedAmount
             ELSE 0 
           END) AS DisbursedAmountforQ1,
Sum(CASE 
             WHEN quarter = 'Q2' THEN DisbursedAmount
             ELSE 0 
           END) AS DisbursedAmountforQ2,
		   Sum(CASE 
             WHEN quarter = 'Q3' THEN DisbursedAmount
             ELSE 0 
           END) AS DisbursedAmountforQ3,
		   Sum(CASE 
             WHEN quarter = 'Q4' THEN DisbursedAmount
             ELSE 0 
           END) AS DisbursedAmountforQ4
		   from s2
group by 	fy , projectcode , quarter	   

/* disbursedamount final for allquarters and full year*/