with table1 as
(select p.projectid , p._id ,  fac.name as factory , sta.name as status_update , p2.factory_id , cou.name as country from profile_16619 as p
 
 left join ds_mysql_prod_project fac 
on p.projectId = fac.id
 
left join profile_4722 p2 on 
p.projectid = p2.projectid
 
left join ds_mysql_prod_tagelement sta 
on p.status = sta.id
 
left join ds_mysql_prod_project ven 
on fac.parent = ven.id

left join ds_mysql_prod_project cou 
on ven.parent = cou.id

 where status_update = 'Completed' or status_update is null 
 and cou.name != 'Test Country' and cou.name !='GAP Inc.' 
-- where status <> 437658 and status <> 437659
),

table2 as 
(
 select ROW_NUMBER() over (order by p.projectid ) as serial_number  , p._id, p.projectid , 
  case when p.name_subunit is null or p.name_subunit=' ' then 'N/A' else p.name_subunit end  as unit , ven.name as vendor , cou.name as country 
  
, t1.factory , t1.factory_id  ,  case when extract(month from date_enrollment)=1 then (extract(year from date_enrollment)-1) else extract(year from date_enrollment) end as batch  from profile_16619 p
  
left join ds_mysql_prod_project fac 
on p.projectId = fac.id

left join ds_mysql_prod_project ven 
on fac.parent = ven.id

left join ds_mysql_prod_project cou 
on ven.parent = cou.id
 
left join table1 t1 on 
p._id = t1._id
  
  )


select * from table2