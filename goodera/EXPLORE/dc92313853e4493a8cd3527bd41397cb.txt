with t1 as 
(select _id, projectid, ngo, proj, tag1.name as proposed, tag2.name as approved, tag3.name as ongoing, tag4.name as completed, tag5.name as disqualify, p1.name as ngo_projects_name
from profile_70244 p1
left join ds_mysql_prod_tagelement tag1
on p1.proposed = tag1.id
left join ds_mysql_prod_tagelement tag2
on p1.approved = tag2.id
left join ds_mysql_prod_tagelement tag3
on p1.ongoing = tag3.id
left join ds_mysql_prod_tagelement tag4
on p1.completed = tag4.id 
left join ds_mysql_prod_tagelement tag5
on p1.disqualify = tag5.id),

t2 as 
(select t1._id, t1.projectid, t1.ngo, t1.proj,
case 
when disqualify = 'Yes' or approved = 'No' or ongoing = 'No' or completed = 'No' or proposed = 'No' then 'Disqualified'
when completed = 'Yes' then 'Completed'
when ongoing = 'Yes' then 'Ongoing'
when approved = 'Yes' then 'Approved'
when proposed = 'Yes' then 'Proposed'
else 'NA'
end as status, p2.remarks, p2.upload, p2.type, p2.date, tag2.name as parent, cast('Download' as VARCHAR) as download, t1.ngo_projects_name
from t1
left join profile_70245 p2
on t1._id = p2.ngo_projects
left join ds_mysql_prod_project tag1
on t1.projectid = tag1.id
left join ds_mysql_prod_project tag2
on tag1.parent = tag2.id
where upload is not null),

t3 as 
(select t2._id, t2.projectid, t2.ngo, t2.proj, t2.status, t2.remarks, t2.upload, t2.type, t2.date, t2.parent, t2.download, 
case
when status = 'Completed' then 1
when status = 'Approved' then 2
when status = 'Proposed' then 3
when status = 'Ongoing' then 4
else 5 end as sort, extract ( YEAR from t2.date) as year, extract ( MONTH from t2.date) as month,
case when month <= 3 then (year-1) else year end as start, t2.ngo_projects_name
from t2),

t4 as 
(select  t3._id, t3.projectid, t3.ngo, t3.proj, t3.status, t3.remarks, t3.upload, t3.type, t3.date, t3.parent, t3.download, t3.sort, t3.year, t3.month, t3.start
, start+1 as end, concat(start, '-04-01T00:00:00.000Z') as start_date, t3.ngo_projects_name
from t3),

t5 as 
(select _id, projectid, ngo, proj, status, t4.date, remarks, upload, type, parent, download, sort, start_date, 
concat(t4.end, '-04-01T00:00:00.000Z') as end_date, 
concat(concat(concat(concat('{"start":"',start_date),'","end":"'),end_date),'"}') as fy_timerange, SUBSTRING(start_date,1,4) as start, t4.ngo_projects_name
from t4),

t6 as 
(select _id, projectid, ngo, proj, status, t5.date, remarks, upload, parent, t5.type, download, sort, start_date, end_date, fy_timerange, start, SUBSTRING(end_date,1,4) as end , t5.ngo_projects_name
from t5)

select _id, tag1.name as projectid, tag2.name as ngo, t6.proj, t6.status, t6.date, t6.remarks, t6.upload, tag3.name as type, t6.parent, t6.download, t6.sort, t6.start_date, t6.end_date, t6.fy_timerange, 
concat(concat(concat('FY ', t6.start), ' - '), t6.end) as financial_year, t6.ngo_projects_name
from t6
left join ds_mysql_prod_project tag1
on t6.projectid = tag1.id
left join ds_mysql_prod_tagelement tag2
on t6.ngo = tag2.id
left join ds_mysql_prod_tagelement tag3
on t6.type = tag3.id
--where remarks = '80G receipt for Rs 17,98,123'
--where ngo is 'National Agro Foundation - Integrated Watershed Management Program-FY (2020 - 2021)'
order by fy_timerange, sort





 














 



