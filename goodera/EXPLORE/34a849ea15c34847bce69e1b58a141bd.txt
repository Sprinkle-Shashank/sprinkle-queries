
with table1 as (
select substring(p1.start_date, 9,2) as date1,substring(p1.start_date, 6,2) as month1 ,substring(p1.start_date, 1,4) as year1, p1.start_date,
substring(p1.end_date, 9,2) as date2,substring(p1.end_date, 6,2) as month2 ,substring(p1.end_date, 1,4) as year2, p1.end_date,
  actual_end_date ,p1.projectId ,p1.remarks, p1.microbenefits_milestone,p1.consultant_milestone,p1.other_milestone,p1.milestone_name,p1.program_level_milestone
from profile_64141 as p1)
,t1 as

(select t1.projectId, 
substring(actual_end_date,9,2) as date3 , substring(actual_end_date, 6,2) as month3 ,substring(actual_end_date, 1,4) as year3,
date1 ||'-'|| month1||'-' ||year1 as start_date1 ,
date2 ||'-'|| month2||'-' ||year2 as end_date1,
date3 ||'-'|| month3||'-' ||year3 as actual_end_date1,
tag4.name as country, p7.factory, p2.vendor, p2.product_category, tag5.name as consultant, current_date as current_date,p2.cycle,
 remarks, microbenefits_milestone,consultant_milestone,other_milestone,milestone_name,program_level_milestone,
case 
when actual_end_date1 <= end_date1 then 'Completed'
when current_date <end_date1 then 'On-Track' 
else 'Delayed, but Completed' 
end as status
from table1 as t1
left join profile_64362 p2
on t1.projectId=p2.projectId
left join tagElement_7746 tag4
on p2.country = tag4.id
left join profile_64170 as p7
on p2.factory = p7._id
left join tagElement_7746 tag5
on p2.consultant_tag = tag5.id
)
select  r.projectId, remarks, microbenefits_milestone, p9.cycle, product_category,factory,consultant_milestone,other_milestone,milestone_name,program_level_milestone,r.start_date1 as start_date,end_date1 as end_date ,actual_end_date1 as actual_end_date,vendor,consultant,country,current_date,status 

left join profile_64362 as p9
on r.projectId=p9.projectId

from t1	 as r
	