with table1 as ( select _id ,projectid, pro.name as factory,pace_status as facility_status,row_number() over 
(partition by projectid
 order by _id desc) as row from profile_54267 p
		left join ds_mysql_prod_project as pro
on p.projectid = pro.id	   ),

table2 as ( select * from table1 
		  where row = 1),

module_completed as (  select class, count(*)as completed from profile_4228
					 where end_date is not null
					 group by class),
module_ongoing as ( select class, count(*)as ongoing from profile_4228
					 where end_date is  null
					 group by class),
table7 as ( SELECT _id,mon.creatorid, u.email as cemail, mon.modifierid, m.email as memail
from ds_mongo_profileinstance mon
left join ds_mysql_prod_user u on
mon.creatorid = u.id
left join ds_mysql_prod_user m  on
mon.modifierid = m.id
where mon.profileId='4227' and mon.active = 't' and mon.securitycontextid is not null
			 ),		
creationdate_table_for_batch as (	select p._id,p.projectid,p.name,/*substring(createddate,1,10)*/ modifieddate as batch_date,t7.cemail,p.end_date_2,t7.memail from profile_4227 p   
 left join table7 t7 on
	p._id = t7._id	
	--where end_date_2 is not null
								),
	
table8 as ( SELECT _id,mon.creatorid, u.email as cemail, mon.modifierid, m.email as memail
from ds_mongo_profileinstance mon
left join ds_mysql_prod_user u on
mon.creatorid = u.id
left join ds_mysql_prod_user m  on
mon.modifierid = m.id
where mon.profileId='4228' and mon.active = 't' and mon.securitycontextid is not null
			 ),	
 
 creationdate_table_for_module as (	select p._id,p.class, p.projectid,/*substring(createddate,1,10)as*/modifieddate as module_date,row_number() over 
(partition by class
 order by createddate desc) as row,t8.cemail,t8.memail from profile_4228 p
			left join table8 t8 on
			p._id = t8._id					  )	,
	
table5 as ( select * from creationdate_table_for_batch 
			--where row = 1 
		   ),
			
 table6 as ( select * from creationdate_table_for_module 
			where row = 1 ),
  
 creation_date as ( select t5._id,t5.projectid,batch_date,t5.memail as batch_email,t6.module_date,t6.memail as module_email from table5 t5
  
  left join table6 t6 on 
  t5._id= t6.class ),	
/* table for factory_locationid */
factory_locationid as (
  with 
table1 as ( select  p._id, p.projectid,q.factory_vpid as location_id,
		   row_number() over 
           (partition by p._id
            order by p._id desc) as row,r.cp_location_id,q.pace_status_2 from  profile_4227 p
				  left join profile_52713 q on
                  p.projectid = q.projectid
		          left join profile_4948 r on
		          p.projectid = r.projectid
		          left join ds_mysql_prod_project as pro
                  on p.projectid = pro.id
		          where  location_id is not null and cp_location_id is null
  ),
table2 as (select p._id,p.projectid,q.cp_location_id as location_id,q.pace_status_2 from profile_4227 p
		   left join profile_4948 q on
		   p.projectid = q.projectid
		  where  location_id is not null
		  ),
 table3 as ( 
select * from table1  
 where row = 1)
 select _id,projectid,location_id,pace_status_2 from table3
 union all
  select _id,projectid,location_id,pace_status_2 from table2
  /* 99 factories are not there in add_factory*/
),
brand_table as ( select projectid,brand_old,pace_brand from profile_52810 p , p.pace_brands pace_brand ),

test as (					 
select p._id,p.projectid,
case when add_factory.sourcing_yn =57472 and t2.facility_status = 845114 then   		  			mapping.name_factory
     
     when add_factory.sourcing_yn = 57473 and (add_factory.pace_status_2 in (845114 )or           add_factory.pace_status_2 is null) then   mapping.name_factory 
	when add_community.pace_status=182398 then mapping.name_factory end as factory,
     f_id.location_id as factory_locationid,
case when start_year >= 2020 and extract(month from start_date) >= 10 and   			   factory ilike '%CP%' then brand_pace.name
	   when start_year >= 2020 and factory ilike '%Factory%' then brand_pace.name
	   else brand_old.name end as brand,mapping.name_vendor_filter,
  cast(add_factory.factory_vpid_1 as varchar(65535)) as vpid_1,	
case when add_factory.sourcing_yn =57472 then vpid_1 
     when add_factory.sourcing_yn =57473 and add_factory.pace_status_2 = 845114  then    		factory_vpid_2
	 when add_community.pace_status = 182398 then add_community.cp_id  end as     			 vpid_and_cpid, 
    mapping.name_country, start_year as financial_year, status.name as
     "pace status",createddate,modifieddate,start_date
  
  
  
/*	 add_factory.sourcing_yn,t2.facility_status,add_factory.pace_status_2,add_community.pace_status
,end_date_2,cast(add_factory.factory_vpid_1 as varchar(65535)) as vpid_1,
case when add_factory.sourcing_yn =57472 then vpid_1 
     when add_factory.sourcing_yn =57473 then add_factory.factory_vpid_2
	 when add_community.pace_status = 182398 then add_community.cp_location_id  
	 end as       community_id
,mapping.name_vendor_filter,
case when add_community.pace_status = 182398 then add_community.cp_id
     else add_factory.child_vendor_vpid end as vp_id_and_cp_id  */

/*,mapping.name_country,mapping.name_vendor,mapping.name_rp,start_date,
concat('FY ' ,to_char(start_date,'YYYY')) as start_year ,
end_date,num_females,module_completed.completed, module_ongoing.ongoing,
case when t_cd.module_date > t_cd.batch_date then t_cd.module_date
     else t_cd.batch_date end as latest_date,
concat(split_part(current_date,' ',1),'T00:00:00.000Z') AS current_date1,
cast(current_date1 as datetime) as current_date,
case when t_cd.module_date > t_cd.batch_date then t_cd.module_email
     else t_cd.batch_email end as email_id
case when current_date-latest_date<= 30 then 'Updated in last 30 days'
	when 30< current_date-latest_date<= 90 then 'No updates in the last 30 days'
		  else 'No updates in the last 90 days' end as Date_range*/ 
	 
	 
	 from profile_4227 p



/*left join module_completed  on 
p._id = module_completed.class

left join module_ongoing  on 
p._id = module_ongoing.class

left join creation_date t_cd on
p._id = t_cd._id
*/
left join profile_52713 add_factory on
p.projectid = add_factory.projectid

left join profile_54646 mapping on
p.projectid = mapping.projectid 

left join profile_4948 add_community on
p.projectid = add_community.projectid

left join table2 t2 on
p.projectid = t2.projectid
left join ds_mysql_prod_project as pro
on p.projectid = pro.id
left join factory_locationid f_id on
  p._id = f_id._id
left join brand_table on 
p.projectid = brand_table.projectid
left join ds_mysql_prod_tagelement as brand_old
on brand_table.brand_old = brand_old.id
left join ds_mysql_prod_tagelement as brand_pace
on brand_table.pace_brand = brand_pace.id  
left join ds_mysql_prod_tagelement as status
on f_id.pace_status_2 = status.id  
  
--where end_date_2 is not null
)

select * from test
where factory is not null 

--select * from factory_locationid



