with sub1 as(
	select p1.name, p1.fy_timerange, p2.pvh_id, p3.region, p1.end_date_2 as end_date, p1.num_females, p1.project_name, p3.source_div , extract(year from cast(fy_timerange.start as date)) as year, extract(month from cast(fy_timerange.start as date)) as month,p3.vendor_name
from profile_62491 p1
	left join profile_62948 p2 on p2.project_id = p1.project_id
	left join profile_60928 p3 on p2.pvh_id = p3.factory_id
    where  year >= 2020 and p2.pvh_id is not NULL and COALESCE(lg_status,0)!=1105812 
  and p2.offset_date<=p1.start_date ),
	sub12 as
	(select sub1.*, case when vendor_name='CARE Ethiopia' then (case when year=2020 then (case when month<8 then 'Take' end) end) else 'Ignore' end as mix from sub1),	
sub2 as(
  select fy_timerange, pvh_id, region, source_div, sum(num_females) as num_females
  from sub12
    where mix='Ignore'
	group by fy_timerange, region, pvh_id, source_div, num_females, name),
	
sub3 as(
  select s2.*, source_div1, country from sub2 s2, s2.region country, s2.source_div source_div1)

select s3.fy_timerange, s3.pvh_id, t1.name as region, t2.name as source_div, sum(num_females) as fems
	from sub3 s3
	left join ds_mysql_prod_tagelement t1 on t1.id = s3.country
	left join ds_mysql_prod_tagelement t2 on t2.id =s3.source_div1
	group by s3.fy_timerange, t1.name, s3.pvh_id, t2.name