with temp as(Select 'Human Resource Cost' as col
union all
Select 'Admin Cost' as col
union all
Select 'NGO Management Cost' as col
),



tab1 as(SELECT q.name as projectcode,t.name as fy_timerange,
       sum(CASE 
             WHEN p.budget_head = 'Admin Cost' THEN p.cost_yearly 
             ELSE 0 
           END) AS Admin_cost,
       sum(CASE 
             WHEN p.budget_head = 'Human Resource' THEN p.cost_yearly
             ELSE 0 
           END) AS Human_resource,
		sum(CASE 
             WHEN p.budget_head = 'NGO Management Cost' THEN p.cost_yearly
             ELSE 0 
           END) AS NGO_Management_Cost 
FROM   profile_29976 p
left join ds_mysql_prod_tagelement t on
p.fy=t.id
left join profile_27396 q on
p.prj_code=q._id
left join ds_mysql_prod_tagelement t2 on
q.project_manager=t2.id

GROUP  BY 1,2),
tab2 as(select distinct(k.village),q.name as projectcode,t2.name as project_manager
		  from profile_29973 p
		  left join profile_27489 k
          on p.census_code=k._id
		  left join profile_27396 q on
          p.prj_code=q._id
		  left join ds_mysql_prod_tagelement t2 on
          q.project_manager=t2.id
		  group by 1,2,3),
		  
		  
tab3 as(select count(t1.village)as number_of_villages,t.projectcode,t.fy_timerange,t1.project_manager,t.Admin_cost,t.Human_resource,t.NGO_Management_Cost from tab1 t
left join tab2 t1 on
t.projectcode=t1.projectcode
group by 2,3,4,t.Admin_cost,t.Human_resource,t.NGO_Management_Cost),

tab4 as(select t3.village,t2.projectcode,t2.fy_timerange,t2.project_manager,(t2.Admin_cost/t2.number_of_villages) as AC,(t2.Human_resource/t2.number_of_villages) as HRC,(t2.NGO_Management_Cost/t2.number_of_villages) as NMC,t2.Admin_cost,t2.Human_resource,t2.NGO_Management_Cost,t2.number_of_villages from tab3 t2
left join tab2 t3 on
t3.projectcode=t2.projectcode
where t2.number_of_villages!=0)

Select village, fy_timerange, 
case col
		when 'Human Resource Cost' then s.HRC
		when 'Admin Cost' then  s.AC
		when 'NGO Management Cost' then s.NMC
	else 0
	end as values,
	temp.col as contri_types,
projectcode, project_manager
from tab4 s
cross join temp


 ---SELECT countdistinct(t2.village)) as number,t2.project_code,t2.fy,t2.project_manager,t3.number_of_villages,(t2.AC/t3.number_of_villages) as AC1,(t2.HRC/t3.number_of_villages) as HRC1,(t2.NMC/t3.number_of_villages)as NMC1 from tab4 t2
-- where t3.number_of_villages!=0
--- group by 1,2,3,4,5,t2.AC,t2.HRC,t2.NMC


