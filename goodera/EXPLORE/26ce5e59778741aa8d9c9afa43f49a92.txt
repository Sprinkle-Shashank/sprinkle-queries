 with table11 as
( select p.projectid, p._id ,sum(num_females) as num_females, sum(num_females_graduated) as num_females_graduated, type_program, row_number() over 
(partition by projectid
 order by _id desc) as row from profile_4227 p group by p.projectid , p.name , p._id , type_program  ),
 
 table13 as 
 (
    select t11.* from table11 t11 where row=1),

batch_completed as (  select p._id,p.projectid, count(*) as completed , row_number() over 
(partition by projectid
 order by _id desc) as row from profile_4227 p
					 where end_date is not null
					 group by p.projectid, p._id),
					 
table14 as
( select * from batch_completed where row=1),

batch_ongoing as ( select p._id,p.projectid, count(*) as ongoing ,  row_number() over 
(partition by projectid
 order by _id desc) as row from profile_4227 p
					 where end_date is null
					 group by p.projectid, p._id),
					 
table15 as
( select * from batch_ongoing where row=1),
					 
table12 as
( select p.projectid ,  t13.projectid, fac.name , ven.name , cou.name , p._id, p.name , name_factory , name_vendor , t13.num_females_graduated , compl.completed, ongo.ongoing from profile_54646 p
 
 left join table13 t13 on 
 p.projectid = t13.projectid
 
 left join table14 compl on 
 p.projectid = compl.projectid
 
 left join table15 ongo on 
 p.projectid = ongo.projectid
 
 left join ds_mysql_prod_project fac 
on p.projectId = fac.id

 left join ds_mysql_prod_project ven 
on fac.parent = ven.id

 left join ds_mysql_prod_project cou 
on ven.parent = cou.id

 )
 
 select * from table12
 