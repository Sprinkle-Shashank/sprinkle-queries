with sub1 as(
  select p1.timeperiod_timerange as fy_timerange, p1.cdms_id, p1.factory as factory_text, p1.tier, p1.status
from profile_66534 p1
where p1.tier is not null and p1.status = 955996
group by  p1.timeperiod_timerange, p1.cdms_id, p1.factory, p1.tier, p1.status),

sub2 as(
  select s1.fy_timerange, s1.factory_text, s1.cdms_id, p2.source_div, p2.region, 
extract(year from cast(s1.fy_timerange.start as date)) as fy,
case
  	when is_array(p2.brands) = false or get_array_length(p2.brands) = 0 then array(p2.brands)
  	else p2.brands
end as brands_new
from sub1 s1
left join profile_60928 p2 on p2.factory_id = s1.cdms_id),

sub3 as(
  select s2.*, source_division, country, brands
from sub2 s2, s2.source_div source_division, s2.region country, s2.brands_new brands)

selecct * from sub1