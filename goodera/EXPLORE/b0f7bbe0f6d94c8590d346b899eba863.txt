
with table1 as
( select p.projectid , p._id , p.name , p.fy_timerange , num_ben ,  INITCAP(ent.name) as entity , p.location , proj.name as projectname ,  p.name from profile_80981 as p

left join ds_mysql_prod_tagelement ent 
on p.entity = ent.id

left join ds_mysql_prod_tagelement proj 
on p.projectid = proj.id),


table2 as
( select p.projectid , p._id  , p.fy_timerange , num_ben ,  entity , d1 , projectname , name from table1 as p, p.location as d1),


table3 as
(
select p.projectid , p._id  , p.fy_timerange , num_ben , entity , location_unwind.name as location_unwind_update , projectname , name from table2 as p
  
left join ds_mysql_prod_tagelement location_unwind 
on p.d1 = location_unwind.id
 ),
 
 table4 as
 ( select p.projectid , p._id  , p.fy_timerange , num_ben , entity , listagg(distinct location_unwind_update
, ',') as location_unwind_update_new , projectname , name from table3 as p
  
  group by  p.projectid , p._id  , p.fy_timerange , num_ben , entity  , projectname ,name
)
  
select * from table4
