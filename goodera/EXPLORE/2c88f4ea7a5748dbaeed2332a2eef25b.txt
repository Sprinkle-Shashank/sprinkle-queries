
with table1 as(select projectId, select_name, teacher_name, class, exam_type, eh_beginner, engsmall_letter, eng_cap_letter, eh_word, eh_sentence, eh_story, eng_grammar, eng_story_comp, eng_vocab, eng_conversat, mat_3_beginner, mat_3_recognition, mat_3_addition, mat_3_subtraction, mat_3_multiplication, mat_3_division, mat_3_odd_even, mat_4_5_fraction, mat_4_unitary_method, mat_4_profit_loss, 5_hcf, 5_lcm, 5_dec, 5_percentage, fy_timerange from profile_65267 
),

table2 as (select t1.*,clas from table1 t1 , t1.class as clas),

t3 as
(SELECT * 
FROM
(Select   projectId, select_name, teacher_name, clas, exam_type, eh_beginner, engsmall_letter, eng_cap_letter, eh_word, eh_sentence, eh_story, eng_grammar, eng_story_comp, eng_vocab, eng_conversat, mat_3_beginner, mat_3_recognition, mat_3_addition, mat_3_subtraction, mat_3_multiplication, mat_3_division, mat_3_odd_even, mat_4_5_fraction, mat_4_unitary_method, mat_4_profit_loss, 5_hcf, 5_lcm, 5_dec, 5_percentage, fy_timerange from table2 p
)
UNPIVOT (
    val FOR dim IN (eh_beginner, engsmall_letter, eng_cap_letter, eh_word, eh_sentence, eh_story, eng_grammar, eng_story_comp, eng_vocab, eng_conversat, mat_3_beginner, mat_3_recognition, mat_3_addition, mat_3_subtraction, mat_3_multiplication, mat_3_division, mat_3_odd_even, mat_4_5_fraction, mat_4_unitary_method, mat_4_profit_loss, 5_hcf, 5_lcm, 5_dec, 5_percentage))

)

select p.projectId, p4.name as school_name, p3.name as class,  p2.name as exam_type, p.fy_timerange,  sum(val) as val,dim,p1.name as teacher_name from t3 as p

left join profile_65257 p1
on p.teacher_name= p1._id

 left join ds_mysql_prod_tagelement p2
  on p.exam_type = p2.id
  
 left join ds_mysql_prod_tagelement p3
  on p.clas = p3.id
   left join ds_mysql_prod_tagelement p4
  on p.select_name = p4.id
where val is not null

Group By p.projectId,   p.fy_timerange, dim, p1.name  ,p2.name,p3.name,p4.name
  
