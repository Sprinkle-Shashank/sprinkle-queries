with table1 as
(select _id , projectId,country, vendor,unwind_cycle, product_category, consultant_tag from profile_64362 as p ,p.cycle as unwind_cycle),

 table2 as
(select _id, projectId,country, vendor,cycle,product_category,consultant_tag from profile_64362
  where _id not in (select _id from table1))
  ,
  
table3 as
 (
	select * from table1
  Union all
  select * from table2
 )
 ,

  
table4 as  
(
 select _id,  projectId,country,vendor,unwind_cycle, unwind_product_category,consultant_tag from table3 t3, t3.product_category  as unwind_product_category
 ),

table5 as
(select _id, projectId,country,vendor,unwind_cycle,  null as product_category,consultant_tag from table3 
 where _id not in (select _id from table4)),
 
table6 as
(select * from table4
union all
select * from table5),


t1 as (select tag3.name as projectId, p1.notes_2, p1.end_date_2, p1.start_date_2,tag8.name as training, tag6.name as training_type, p1.supervisors, p1.employed, p1.saturation, p1.master_trainers, p1.year, p3.factory, p5.vendor, tag7.name as consultant, p5.product_category,tag1.name as country, tag2.name as product_category2, tag9.name as unwind_product_category,
cast('Cycle 1' as VARCHAR) as Cycle1,
cast('Cycle 2' as VARCHAR) as Cycle2
from profile_64817 p1

left join table6 as p2
on p1.projectId = p2.projectId	   
left join profile_64362 p5
on p1.projectId = p5.projectId
left join profile_64170 as p3
on p5.factory = p3._id
left join profile_61602 as p4
on p1.training = p4._id
 left join ds_mysql_prod_tagelement tag7
on p5.consultant_tag = tag7.id
left join ds_mysql_prod_tagelement tag8
on p4.training_type = tag8.id
left join ds_mysql_prod_tagelement tag1
on p5.country = tag1.id
left join ds_mysql_prod_tagelement tag2
on p5.product_category = tag1.id 
left join ds_mysql_prod_tagelement tag3
on p1.projectId = tag3.id
left join ds_mysql_prod_project tag4
on p1.training = tag4.id
left join ds_mysql_prod_tagelement tag5
on p5.consultant = tag5.id
left join ds_mysql_prod_tagelement tag6
on p1.training_type = tag6.id
left join ds_mysql_prod_tagelement tag9
on p2.unwind_product_category = tag9.id),

t6 as(select projectId,notes_2,end_date_2,start_date_2,training,training_type, supervisors, employed,saturation,master_trainers, year,country,factory,vendor,consultant, unwind_product_category as product_category,
cast('50' as VARCHAR) as Target,
case 
when year = 1433762 then Cycle1
when year = 1433763 then Cycle1
when year = 1433764 then Cycle1
else Cycle2
end as cycle
from t1
Group by projectId, notes_2, end_date_2, start_date_2,training,  training_type, year, supervisors, employed, saturation, master_trainers, factory, vendor, consultant, country, product_category, Target, cycle, unwind_product_category
)

select * from table6





