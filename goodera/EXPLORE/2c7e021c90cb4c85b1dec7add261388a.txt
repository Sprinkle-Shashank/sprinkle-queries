with PROJECT_ID as (select distinct projectid from profile_54267,
table3 as ( select _id,projectid,fy,month,row_number() over 
(partition by projectid
 order by p._id desc) as row from profile_54267 p where projectid in array(PROJECT_ID.projectid)),
 
  table2 as(select projectid,fy,month, row from table3	
where  row = 1),

table1 as(Select p.projectid,f_y.name as fy,mth.name as month,p._id,p.pace_status_2,p.sourcing_yn,profile_54646.name_vendor_filter as partner_consolidated,profile_54646.name_vendor as vendor,profile_54646.name_country as country,fac.name as Factory,  row_number() over 
(partition by factory
 order by p._id desc) as row

from profile_52713 p 



left join table2 t2 on
p.projectId = t2.projectId
left join ds_mysql_prod_project fac
on p.projectId = fac.id
left join ds_mysql_prod_tagelement f_y
on t2.fy = f_y.id
left join ds_mysql_prod_tagelement mth
on t2.month = mth.id

left join profile_54646 on
p.projectId = profile_54646.projectId

where pace_status_2 = 845114 and sourcing_yn = 57473
 )


select Distinct Factory,row,sourcing_yn,pace_status_2,country,vendor from table1
where row = 1 and vendor is not null
