with sub1 as(
  select p1._id as id, p1.project_name, p1.program_type, p1.fy_timerange, cast(p1.start_date as date) as start_date, cast(p2.offset_date as date) as offset_date, p3.region, p4.projcode_factory, p1.end_date_2 as end_date, p3.source_div, p2.pvh_id, p1.num_females,

case
  when extract(month from cast(p1.fy_timerange.start as date)) = 1
  		then extract(year from cast(p1.fy_timerange.start as date)) - 1
  else extract(year from cast(p1.fy_timerange.start as date))
end as year,
  
case
	when p4.projcode_factory like 'C%' or p4.projcode_factory like '%PVH' then 1 
	else 0
end as filter,
  
case
  	when is_array(p3.brands) = false or get_array_length(p3.brands) = 0 then array(p3.brands)
  	else p3.brands
end as brands_new

from profile_62491 p1
left join profile_62948 p2 on p2.project_id = p1.project_id
left join profile_60928 p3 on p2.pvh_id = p3.factory_id
left join profile_62482 p4 on p4.project_id = p1.project_id

where year >= 2020 and start_date >= nvl(offset_date,'2020-01-01') and filter = 1
and nvl(p1.lg_status,0) != 1105812 and p2.pvh_id is not NULL

group by p1._id, p1.project_name, p1.program_type, p1.fy_timerange, p1.fy_timerange.start, p1.start_date, p2.offset_date, p3.region, p4.projcode_factory, p1.end_date_2, filter, p3.source_div, p3.brands, p2.pvh_id, p1.num_females),

sub2 as(
  select s1.*, country, source_division, brand
  from sub1 s1, s1.region country, s1.source_div source_division, s1.brands_new brand),
  
sub3 as(
  select id,pvh_id, country, source_division, brand, num_females, fy_timerange from sub2
  group by id, pvh_id, country, source_division, brand, num_females, fy_timerange)
  
select s3.id, s3.pvh_id, 'P.A.C.E.' as program, t1.name as biz_div, t2.name as brand, t3.name as region,
('FY' || extract(year from cast(s3.fy_timerange.start as date))) as fy, s3.num_females total_females
 from sub3 s3
 left join ds_mysql_prod_tagelement t1 on t1.id = s3.source_division
 left join ds_mysql_prod_tagelement t2 on t2.id = s3.brand
 left join ds_mysql_prod_tagelement t3 on t3.id = s3.country
