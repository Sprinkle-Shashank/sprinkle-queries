WITH table1 as (
 
  Select * from profile_16862 ),
  table2 as (
	Select * from profile_16619),
	table3 as  (
	
	Select *,t1.sub_unit as sub_unit , t1.projectid as porj from table2
	  LEFT JOIN table1 t1 on
	  t1.projectid = table2.projectid
	  
	  WHERE table2.sub_unit = 57472
  )
  Select *, fac.name as factory , case when nvl2(SUBSTRING(ven.name, 1, POSITION(' (' in ven.name)), SUBSTRING(ven.name, 1, POSITION(' (' in ven.name)), ven.name)='' then ven.name else nvl2(SUBSTRING(ven.name, 1, POSITION(' (' in ven.name)), SUBSTRING(ven.name, 1, POSITION(' (' in ven.name)), ven.name) end as vendor , cou.name as country , p1.factory_id
 , p2.vpid as vendor_id  from table3 t3
  
  left join ds_mysql_prod_project fac
on  t3.porj = fac.id

left join ds_mysql_prod_project ven
on fac.parent = ven.id

left join ds_mysql_prod_project cou
on ven.parent = cou.id

 