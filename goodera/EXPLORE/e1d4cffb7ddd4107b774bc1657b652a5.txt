with temp1 AS 
(select m.projectId, m.completed, m.project_code, m.fy_timerange, r.vertical, r.focus, r.entity/*, vert.name AS vertical2, vert_1.name AS vertical1,

case when vert.name IS NULL AND vert_1.name IS NOT NULL THEN vert.name 
when vert_1.name IS NULL AND vert.name IS NOT NULL THEN vert_1.name
else 'Admin'
END AS verticals*/

 from profile_55471 AS m

left join profile_62881 AS r
 on m.project_code = r.project_code
 
/*left join ds_mysql_prod_tagelement as vert
  on r.vertical = vert.id

left join ds_mysql_prod_tagelement as vert_1
  on vert.parent = vert_1.id*/
 
where m.completed = 939857),

temp2 as
(select p.*, q1 from temp1 as p, p.vertical as q1)

select p.project_code, p.focus, p.fy_timerange, p.entity, 
case when new_2.name is null then new_1.name
else new_2.name 
end AS vertical, count(*) from temp2 AS p

left join ds_mysql_prod_tagelement as new_1
  on p.q1 = new_1.id
  
left join ds_mysql_prod_tagelement as new_2
  on new_1.parent = new_2.id
  
group by p.project_code, p.focus, p.fy_timerange, p.entity,  new_2.name
  
order by p.fy_timerange asc, p.project_code asc