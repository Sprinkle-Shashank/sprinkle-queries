with temp1 AS
(select m._id, m.indicator AS indicator_ref, m.project_code, m.fy_timerange, m.progress, r.description, r.indicator, r.target, q.name AS project_code_new, q.project_name, q.vertical, q.focus, q.state, q.direct_or_partner, q.district, q.entity, vert.name AS vertical2, vert_1.name AS vertical1,

case when vert.name IS NULL AND vert_1.name IS NOT NULL THEN vert.name 
when vert_1.name IS NULL AND vert.name IS NOT NULL THEN vert_1.name
else 'Admin'
END AS verticals

from profile_61046 AS m

left join profile_61044 AS r 
 on m.indicator = r._id

left join profile_62881 AS q
 on m.project_code = q.project_code

left join ds_mysql_prod_tagelement as vert
  on q.vertical = vert.id

left join ds_mysql_prod_tagelement as vert_1
  on vert.parent = vert_1.id),
 
temp2 as
(select p.*, q1, q2, q3 from temp1 as p, p.vertical as q1, p.vertical1 as q2, p.vertical2 as q3)
 
select p.indicator_ref, p.project_code, p.fy_timerange, SUM(p.progress), p.description, p.indicator, AVG(p.target), p.project_code_new, p.project_name, p.focus, p.state, p.direct_or_partner, p.district, p.entity, new_4.name AS vertical_1, new_6.name AS vertical_2, new_2.name AS verticals from temp2 AS p

left join ds_mysql_prod_tagelement as new_1
  on p.q1 = new_1.id
  
left join ds_mysql_prod_tagelement as new_2
  on new_1.parent = new_2.id

left join ds_mysql_prod_tagelement as new_3
  on p.q2 = new_3.id
  
left join ds_mysql_prod_tagelement as new_4
  on new_3.parent = new_4.id

left join ds_mysql_prod_tagelement as new_5
  on p.q3 = new_5.id
  
left join ds_mysql_prod_tagelement as new_6
  on new_5.parent = new_6.id
  
group by p.indicator_ref, p.project_code, p.fy_timerange, p.description, p.indicator, p.project_code_new, p.project_name, p.focus, p.state, p.direct_or_partner, p.district, p.entity, new_4.name, new_6.name, new_2.name