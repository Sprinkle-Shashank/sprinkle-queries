with sub1 as(
  select r1.*, len(cast(r1.start_date as varchar)) as start_date_len,
len(cast(r1.end_date as varchar)) as end_date_len,

case
	when (start_date_len = 13) then 
		cast(timestamp 'epoch' + CAST(r1.start_date AS BIGINT)/1000 * interval '1 second' as varchar)
	else r1.start_date
end as start_date_new,

case
	when (end_date_len = 13) then 
		cast(timestamp 'epoch' + CAST(r1.end_date AS BIGINT)/1000 * interval '1 second' as varchar)
	else r1.end_date
end as end_date_new,

case
	when r1.unwind_focus_area is not null 
	then r1.focus_area_name
	when r1.unwind_focus_area is null and r1.focus_area_array is not null and r1.focus_area_2_name is not null
	then r1.focus_area_2_name
  	when r1.unwind_focus_area is null and r1.focus_area_array is not null and r1.focus_area_2_name is null
	then 'Others'
	when r1.unwind_focus_area is null and r1.focus_area_array is null
	then r1.focus_area_2_name
	else null
end as focus_area

from rb_loghours r1),

sub2 as(
  select s1._id as id, (cast(s1.start_date_new as date)||'|'||cast(s1.end_date_new as date)) as fy_timerange, s1.vol_hours, (s1.vol_hours*p2.vol_conversion_factor) as volunteering_cost, extract(year from cast(s1.start_date_new as date)) as year_check, extract(year from cast(s1.end_date_new as date)) as end_year, ('FY'||' '||extract(year from cast(s1.start_date_new as date))) as x_axis2, cast('Volunteering' as varchar) as x_axis,
	case
  		when (year_check = extract(year from current_date) or end_year = extract(year from current_date))
  		then 'Current year'
  		when (year_check = extract(year from current_date)-1 or end_year = extract(year from current_date)-1)		 then 'Previous year'
  	else 'Not Applicable'
  	end as year_status,
  
  	case
  		when p4.name is null then 'Global'
  		else p4.name
  	end as country,
  
  	case 
  		when p4.map_code is null then 'UK'
  		else p4.map_code
  	end as map_code,
  
   	case
  		when t1.name is null then 'Other'
  		else t1.name
  	end as focus_area
  
from sub1 s1
left join profile_78933 p2 on p2.name = extract(year from cast(s1.start_date_new as date))
left join profile_78929 p3 on p3.vol_focus_area_full = s1.focus_area
left join ds_mysql_prod_tagelement t1 on t1.id = p3.focus_area
left join profile_78788 p4 on p4.vol_country = s1.country
where s1.vol_hours is not null and s1.vol_hours != 0 and year_check > 2017 and year_check < 2026
group by s1._id, s1.start_date_new, s1.end_date_new, t1.name, p4.name, p4.map_code, x_axis, x_axis2, year_check, end_year, year_status, s1.vol_hours,p2.vol_conversion_factor),

----- Log Hours xxx-------

sub3 as(
  select cast(r2.eoid as varchar) as id, (cast(r2.start_date as date)||'|'||cast(r2.end_date as date)) as fy_timerange, r2.vol_hours, (r2.vol_hours*p7.vol_conversion_factor) as volunteering_cost, extract(year from cast(r2.start_date as date)) as year_check, extract(year from cast(r2.end_date as date)) as end_year, 
('FY'||' '||extract(year from cast(r2.start_date as date))) as x_axis2, cast('Volunteering' as varchar) as x_axis,
	case
  		when (year_check = extract(year from current_date) or end_year = extract(year from current_date)) 
  		then 'Current year'
  		when (year_check = extract(year from current_date)-1 or end_year = extract(year from current_date)-1) 		  then 'Previous year'
  	else 'Not Applicable'
  	end as year_status,
  
  	case
  		when p6.name is null then 'Global'
  		else p6.name
  	end as country,
  
  	case 
  		when p6.map_code is null then 'UK'
  		else p6.map_code
  	end as map_code,
  
  	case
  		when t2.name is null then 'Other'
  		else t2.name
  	end as focus_area
  
from rb_volhours r2
left join profile_78929 p5 on p5.vol_focus_area_full = r2.focus_area
left join ds_mysql_prod_tagelement t2 on t2.id = p5.focus_area
left join profile_78788 p6 on p6.vol_country = r2.country
left join profile_78933 p7 on p7.name = extract(year from cast(r2.start_date as date))
where r2.vol_hours is not null and r2.vol_hours != 0 and year_check > 2017 and year_check < 2026
group by r2.eoid, r2.start_date, r2.end_date, t2.name, p6.name, p6.map_code, year_check, end_year year_status, x_axis, x_axis2, r2.vol_hours, p7.vol_conversion_factor)

------ Volunteering Hours xxx ----

select id, fy_timerange, focus_area, country, map_code, year_check, year_status, x_axis, x_axis2, vol_hours, volunteering_cost from sub2
where fy_timerange is not null
union all
select id, fy_timerange, focus_area, country, map_code, year_check, year_status, x_axis, x_axis2, vol_hours, volunteering_cost from sub3
where fy_timerange is not null