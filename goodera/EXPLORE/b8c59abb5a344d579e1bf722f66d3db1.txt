 Select prod.name,cast((split_part(split_part(prod.name,'|',1),'.',1)) as varchar) as prj_code,split_to_array(listagg(distinct split_part(prod.name,'|',2),','),',') as c,get_array_length(c) as village_count
from profile_54963 r
left join project_4188 prod
on r.projectid=prod.id
group by 1,2