with s as (Select prod.name,cast((split_part(split_part(prod.name,'|',1),'.',1)) as varchar) as prj_code,cast((split_part(split_part(prod.name,'|',1),'.',2)) as varchar) as prj_village,split_part(prod.name,'|',4)
from profile_54963 r
left join project_4188 prod
on r.projectid=prod.id
),
s2 as (
Select s.name as proj_code,t.name as fy,ngo_ref as ia,t1.name as project_manager,state
from profile_27396 s
left join tagElement_4188 t
on t.id=s.fy
left join tagElement_4188 t1
on t1.id=s.project_manager

),
s3 as (
Select proj_code,fy,ia,project_manager,st
from s2 as sq,sq.state as st
),
s4 as (
Select proj_code,fy,ia,project_manager,listagg(t.name) as state
from s3
left join tagElement_4188 t
on t.id=s3.st
group by proj_code,fy,ia,project_manager
),

s5 as(
Select sp.name as proj_code,t.name as fy,ngo_ref as ia,t1.name as project_manager,sp.state
from profile_27420 sp
left join tagElement_4188 t
on t.id=sp.fy
left join tagElement_4188 t1
on t1.id=sp.project_manager
)

Select * from s5


/*with s as(
Select prod.name,cast((split_part(split_part(prod.name,'|',1),'.',1)) as varchar) as prj_code,cast((split_part(split_part(prod.name,'|',1),'.',2)) as varchar) as prj_village,
case
	when prj_village is not null then 1
	else 0
end as vill_count,
t.name as fy,ss.ngo_ref as Imp_agency,ss.project_manager ,ss.curr_yr_budget,ss.state

from profile_54963 r
left join project_4188 prod
on r.projectid=prod.id
left join profile_27396 ss
on prj_code=ss.name
left join tagElement_4188 t
on t.id=r.fy
group by 1,2,3,4,5,6,7,8,9

),
s2 as (
Select prj_code, vill_count, fy, imp_agency, project_manager, curr_yr_budget, st from s as uw,uw.state st
)
, 
s3 as(
Select prj_code, vill_count, fy, imp_agency, project_manager, curr_yr_budget, t.name as state,sum(vill_count) as count from s2
left join tagElement_4188 t
on t.id=st
GROUP BY prj_code, vill_count, fy, imp_agency, project_manager, curr_yr_budget, t.name

)
Select * from s */