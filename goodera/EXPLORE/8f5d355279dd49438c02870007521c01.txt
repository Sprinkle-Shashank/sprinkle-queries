with table1 as
( select p.projectid , fac.name as factory , ven.name as vendor1,nvl2(SUBSTRING(vendor1, 1, POSITION(' (' in vendor1)), SUBSTRING(vendor1, 1, POSITION(' (' in vendor1)), vendor1) as vendor_name, case when vendor_name='' then vendor1 else vendor_name end as vendor, cou.name as country,case when cou.name in ('India', 'Bangladesh', 'Sri Lanka')
then 'South Asia'
when cou.name in ('China')
then 'North Asia'
when cou.name in ('Guatemala', 'El Salvador', 'Dominican Republic')
then 'Americas'
when cou.name in ('Philippines', 'Cambodia',  'Vietnam',  'Indonesia', 'Myanmar')
then 'South East Asia'
end as region , p.name as Submission , p2.factory_id as Facility_id , aaditional_comments as add_comment , job.name as job_p , op.name as opport , know.name as knowled , rate.name as rating_update , sta.name as status_update ,
 
 case when status_update is null and p3.date_enrollment is not null and p3.date_completion is null then 'ongoing' when status_update is null and p3.date_enrollment is not null and p3.date_completion is not null then 'completed' else  status_update end as wcp_status
 
 , p4.vpid as vendor_id , sub.name as sub_unit_update , case when sub_unit_update is not null then sub_unit_update else 'No' end as multiple_BCs , p3.date_enrollment , extract(year from p3.date_enrollment) as wcp_start_year , module , wcp_start_year as year_new
 
 from profile_16864 as p
 
   
left join ds_mysql_prod_project fac
on p.projectid = fac.id
 
left join ds_mysql_prod_project ven
on fac.parent = ven.id
 
left join ds_mysql_prod_project cou
on ven.parent = cou.id
 
left join ds_mysql_prod_tagelement job
on p.job_part = job.id
 
left join ds_mysql_prod_tagelement op
on p.opportunities = op.id
 
left join ds_mysql_prod_tagelement know
on p.knowledge = know.id
 
left join ds_mysql_prod_tagelement rate
on p.rating = rate.id
 
left join profile_4722 p2 
on p.projectid = p2.projectid 
 
left join profile_16619 p3 
on p.projectid = p3.projectid 
 
left join ds_mysql_prod_tagelement sta
on p3.status = sta.id
 
 left join ds_mysql_prod_tagelement sub
on p3.sub_unit = sub.id

left join profile_4718 p4
on p.projectid = p4.projectid 
 
 where cou.id != 13761 
),


table2 as
(
select p.* , d1 from table1 as p,p.module as d1 
 ),
 
 
 table3 as
 ( 
   select p.*, mod.name as module_name , case when d1=331422  from table2 as p
   
   left join ds_mysql_prod_tagelement mod
   on p.d1 = mod.id
  ),
  
  table5 as
  ( select p.projectid , p._id , trainer , p1._id from profile_16619 as p
   
   left join profile_17028 p1
   on p.trainer = p1._id
   ),
  
  
  table4 as
  ( 
	select p.projectid ,  factory , vendor, country, region , Submission ,  Facility_id , add_comment ,  job_p , opport , knowled ,  rating_update , status_update , wcp_status
 
 , vendor_id , sub_unit_update , multiple_BCs , wcp_start_year , module ,  year_new , listagg(module_name , ',') as module_name_update
	
	from table3 as p
	
	group by  p.projectid ,  factory , vendor, country, region , Submission ,  Facility_id , add_comment ,  job_p , opport , knowled ,  rating_update , status_update , wcp_status , vendor_id , sub_unit_update , multiple_BCs , wcp_start_year , module , year_new 
   )
  
  
  select * from table5