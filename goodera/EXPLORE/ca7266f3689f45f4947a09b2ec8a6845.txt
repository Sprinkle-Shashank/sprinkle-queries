with temp1 as
(select m._id, projectId.name as projectId, m.name as activity, m.description, m.start, m.end, m.astart, m.aend,
from profile_61043 as m
left join profile_62881 AS r
on m.projectId = projectId.id 
where m.astart IS NOT NULL and m.aend IS NOT NULL )
temp2 as
(select m._id, m.projectId, m.activity, m.description, cast(m.start as date) as start_1, m.end, m.astart, 
cast(m.aend as date) as aend_1, m.vertical
concat(start_1,'T00:00:00.000Z') as start_2,
concat(aend_1,'T00:00:00.000Z') as aend_2,
concat(concat(concat(concat('{"start":"',start_2),'","end":"'),aend_2),'"}') as fy_timerange
from temp1 as m) 
temp3 as
 (select m._id, m.projectId, m.activity, m.description, m.start_1 as start, m.end, m.astart, m.aend_1 as aend, 
 m.vertical,, m.fy_timerange, vertical1 from temp2 as m)
temp4 as
 (select m._id, m.projectId, m.activity, m.description, m.start, m.end, m.astart, m.aend, m.fy_timerange, 
vertical2 as m from temp 3
  
  case 
when vertical1.name IS NULL AND vertical.name IS NOT NULL THEN vertical.name
else vertical1.name 
END AS vertical
from temp3 AS m

left join ds_mysql_prod_tagelement as vert
on m.vertical1 = vertical.id
left join ds_mysql_prod_tagelement as vert1
on vertical.parent = vertical1.id),

temp4 as
(select m._id, m.projectId, m.activity, m.description, m.start, m.end, m.astart, m.aend, m.fy_timerange, m.vertical2
 case 
when vertical1.name IS NULL AND vert.name IS NOT NULL THEN vert.name
else vert1.name 
END AS vertical
from temp4 as m
left join ds_mysql_prod_tagelement as vert
on m.vertical2 = vertica1.id)
case 
when vert1.name IS NULL AND vert.name IS NOT NULL THEN vert.name
else vert1.name 
END AS "ADMIN"
DELETE m.vertical2,m.vertical1

)
