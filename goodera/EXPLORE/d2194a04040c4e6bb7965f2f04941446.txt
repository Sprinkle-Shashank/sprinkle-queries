
with t1 as 
(select _id, projectId, fy_timerange, netprofit, prescribed_csr, setoff_amount, setoff_amount_preceding, surplus_previously, actual_csr, overhead_expenses, impact_assesment, unspent_account, (prescribed_csr + surplus_previously + setoff_amount) as total_csr_obligation, sum(actual_csr + overhead_expenses + impact_assesment) as total_amount_current
from profile_82837
group by 
_id, projectId, fy_timerange, netprofit, prescribed_csr, setoff_amount, setoff_amount_preceding, surplus_previously, actual_csr, overhead_expenses, impact_assesment, unspent_account),

t2 as 
(select 
_id, projectId, fy_timerange, netprofit, prescribed_csr, setoff_amount, setoff_amount_preceding, surplus_previously, actual_csr, overhead_expenses, impact_assesment, unspent_account, total_csr_obligation, total_amount_current, (total_amount_current - prescribed_csr) as excess_current
from t1
group by
_id, projectId, fy_timerange, netprofit, prescribed_csr, setoff_amount, setoff_amount_preceding, surplus_previously, actual_csr, overhead_expenses, impact_assesment, unspent_account, total_csr_obligation, total_amount_current)

select 
_id, projectId, fy_timerange, netprofit, prescribed_csr, setoff_amount, setoff_amount_preceding, surplus_previously, actual_csr, overhead_expenses, impact_assesment, unspent_account, total_csr_obligation, total_amount_current, excess_current, (excess_current - surplus_previously) as setoff_succeed
from t2
group by 
_id, projectId, fy_timerange, netprofit, prescribed_csr, setoff_amount, setoff_amount_preceding, surplus_previously, actual_csr, overhead_expenses, impact_assesment, unspent_account, total_csr_obligation, total_amount_current, excess_current



