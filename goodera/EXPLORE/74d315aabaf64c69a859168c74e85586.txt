with s as 
(Select t.name as projectid,('FY'||substring(EXTRACT(YEAR FROM(CAST(startdate AS datetime))),3,2)||'-'||substring(EXTRACT(YEAR FROM(CAST(startdate AS datetime)))+1,3,2) ) as year, datatable, questiontext,
 extract(Month from cast(startdate as datetime) )as Monthh,
case 
  when monthh=01 then 'January'
  when monthh=02 then 'February'
  when monthh=03 then 'March'
  when monthh=04 then 'April'
  when monthh=05 then 'May'
  when monthh=06 then 'June'
  when monthh=07 then 'July'
  when monthh=08 then 'August'
  when monthh=09 then 'September'
  when monthh=10 then 'October'
  when monthh=11 then 'November'
  when monthh=12 then 'December'
  end as month,
  case 
	when month='January' then 'Q4'
	when month='February' then 'Q4'
	when month='March' then 'Q4'
	when month='April' then 'Q1'
	when month='May' then 'Q1'
	when month='June' then 'Q1'
	when month='July' then 'Q2'
	when month='August' then 'Q2'
	when month='September' then 'Q2'
	when month='October' then 'Q3'
	when month='November' then 'Q3'
	when month='December' then 'Q3'
	else null
	end as Quarter
from sus_79365
left join ds_mysql_prod_project t
on xprojectid=t.id
where keyword='materials'
),
s2 as (
Select projectid , year ,Quarter,
  case 
  when is_Array(coun.material_type)=False or get_Array_length(coun.material_type)=0 then Array(coun.material_type)
  else coun.material_type
  end as material_type_new
  ,coun.material_weight
from s as p, unpivot p.datatable as coun at xyz
)
,
s3 as (
Select projectid , year,Quarter,material_type, material_weight
  from s2 as k,k.material_type_new  material_type
  )
  
Select projectid , year,Quarter,t.name as material_type,sum(material_weight) material_weight
from s3
left join ds_mysql_prod_tagelement t
on t.id=s3.material_type
group by projectid,year, quarter,t.name

