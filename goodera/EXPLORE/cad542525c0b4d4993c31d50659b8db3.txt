
with
table2 as 
(
  select p1.*, cast(survey_questions as varchar) from profile_67390 as p1, p1.survey_questions_arr survey_questions
),
table3 as( select p._id,work.name as working, gen.name as gender, ag.name as age, mart_stat.name as marital_status from profile_65902 p
		  
		  left join ds_mysql_prod_tagelement gen 
on p.gender = gen.id
  
 left join ds_mysql_prod_tagelement work 
on p.working = work.id
  
 left join ds_mysql_prod_tagelement ag 
on p.age = ag.id
  
 left join ds_mysql_prod_tagelement mart_stat 
on p.marital_status = mart_stat.id
  
  
   ),
 table4 as(
 select p1.*, cast(survey_questions as varchar) from profile_67391 as p1, p1.survey_questions_arr survey_questions     
 
 
          ) , 
   
table1 as 
(
  
select p._id, cou.name as country, ven.name as vendor, nvl2(SUBSTRING(vendor, 1, POSITION(' (' in vendor)), SUBSTRING(vendor, 1, POSITION(' (' in vendor)), vendor) as vendor_name, case when vendor_name='' then vendor else vendor_name end as vendor_first_update, gen.name as gender_base, work.name as working_base, ag.name as age_base , mart_stat.name as marital_status_base , 'Baseline' as survey ,t2.date as date_base,t2.training ,
 case when extract(month from date_base)=1 then extract(year from date_base)-1
      else extract(year from date_base)
      end as year_base, t3.working, t3.gender, t3.age, t3.marital_status,
 case when t3.working is null then working_base
      else t3.working
      end as working_new,
 case when t3.gender is null then gender_base
      else t3.gender
      end as gender_new,
 case when t3.age is null then age_base
      else t3.age
      end as age_new,
  case when t3.marital_status is null then marital_status_base
       else t3.marital_status
       end as marital_status_new,
  t4.date as date_mid,
 case when extract(month from date_mid)=1 then extract(year from date_mid)-1
      else extract(year from date_mid)
      end as year_mid 
  
  
  
  from profile_65617 as p

left join ds_mysql_prod_project fac 
on p.projectId = fac.id

left join ds_mysql_prod_project ven 
on fac.parent = ven.id

left join ds_mysql_prod_project cou 
on ven.parent = cou.id
  
left join ds_mysql_prod_tagelement gen 
on p.gender = gen.id
  
 left join ds_mysql_prod_tagelement work 
on p.working = work.id
  
 left join ds_mysql_prod_tagelement ag 
on p.age = ag.id
  
 left join ds_mysql_prod_tagelement mart_stat 
on p.marital_status = mart_stat.id
  
 left join table2 t2 
  on p._id = t2.survey_questions 
 
 full join table3 t3 
  on p._id=t3._id
 
 left join table4 t4
  on p._id= t4.survey_questions
  
  
)

/*, table3 as 
(
select country, vendor_first_update as vendor, table2.date as new_date_390, case when extract(month from new_date_390)=1 then (extract(year from new_date_390)-1)
else extract(year from new_date_390) end as year_base, gender as gender_base, working_base , age_base , marital_status_base, baseline as survey from table1 as tab1

left join table2 on 
tab1._id = table2.survey_questions
  
)
, table4 as
(
  select work.name as working, gen.name as gender, ag.name as age, mart_stat.name as marital_status from profile_65617 as p 
  
left join ds_mysql_prod_tagelement gen 
on p.gender = gen.id
  
 left join ds_mysql_prod_tagelement work 
on p.working = work.id
  
 left join ds_mysql_prod_tagelement ag 
on p.age = ag.id
  
 left join ds_mysql_prod_tagelement mart_stat 
on p.marital_status = mart_stat.id
 )
 , table5 as
 (
   select  work.name as working, gen.name as gender, ag.name as age, mart_stat.name as marital_status from profile_65902 as p1
 
left join ds_mysql_prod_tagelement gen 
on p1.gender = gen.id
  
 left join ds_mysql_prod_tagelement work 
on p1.working = work.id
  
 left join ds_mysql_prod_tagelement ag 
on p1.age = ag.id
  
 left join ds_mysql_prod_tagelement mart_stat 
on p1.marital_status = mart_stat.id
 )
 , table6 as 
(
 select * from table4 union all select * from table5 
)
*/
  select * from table1

 /*
select  gender_base , table7.gender  as gender, table7.working as working  , working_base, table7.age as age, age_base, table7.marital_status as marital_status, marital_status_base, case when gender is null then gender_base else gender end as gender_new , case when working is null then working_base else working end as working_new , case when age is null then age_base else age end as age_new , case when marital_status is null then marital_status_base else marital_status end as marital_status_new  from table3 
 
left join table7 on 
table3.working_base =  table7.working 
 
 group by gender_base , table7.gender , table7.working , working_base, table7.age , age_base,                     table7.marital_status , marital_status_base 




 
, table9 as 
(
  select p1.*, cast(survey_questions as varchar) from profile_67391 as p1, p1.survey_questions_arr survey_questions
)

select _id, country, table9.date as new_date_391  from table8 as tab8

left join table9 on 
table8._id = table9.survey_questions

*/
  
