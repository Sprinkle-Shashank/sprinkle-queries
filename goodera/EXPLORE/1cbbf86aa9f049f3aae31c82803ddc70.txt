with table2 as 
(
   select p.projectid , fac.name as factory , ven.name as vendor , cou.name as country , case when extract(month from date)=1 then extract(year from date)-1 
else extract(year from date) end as year from profile_61572 as p
  
left join ds_mysql_prod_project fac 
on p.projectId = fac.id

 left join ds_mysql_prod_project ven 
on fac.parent = ven.id

 left join ds_mysql_prod_project cou 
on ven.parent = cou.id 
 ),
  
 table1 as 
( select p.projectid , p._id , indepth_workers, indepth_managers , t2.factory , t2.vendor , t2.country , t2.year from profile_76894 as p 
 
 left join table2 t2 on 
 p.projectid = t2.projectid 
 
 where year != 2021 and country <> 'Test Country' and p.projectid ilike '%%'
 )
 
 select * from table1