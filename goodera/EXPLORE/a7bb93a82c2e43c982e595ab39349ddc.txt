with t1 as 
(Select fy_timerange, tag1.name as projectid, tag2.name as donor, school_location, tag3.name as city, tag4.name as state, 
case when state is null then city else state end as state_new
from profile_80587 p1
left join ds_mysql_prod_project tag1
on tag1.id = p1.projectid
left join ds_mysql_prod_project tag2
on tag2.id = tag1.parent
left join ds_mysql_prod_tagelement tag3
on tag3.id = p1.school_location
left join ds_mysql_prod_tagelement tag4
on tag4.id = tag3.parent
where state_new is null or state is null)

select fy_timerange, projectid, donor, city, state_new, tag5.code as map_code
from t1
left join ds_mongo_reftagelementmetadata tag5
on tag5._id = t1.state_new





