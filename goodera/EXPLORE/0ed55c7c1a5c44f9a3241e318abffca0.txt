with table1 as  
( select _id,  projectId,country,factory,vendor, unwind_product_category,consultant_tag from profile_64362 as t3, t3.product_category  as unwind_product_category
 ),

 table2 as
(select _id, projectId,country,factory,vendor, null as product_category,consultant_tag from profile_64362 
 where _id not in (select _id from table1)),
 
table3 as
(select * from table1
union all
select * from table2)

,
t1 as 
(select p1._id,p1.year, p3.name as projectId,p1.name,p1.timerange_timerange,p1.workers,p1.filter_key, tag7.name as training_type, p1.num_female, p1.num_male, p1.num_18, p1.num_29, p1.num_39, p1.num_49, p1.num_50, p1.num_permanent, p1.num_contract, p1.num_temporary, p1.num_home, p1.num_other_contract, p1.num_migrant, p1.num_foreign, p1.num_local, p1.num_age, p1.num_begin, p1.num_end, p1.num_voluntarily, p1.turnover, p1.num_new, p1.num_social, p1.num_less_3, p1.num_3_6, p1.num_6_12, p1.num_1_3, p1.num_3_5, p1.num_more_5, p1.num_less_2, p1.num_less_1, p1.num_available, p1.num_absenteeism, p1.absenteeism_rate,
 tag3.name as country, p2.vendor,p4.factory, tag4.name as consultant, tag6.name as product_category ,
 case
 when year=1433762 then 'Cycle 1'
 when year=1433763 then 'Cycle 1'
  when year=1433764 then 'Cycle 1'
 else 'Cycle 2'
 end as cycle
 from profile_61528 as p1
 left join table3 as p2
on p1.projectId = p2.projectId
left join ds_mysql_prod_project p3
on p1.projectId= p3.id
left join ds_mysql_prod_tagelement tag3
on p2.country = tag3.id
left join ds_mysql_prod_tagelement tag4
on p2.consultant_tag = tag4.id

left join ds_mysql_prod_tagelement tag6 
 on tag6.id = p2.unwind_product_category
 -- left join ds_mysql_prod_tagelement tag8
--on year = tag8.id
left join profile_64170 as p4
on p2.factory = p4._id
left join ds_mysql_prod_tagelement tag7
on p1.training_type = tag7.id
 
),t2 as(
select projectId, name,timerange_timerange, workers, filter_key, training_type, num_female, num_male, num_18, num_29, num_39, num_49, num_50, num_permanent, num_contract, num_temporary, num_home, num_other_contract, num_migrant, num_foreign, num_local, num_age, num_begin, num_end, num_voluntarily, turnover, num_new, num_social, num_less_3, num_3_6, num_6_12, num_1_3, num_3_5, num_more_5, num_less_2, num_less_1, num_available, num_absenteeism, absenteeism_rate, factory,year, vendor, consultant, country, product_category, cycle, timerange_timerange.start as monthnum_start,timerange_timerange.end as monthnum_end,Cast(monthnum_start as varchar) as Time_Start,Cast(monthnum_end  as varchar) as time_end,substring(Time_Start, 6,2) as month , substring(Time_Start, 1,4) as  new_year ,
case when  month='01' then  'Jan'
when  month='02' then 'Feb '
when   month='03' then 'Mar'
when month='04' then 'Apr'
when  month='05' then 'May'
when  month='06' then 'Jun'
when  month='07' then 'Jul'
when  month='08' then 'Aug'
when  month='09' then 'Sep'
when  month='10' then 'Oct'
when  month='11' then 'Nov'
else  'Dec'
end as monthstring from t1 )
,t3 as 
(select r.projectId, r.name, r.timerange_timerange, workers, filter_key, training_type, num_female, num_male, num_18, num_29, num_39, num_49, num_50, num_permanent, num_contract, num_temporary, num_home, num_other_contract, num_migrant, num_foreign, num_local, num_age, num_begin, num_end, num_voluntarily, turnover, num_new, num_social, num_less_3, num_3_6, num_6_12, num_1_3, num_3_5, num_more_5, num_less_2, num_less_1, num_available, num_absenteeism, absenteeism_rate, factory,year, new_year, vendor, consultant, country, product_category, cycle, month as monthnum,  monthstring , monthstring   || '(' || new_year || ')' as month 
from t2 as r)

,t4 as
(
select p.projectId, p.name, p.timerange_timerange, workers, filter_key, training_type, num_female, num_male, num_18, num_29, num_39, num_49, num_50, num_permanent, num_contract, num_temporary, num_home, num_other_contract, num_migrant, num_foreign, num_local, num_age, num_begin, num_end, num_voluntarily, turnover, num_new, num_social, num_less_3, num_3_6, num_6_12, num_1_3, num_3_5, num_more_5, num_less_2, num_less_1, num_available, num_absenteeism, absenteeism_rate, factory, vendor, consultant, country, product_category, cycle, monthnum, new_year, monthstring, month from t3 as p
group by 

p.projectId, p.name, p.timerange_timerange, workers, filter_key, training_type, num_female, num_male, num_18, num_29, num_39, num_49, num_50, num_permanent, num_contract, num_temporary, num_home, num_other_contract, num_migrant, num_foreign, num_local, num_age, num_begin, num_end, num_voluntarily, turnover, num_new, num_social, num_less_3, num_3_6, num_6_12, num_1_3, num_3_5, num_more_5, num_less_2, num_less_1, num_available, num_absenteeism, absenteeism_rate, factory, vendor, consultant, country, product_category, cycle, monthnum, new_year, monthstring,month
)
select t.projectId,t.name,t.timerange_timerange,workeres,filter_key,training_key,num_female,num_male,num_18,num_29,num_39,num_49,num_50, num_permanent, num_contract, num_temporary, num_home, num_other_contract, num_migrant, num_foreign, num_local,num_age, num_begin, num_end, num_voluntarily, turnover, num_new, num_social, num_less_3, num_3_6, num_6_12, num_1_3, num_3_5, num_more_5, num_less_2, num_less_1, num_available, num_absenteeism, absenteeism_rate, factory, vendor, consultant, country, product_category, cycle, monthnum,new_year as year1,monthstring,month , p9.year
from t4 as t
left join profile_61528 as p9
on  year = p9._id