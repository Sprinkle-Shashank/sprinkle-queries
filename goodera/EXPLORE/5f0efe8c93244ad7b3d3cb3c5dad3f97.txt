with inter as (
select ANY_VALUE(region) as region, factory_id
from profile_60928
group by factory_id
),

sub1 as(
	select p1.name, p1.module_name, p1.fy_timerange, p2.pvh_id, p1.attendance,p3.region, extract(year from cast(fy_timerange.start as date)) as year
from profile_62486 p1
	left join profile_62948 p2 on p2.project_id = p1.project_id
	left join inter p3 on p2.pvh_id = p3.factory_id
    where year >= 2020 and p2.pvh_id is not NULL),
	
sub2 as(
  select module_name, fy_timerange, pvh_id, attendance, region
  from sub1 
  group by module_name, fy_timerange, pvh_id, attendance, region
),
	
sub3 as(
  select s2.*, country from sub2 s2, s2.region country)
  
select s3.fy_timerange, s3.pvh_id, t1.name as region, t2.name as program_type, s3.attendance, substring(t3.name,3, LEN(t3.name)-2) as module_name
	from sub3 s3
	left join ds_mysql_prod_tagelement t1 on t1.id = s3.country
    
	left join ds_mysql_prod_tagelement t3 on t3.id = s3.module_name
	left join ds_mysql_prod_tagelement t2 on t2.id=t3.parent
	group by s3.fy_timerange, t1.name, s3.pvh_id, s3.attendance, t2.name, t3.name