
with table1 as
( select p.projectid , p._id , fac.name as factory , cou.name as country , case when cou.name in ('India', 'Bangladesh', 'Sri Lanka')
then 'South Asia'
when cou.name in ('China')
then 'North Asia'
when cou.name in ('Guatemala', 'El Salvador', 'Dominican Republic')
then 'Americas'
when cou.name in ('Philippines', 'Cambodia',  'Vietnam',  'Indonesia', 'Myanmar')
then 'South East Asia'
end as region , case when nvl2(SUBSTRING(ven.name, 1, POSITION(' (' in ven.name)), SUBSTRING(ven.name, 1, POSITION(' (' in ven.name)), ven.name)='' then ven.name else nvl2(SUBSTRING(ven.name, 1, POSITION(' (' in ven.name)), SUBSTRING(ven.name, 1, POSITION(' (' in ven.name)), ven.name) end as vendor  , sta.name as status_new , case when status_new='Deactivated' then 'Deactivated' else 'ongoing' end as status_check ,  case when p1.sustainability_rating is null then p.sustainability_rating else p1.sustainability_rating end as score_start , case when p1.date is null then p.date else p1.date end as start_assemenet_date,  row_number() over 
(partition by p.projectid
 order by p._id desc) as row  from profile_31726 as p
	  
left join ds_mysql_prod_project fac
on p.projectid = fac.id
		  
left join ds_mysql_prod_project ven
on fac.parent = ven.id
		  
left join ds_mysql_prod_project cou
on ven.parent = cou.id
 
left join ds_mysql_prod_tagelement sta
on p.status = sta.id
 
left join profile_17526 p1 
 on p.projectid = p1.projectid 

where cou.name != 'Test Country'),

table2 as
( select p.projectid , p._id , sta.name as status_update from profile_16619 as p

left join ds_mysql_prod_tagelement sta
on p.status = sta.id),

table3 as
(
  select * from table1 where row=1 
),

table4 as
( select p.* , t2.status_update from table3 as p 
 
  left join table2 t2 
  on p.projectid = t2.projectid 
 
 where country != 'Test Country' and (t2.status_update = 'Completed' or t2.status_update is null)
 )

select * from table4