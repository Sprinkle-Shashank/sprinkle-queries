
with table1 as
(
  select pr_13.projectid , fac.name as factory_name , case when sourcing_yn = 57473 then pace_status_2 when sourcing_yn = 57472 then pr_67.pace_status end as pace_status ,  row_number() over 
(partition by factory_name --factory
 order by pr_13._id desc) as row1 
  from profile_52713 pr_13 
  
 left join ds_mysql_prod_project fac 
on pr_13.projectId = fac.id
  
left join profile_54267 pr_67 on 
pr_13.projectid = pr_67.projectid 
)

, table2 as 
(
  select pr_13.projectid , case when sourcing_yn = 57473 then null when sourcing_yn = 57472 then pr_67.facility_score end as sustain , row_number() over 
(partition by pr_67.facility_score --factory
 order by pr_13._id desc) as row2 from profile_52713 pr_13
  
left join profile_54267 pr_67 on 
pr_13.projectid = pr_67.projectid 
)

select 

cast(concat('FY ' ,pr_27.start_year) as varchar) as start_year ,
case when pr_27.start_quarter=1 then '1st (Feb-Apr)'
 when pr_27.start_quarter=2 then '2nd (May-Jul)'
  when pr_27.start_quarter=3 then '3rd (Aug-Oct)'
   when pr_27.start_quarter=4 then '4th (Nov-Jan)'
   else null end as start_quarter , pr_46.name_vendor_filter as  vendor , fac_filter.name as factory , pr_13._id , 
      
case when sourcing_yn=57472 then cast(factory_vpid_1 as varchar)
when sourcing_yn=57473 then cast(factory_vpid_2 as varchar) end as factory_id ,
   
tab1.pace_status, tab1.row1 , 

tab2.sustain , tab2.row2 ,

sum(pr_27.num_females) as women_enrolled ,
 
sum(pr_27.num_females_graduated) as women_graduated ,

 pr_27.start_date as recent_date 

from profile_52713 pr_13 

--- sum(pr_27.num_females) as women_enrolled ,
 
--- SUM(pr_27.num_females_graduated) as women_graduated ,

left join table1 tab1 on 
pr_13.projectid = tab1.projectid

left join table2 tab2 on 
pr_13.projectid = tab2.projectid

left join profile_4227 pr_27 on 
pr_13.projectid = pr_27.projectid

 left join ds_mysql_prod_project fac_filter
on pr_27.projectId = fac_filter.id

left join profile_54646  pr_46 on
pr_13.projectId = pr_46.projectId

group by start_year , start_quarter , vendor , factory , 
