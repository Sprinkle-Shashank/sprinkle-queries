with q as(select split_part(split_part(p1.name,'|',1),'.',1) as projectcode,
f.name as fy_timerange,p1.name_project, sum(p1.curr_yr_budget) as curr_yr_budget,
concat(projectcode,fy_timerange) as CODE,p7.name as ImplementingAgency,p8.name as interventiontype,p10.name as CoreArea , concat(concat(split_part(p1.start_date,' ',1),' to '), split_part(p1.end_date,' ',1)) as duration,m.name as project_manager, p1.state
from profile_27396 p1
left join ds_mysql_prod_tagelement f on
p1.fy=f.id
left join profile_27395 p7
on p7._id=p1.ngo_partner
left join profile_28235 p8
on p8._id=p1.intervention_type
left join ds_mysql_prod_tagelement p10
on p10.id=p1.focus_area
left join ds_mysql_prod_tagelement m on
p1.project_manager=m.id

	group by 1,2,3,5,6,7,8,9,10,11
union all
select split_part(split_part(split_part(p3.name,'|',1),'.',1),' ',1 ) as projectcode,
f.name as fy_timerange, p3.name_project,sum(p3.curr_yr_budget) as curr_yr_budget,
concat(projectcode,fy_timerange) as CODE,p3.ngo as ImplementingAgency,p3.int_type_calc2 as interventiontype,p3.focus_area as CoreArea ,
concat(concat(split_part(p3.start_date,' ',1),' to '), split_part(p3.end_date,' ',1)) as duration,m.name as project_manager,' 'as state
from profile_27420 p3
left join ds_mysql_prod_tagelement f on
p3.fy=f.id 
left join ds_mysql_prod_tagelement m on
p3.project_manager=m.id
group by 1,2,3,5,6,7,8,9,10,11), /*data req from 27396 and 27420*/

q1 as (select qq.projectcode,qq.fy_timerange,qq.name_project,qq.curr_yr_budget,qq.CODE,qq.ImplementingAgency,qq.interventiontype,qq.CoreArea , qq.duration,qq.project_manager, st from q as qq,qq.state as st),

tab1 as(select q1.*, s.name as state  from q1
 left join  ds_mysql_prod_tagelement s on
q1.st=s.id),
temp as(
  Select 'Q1' as col
  union all
    Select 'Q2' as col
  union all
    Select 'Q3' as col
  union all
    Select 'Q4' as col
),

s as(
select tab1.fy_timerange ,tab1.projectcode ,tab1.name_project, tab1.curr_yr_budget,
tab1.CODE,tab1.ImplementingAgency,tab1.interventiontype,tab1.CoreArea,tab1.duration,tab1.project_manager,tab1.state,
case when tab1.interventiontype in ('Direct', 'Indirect - Others') then tab1.curr_yr_budget 
 else 0 
  end as Totalallocatedamount from tab1 where tab1.interventiontype in ('Direct', 'Indirect - Others') ),
  
  
s2 as (
Select s.fy_timerange ,s.projectcode ,s.name_project, s.curr_yr_budget,
s.CODE,s.ImplementingAgency,s.interventiontype,s.CoreArea,s.duration,s.project_manager,temp.col as quarter,s.state,
sum(case col 
    when 'Q1' then s.Totalallocatedamount/4
    when 'Q2' then s.Totalallocatedamount/4
    when 'Q3' then s.Totalallocatedamount/4
    when 'Q4' then s.Totalallocatedamount/4
   else 0
    end) as AllocatedAmount
from s
cross join temp
group by s.fy_timerange ,s.projectcode ,s.name_project, s.curr_yr_budget,s.state,
s.CODE,s.ImplementingAgency,s.interventiontype,s.CoreArea,s.duration,s.project_manager ,temp.col
)

Select * from s2