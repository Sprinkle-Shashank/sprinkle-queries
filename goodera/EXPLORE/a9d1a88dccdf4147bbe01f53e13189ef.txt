tab3 as (
  select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,t.name as fy_timerange,concat(projectcode,fy_timerange) as CODE,sum(case when p.monthly_cost is null then 0 else p.monthly_cost  end) as monthly_cost ,
		 case when t1.name in('April', 'May', 'June') then 'quarter1'
		  when t1.name in('July','August','September') then 'quarter2'
		  when t1.name in('October','November','December') then 'quarter3'
		  when t1.name in('January','February','March') then 'quarter4' end as quarters
		 from profile_30171 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement t
on p.fy=t.id
left join ds_mysql_prod_tagelement t1
on p.month=t1.id

group by 1,2,3,5),/*data required from 30171*/


tab2 as (select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,t.name as fy_timerange,concat(projectcode,fy_timerange) as CODE, split_part(prod.name,'|',3) as censuscode,
q.state,q.district,sum(case when p.hdfc_cost_monthly is null then 0 else p.hdfc_cost_monthly end) as hdfc_cost_monthly ,
		 case when t1.name in('April', 'May', 'June') then 'quarter1'
		 when t1.name in('July','August','September') then 'quarter2'
		 when t1.name in('October','November','December') then 'quarter3'
		 when t1.name in('January','February','March') then 'quarter4' end  as quarters
		 from profile_29974 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement t
on p.fy=t.id
 left join profile_27489 q on
split_part(prod.name,'|',3)=q.name
left join ds_mysql_prod_tagelement t1
on p.month=t1.id
/*left join ds_mysql_prod_tagelement t1
on p.month_number=t1.id
left join ds_mysql_prod_tagelement t2
on t1.parent=t2.id*/
group by 1,2,3,4,5,6,8/*data required from 29974*/
 )
 
 select tab1.fy_timerange ,tab1.projectcode ,tab1.name_project, tab2.quarters,
tab1.CODE,tab1.ImplementingAgency,tab1.interventiontype,tab1.CoreArea,tab1.duration,
  tab1.project_manager,case when tab1.interventiontype in ('Indirect') then tab2.hdfc_cost_monthly+tab3.monthly_cost
else 0
    end as allocatedamount
	from tab1
left join tab2 on tab2.CODE=tab1.CODE
left join tab3 on tab3.CODE=tab2.CODE and tab3.quarters=tab2.quarters
	  where tab1.interventiontype in ('Indirect') 