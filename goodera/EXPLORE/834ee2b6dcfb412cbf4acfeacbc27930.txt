with sub1 as(
  select p1.*, to_char(cast(p1.start_date as date),'DD/MM/YYYY') as start_date_new,
to_char(cast(p1.end_date as date),'DD/MM/YYYY') as end_date_new, 
to_char(cast(p1.mou_date as date),'DD/MM/YYYY') as mou_date_new, 
(p1.start_date || '|' || p1.end_date) as fy_timerange,
  case
  		when is_array(p1.sdgs) = false or get_array_length(p1.sdgs) = 0 then array(p1.sdgs)
  		else p1.sdgs
  end as sdgs_new,
  case
  		when is_array(p1.schedule_7) = false or get_array_length(p1.schedule_7) = 0 then array(p1.schedule_7)
  		else p1.schedule_7
  end as schedule_7_new,
  case
  		when is_array(p1.sdgs_photo) = false or get_array_length(p1.sdgs_photo) = 0 then array(p1.sdgs_photo)
  		else p1.sdgs_photo
  end as sdgs_photo_new
  from profile_73154 p1),

sub2 as(
  select s1.*, sdgs_unwind, schedule_7_unwind, cast(sdgs_photo_unwind as varchar)
from sub1 s1, s1.sdgs_new sdgs_unwind, s1.schedule_7_new schedule_7_unwind, s1.sdgs_photo_new sdgs_photo_unwind),

sub3 as(
  select p3.name as partner, p2.name as projectid, s2.description, s2.start_date_new as start_date, s2.end_date_new as end_date, t1.name as theme, t2.name as projects, t3.name as proj_partner, t4.name as sdgs, t5.name as schedule_7, s2.mou_date_new as mou_date, s2.sdgs_photo_unwind as sdgs_photo, p1.duration, p1.logo
from sub2 s2
left join ds_mysql_prod_project p2 on p2.id = s2.projectid
left join ds_mysql_prod_project p3 on p3.id = s2.parent
left join ds_mysql_prod_tagelement t1 on t1.id = s2.theme
left join ds_mysql_prod_tagelement t2 on t2.id = s2.projects
left join ds_mysql_prod_tagelement t3 on t3.id = s2.partner
left join ds_mysql_prod_tagelement t4 on t4.id = s2.sdgs_unwind
left join ds_mysql_prod_tagelement t5 on t5.id = s2.schedule_7_unwind
left join ds_mysql_prod_tagelement t6 on t6.id = s2.partner)

select * from sub3
