
with table1 as
(
  select p.projectid , pace.name as pace_status , facility_score , row_number() over 
(partition by  p.projectid
 order by p._id desc) as row from profile_54267 as p
  
left join ds_mysql_prod_tagelement pace
on p.pace_status = pace.id
)

, table2 as
(
 select * from table1 where row=1
)


select p.projectid ,  fac.name as factory_name ,     

case when sourcing_yn=57472 then cast(factory_vpid_1 as varchar)
when sourcing_yn=57473 then cast(factory_vpid_2 as varchar) end as factory_id , 

case when sourcing_yn = 57473 then pace_2.name when sourcing_yn = 57472 then tab2.pace_status end as update_pace_status , 

case when sourcing_yn = 57472 then tab2.facility_score else null end as sustain , 

sum(batch.num_females) as women_enrolled ,

sum(batch.num_females_graduated) as women_graduated , 

cast(batch.name as varchar) as update_name , position(' Batch' in update_name) as index_value , right(batch.name , (len(batch.name) - index_value)) as recent_batch

from profile_52713 as p

left join ds_mysql_prod_project fac
on p.projectid = fac.id

left join ds_mysql_prod_tagelement pace_2
on p.pace_status_2 = pace_2.id

left join table2 tab2 on
p.projectid = tab2.projectid

left join profile_4227 batch on 
p.projectid = batch.projectid

group by p.projectid , fac.name , factory_id , update_pace_status , sustain  
