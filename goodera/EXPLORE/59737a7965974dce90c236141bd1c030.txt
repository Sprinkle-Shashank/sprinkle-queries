with temp1 as
(select m._id as old_id, projectId.name as projectId, indicator_1.name as indicator, sdgs.name as sdgs, schedule_vii.name as schedule_vii, proj, project_name, ben_type.name as ben_type, baseline, target, name, r._id as project_code_new, project_name, vertical, focus.name as focus, direct_or_partner, project_code, state_1.name as state, partner.name as partner, fy_timerange, progress

 from profile_61044 as m
 
 left join profile_62881 AS r 
 on m.proj = r._id
 
  left join profile_61046 AS q 
 on m._id = q.indicator
 
 left join ds_mysql_prod_tagelement as partner
  on r.direct_or_partner = partner.id
 
 left join ds_mysql_prod_tagelement as ben_type
  on m.ben_type = ben_type.id
 
 left join ds_mysql_prod_tagelement as indicator_1
  on m.indicator = indicator_1.id 
 
 left join ds_mysql_prod_tagelement as int_indi
  on indicator_1.parent = int_indi.id
 
 left join ds_mysql_prod_tagelement as projectId
  on m.projectId = projectId.id 
 
 left join ds_mysql_prod_tagelement as schedule_vii
  on m.schedule_vii = schedule_vii.id 
 
 left join ds_mysql_prod_tagelement as focus
  on r.focus = focus.id 
 
 left join ds_mysql_prod_tagelement as entity
  on r.entity = entity.id 
 
 left join ds_mysql_prod_tagelement as state_1
  on r.state = state_1.id 
 
 left join ds_mysql_prod_tagelement as sdgs
  on m.sdgs = sdgs.id
 
where r.direct_or_partner = 1132991 AND m.ben_type = 939857  AND m.sdgs IS NOT NULL AND q.fy_timerange IS NOT NULL),

temp 2 as
(select _id, old_id, projectId, indicator, sdgs, schedule_vii, proj, project_name, ben_type, baseline, target, name, project_code_new, project_name, vertical, focus, direct_or_partner, project_code, state, partner, fy_timerange, progress, name
 
 from temp1 as m 
 
  left join profile_64961 AS r 
 on m.state = r.state),
 
temp3 as
(select _id, projectId, indicator, schedule_vii, proj, project_name, project_code_new, focus, project_code, fy_timerange, progress, state, vertical, sdgs, entity, vertical_new 
 from temp2 as m, m.vertical vertical_new),
 
 temp4 as
 (select _id, projectId, indicator, schedule_vii, proj, project_name, project_code_new, focus, project_code, fy_timerange, progress, state, sdgs, entity,
  
  case 
when vert1.name IS NULL AND vert.name IS NOT NULL THEN vert.name
when vert1.name IS NULL AND vert.name IS NULL then 'Admin'
else vert1.name 
END AS vertical

from temp3 AS m

left join ds_mysql_prod_tagelement as vert
  on m.vertical_new = vert.id
  
left join ds_mysql_prod_tagelement as vert1
  on vert.parent = vert1.id),
  
temp5 as
(select projectId, indicator, schedule_vii, proj, project_name, project_code_new, focus, project_code, fy_timerange, SUM(m.progress) as beneficiary, state, vertical sdgs, entity
 from temp2 as m
   where _id NOT IN (select _id from temp3)
group by projectId, indicator, schedule_vii, proj, project_name, project_code_new, focus, project_code, fy_timerange, state, vertical, sdgs, entity)

select projectId, indicator, schedule_vii, proj, project_name, project_code_new, focus, project_code, fy_timerange, SUM(m.progress) as beneficiary, state, vertical, sdgs, entity
from temp4 as m
group by projectId, indicator, schedule_vii, proj, project_name, project_code_new, focus, project_code, fy_timerange, state, vertical, sdgs, entity

UNION ALL
select projectId, indicator, schedule_vii, proj, project_name, project_code_new, focus, project_code, fy_timerange, beneficiary, state, vertical, sdgs, entity
from temp5 as m