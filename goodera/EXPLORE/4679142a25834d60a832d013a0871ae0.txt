with tab1 as(select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,t.name as fy_timerange,t2.name as Quarter,concat(projectcode,fy_timerange) as CODE,split_part(prod.name,'|',3) as censuscode,sum(p.hdfc_cost_monthly) as hdfc_cost from profile_29974 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement t
on p.fy=t.id
left join ds_mysql_prod_tagelement t1
on p.month_number=t1.id
left join ds_mysql_prod_tagelement t2
on t1.parent=t2.id
group by 1,2,3,4,5),
tab2 as(select split_part(split_part(prod.name,'|',1),'.',1) as projectcode,t.name as fy_timerange,t2.name as Quarter,concat(projectcode,fy_timerange) as CODE,sum(p.monthly_cost) as monthlycost  from profile_30171 p
left join ds_mysql_prod_project prod on
prod.id=p.projectid
left join ds_mysql_prod_tagelement t
on p.fy=t.id
left join ds_mysql_prod_tagelement t1
on p.month_number=t1.id
left join ds_mysql_prod_tagelement t2
on t1.parent=t2.id
group by 1,2,3,4),

tab3 as(select t.projectcode,t.fy_timerange,t.Quarter,t.hdfc_cost a,t1.monthlycost b,(a+b) total,t.CODE from tab1 t
left join tab2 t1 on
t.CODE=t1.CODE),

tab4 as(select t5.name as fy_timerange,(t.name) as response,case when response='Yes' then split_part(t2.name,'[',1) else t3.name end as projectcode,case when response='Yes' then m.name else n.name end as project_manager,case when p.amnt_utlzd is null then 0 else p.amnt_utlzd  end as Amount_utilised,case when p.payment_amount is null then 0 else p.payment_amount  end as Amount_Disbursed,concat(projectcode,fy_timerange) as CODE from profile_27398 p
left join ds_mysql_prod_tagelement t
on p.renewal=t.id
left join profile_27396 t3 on
p.project_name=t3._id
left join profile_27420 t2 on
p.project_renew=t2._id
left join ds_mysql_prod_tagelement n on
t3.project_manager=n.id
left join ds_mysql_prod_tagelement m on
t2.project_manager=m.id
left join ds_mysql_prod_tagelement t4
on p.tranche=t4.id
left join ds_mysql_prod_tagelement t5
on p.fy=t5.id),

tab5 as(select p.name as projectcode,f.name as fy_timerange,concat(projectcode,fy_timerange) as CODE,m.name  as project_manager from profile_27396 p
left join ds_mysql_prod_tagelement m on
p.project_manager=m.id
left join ds_mysql_prod_tagelement f on
p.fy=f.id
union
select l.name as projectcode,f.name as fy_timerange,concat(projectcode,fy_timerange) as CODE,m.name as project_manager
from profile_27420 p
left join profile_27396 l on
p.project_code=l._id
left join ds_mysql_prod_tagelement m on
p.project_manager=m.id
left join ds_mysql_prod_tagelement f on
p.fy=f.id),

tab6 as(select t.fy_timerange,t2.projectcode,t2.project_manager,t.Amount_Disbursed,t.Amount_utilised,t.CODE from tab4 t
left join tab5 t2 on
t.CODE=t2.CODE),

Base3 as(select l.village as village, p.fy_timerange,p.project_manager,p.projectcode ,p.Quarter,p.total,p.CODE
from tab3 p 
left join profile_27489 l 
on p.censuscode=l.name
group by fy_timerange,Project_Manager,ProjectCode,village), 
select t.fy_timerange,t.projectcode,t.project_manager,t.Amount_Disbursed,t.Amount_utilised,t1.Quarter,t1.total as Allocated_Amount,(t.Amount_Disbursed-t.Amount_utilised) Balance_amount from tab6 t
left join Base3 t1 on
t.CODE=t1.CODE



